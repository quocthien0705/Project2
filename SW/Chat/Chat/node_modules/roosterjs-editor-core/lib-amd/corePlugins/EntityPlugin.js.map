{"version":3,"file":"EntityPlugin.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-core/lib/corePlugins/EntityPlugin.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n    inlineEntityOnPluginEvent,\n    normalizeDelimitersInEditor,\n} from './utils/inlineEntityOnPluginEvent';\nimport {\n    Browser,\n    commitEntity,\n    getEntityFromElement,\n    getEntitySelector,\n    isCharacterValue,\n    toArray,\n    arrayPush,\n    createElement,\n    addRangeToSelection,\n    createRange,\n    isBlockElement,\n    getObjectKeys,\n} from 'roosterjs-editor-dom';\nimport type {\n    ContentChangedEvent,\n    Entity,\n    EntityOperationEvent,\n    EntityPluginState,\n    KnownEntityItem,\n    HtmlSanitizerOptions,\n    IEditor,\n    PluginEvent,\n    PluginMouseUpEvent,\n    PluginWithState,\n} from 'roosterjs-editor-types';\nimport {\n    ChangeSource,\n    ContentPosition,\n    EntityClasses,\n    EntityOperation,\n    Keys,\n    PluginEventType,\n    QueryScope,\n} from 'roosterjs-editor-types';\nimport type { CompatibleEntityOperation } from 'roosterjs-editor-types/lib/compatibleTypes';\n\nconst ENTITY_ID_REGEX = /_(\\d{1,8})$/;\n\nconst ENTITY_CSS_REGEX = '^' + EntityClasses.ENTITY_INFO_NAME + '$';\nconst ENTITY_ID_CSS_REGEX = '^' + EntityClasses.ENTITY_ID_PREFIX;\nconst ENTITY_TYPE_CSS_REGEX = '^' + EntityClasses.ENTITY_TYPE_PREFIX;\nconst ENTITY_READONLY_CSS_REGEX = '^' + EntityClasses.ENTITY_READONLY_PREFIX;\nconst ALLOWED_CSS_CLASSES = [\n    ENTITY_CSS_REGEX,\n    ENTITY_ID_CSS_REGEX,\n    ENTITY_TYPE_CSS_REGEX,\n    ENTITY_READONLY_CSS_REGEX,\n];\nconst REMOVE_ENTITY_OPERATIONS: (EntityOperation | CompatibleEntityOperation)[] = [\n    EntityOperation.Overwrite,\n    EntityOperation.PartialOverwrite,\n    EntityOperation.RemoveFromStart,\n    EntityOperation.RemoveFromEnd,\n];\n\n/**\n * @internal\n * Entity Plugin helps handle all operations related to an entity and generate entity specified events\n */\nexport default class EntityPlugin implements PluginWithState<EntityPluginState> {\n    private editor: IEditor | null = null;\n    private state: EntityPluginState;\n\n    /**\n     * Construct a new instance of EntityPlugin\n     */\n    constructor() {\n        this.state = {\n            entityMap: {},\n        };\n    }\n\n    /**\n     * Get a friendly name of  this plugin\n     */\n    getName() {\n        return 'Entity';\n    }\n\n    /**\n     * Initialize this plugin. This should only be called from Editor\n     * @param editor Editor instance\n     */\n    initialize(editor: IEditor) {\n        this.editor = editor;\n    }\n\n    /**\n     * Dispose this plugin\n     */\n    dispose() {\n        this.editor = null;\n        this.state.entityMap = {};\n    }\n\n    /**\n     * Get plugin state object\n     */\n    getState() {\n        return this.state;\n    }\n\n    /**\n     * Handle events triggered from editor\n     * @param event PluginEvent object\n     */\n    onPluginEvent(event: PluginEvent) {\n        switch (event.eventType) {\n            case PluginEventType.MouseUp:\n                this.handleMouseUpEvent(event);\n                break;\n            case PluginEventType.KeyDown:\n                this.handleKeyDownEvent(event.rawEvent);\n                break;\n            case PluginEventType.BeforeCutCopy:\n                if (event.isCut) {\n                    this.handleCutEvent(event.rawEvent);\n                }\n                break;\n            case PluginEventType.BeforePaste:\n                this.handleBeforePasteEvent(event.sanitizingOption);\n                break;\n            case PluginEventType.ContentChanged:\n                this.handleContentChangedEvent(event);\n                break;\n            case PluginEventType.EditorReady:\n                this.handleContentChangedEvent();\n                break;\n            case PluginEventType.ExtractContentWithDom:\n                this.handleExtractContentWithDomEvent(event.clonedRoot);\n                break;\n            case PluginEventType.ContextMenu:\n                this.handleContextMenuEvent(event.rawEvent);\n                break;\n            case PluginEventType.EntityOperation:\n                this.handleEntityOperationEvent(event);\n                break;\n        }\n\n        if (this.editor) {\n            inlineEntityOnPluginEvent(event, this.editor);\n        }\n    }\n\n    private handleContextMenuEvent(event: UIEvent) {\n        const node = event.target as Node;\n        const entityElement = node && this.editor?.getElementAtCursor(getEntitySelector(), node);\n\n        if (entityElement) {\n            event.preventDefault();\n            this.triggerEvent(entityElement, EntityOperation.ContextMenu, event);\n        }\n    }\n\n    private handleCutEvent = (event: ClipboardEvent) => {\n        const range = this.editor?.getSelectionRange();\n        if (range && !range.collapsed) {\n            this.checkRemoveEntityForRange(event);\n        }\n    };\n\n    private handleMouseUpEvent(event: PluginMouseUpEvent) {\n        const { rawEvent, isClicking } = event;\n        const node = rawEvent.target as Node;\n        let entityElement: HTMLElement | null;\n\n        if (\n            this.editor &&\n            isClicking &&\n            node &&\n            !!(entityElement = this.editor.getElementAtCursor(getEntitySelector(), node))\n        ) {\n            this.triggerEvent(entityElement, EntityOperation.Click, rawEvent);\n\n            workaroundSelectionIssueForIE(this.editor);\n        }\n    }\n\n    private handleKeyDownEvent(event: KeyboardEvent) {\n        if (\n            isCharacterValue(event) ||\n            event.which == Keys.BACKSPACE ||\n            event.which == Keys.DELETE ||\n            event.which == Keys.ENTER\n        ) {\n            const range = this.editor?.getSelectionRange();\n            if (range && !range.collapsed) {\n                this.checkRemoveEntityForRange(event);\n            }\n        }\n    }\n\n    private handleBeforePasteEvent(sanitizingOption: HtmlSanitizerOptions) {\n        const range = this.editor?.getSelectionRange();\n\n        if (range && !range.collapsed) {\n            this.checkRemoveEntityForRange(null! /*rawEvent*/);\n        }\n\n        if (sanitizingOption.additionalAllowedCssClasses) {\n            arrayPush(sanitizingOption.additionalAllowedCssClasses, ALLOWED_CSS_CLASSES);\n        }\n    }\n\n    private handleContentChangedEvent(event?: ContentChangedEvent) {\n        let shouldNormalizeDelimiters: boolean = false;\n        // 1. find removed entities\n        getObjectKeys(this.state.entityMap).forEach(id => {\n            const item = this.state.entityMap[id];\n            const element = item.element;\n\n            if (this.editor && !item.isDeleted && !this.editor.contains(element)) {\n                item.isDeleted = true;\n\n                this.triggerEvent(element, EntityOperation.Overwrite);\n\n                if (\n                    !shouldNormalizeDelimiters &&\n                    !element.isContentEditable &&\n                    !isBlockElement(element)\n                ) {\n                    shouldNormalizeDelimiters = true;\n                }\n            }\n        });\n\n        // 2. collect all new entities\n        const newEntities =\n            event?.source == ChangeSource.InsertEntity && event.data\n                ? [event.data as Entity]\n                : this.getExistingEntities().filter(entity => {\n                      const item = this.state.entityMap[entity.id];\n\n                      return !item || item.element != entity.wrapper || item.isDeleted;\n                  });\n\n        // 3. Add new entities to known entity list, and hydrate\n        newEntities.forEach(entity => {\n            const { wrapper, type, id, isReadonly } = entity;\n\n            entity.id = this.ensureUniqueId(type, id, wrapper);\n            commitEntity(wrapper, type, isReadonly, entity.id); // Use entity.id here because it is newly updated\n            this.handleNewEntity(entity);\n        });\n\n        if (shouldNormalizeDelimiters && this.editor) {\n            normalizeDelimitersInEditor(this.editor);\n        }\n    }\n\n    private handleEntityOperationEvent(event: EntityOperationEvent) {\n        if (this.editor && REMOVE_ENTITY_OPERATIONS.indexOf(event.operation) >= 0) {\n            const item = this.state.entityMap[event.entity.id];\n\n            if (item) {\n                item.isDeleted = true;\n            }\n        }\n    }\n\n    private handleExtractContentWithDomEvent(root: HTMLElement) {\n        toArray(root.querySelectorAll(getEntitySelector())).forEach(element => {\n            element.removeAttribute('contentEditable');\n\n            this.triggerEvent(element as HTMLElement, EntityOperation.ReplaceTemporaryContent);\n        });\n    }\n\n    private checkRemoveEntityForRange(event: Event) {\n        const editableEntityElements: HTMLElement[] = [];\n        const selector = getEntitySelector();\n        this.editor?.queryElements(selector, QueryScope.OnSelection, element => {\n            if (element.isContentEditable) {\n                editableEntityElements.push(element);\n            } else {\n                this.triggerEvent(element, EntityOperation.Overwrite, event);\n            }\n        });\n\n        // For editable entities, we need to check if it is fully or partially covered by current selection,\n        // and trigger different events;\n        if (this.editor && editableEntityElements.length > 0) {\n            const inSelectionEntityElements = this.editor.queryElements(\n                selector,\n                QueryScope.InSelection\n            );\n            editableEntityElements.forEach(element => {\n                const isFullyCovered = inSelectionEntityElements.indexOf(element) >= 0;\n                this.triggerEvent(\n                    element,\n                    isFullyCovered ? EntityOperation.Overwrite : EntityOperation.PartialOverwrite,\n                    event\n                );\n            });\n        }\n    }\n\n    private triggerEvent(element: HTMLElement, operation: EntityOperation, rawEvent?: Event) {\n        const entity = element && getEntityFromElement(element);\n\n        return entity\n            ? this.editor?.triggerPluginEvent(PluginEventType.EntityOperation, {\n                  operation,\n                  rawEvent,\n                  entity,\n              })\n            : null;\n    }\n\n    private handleNewEntity(entity: Entity) {\n        const { wrapper } = entity;\n        const event = this.triggerEvent(wrapper, EntityOperation.NewEntity);\n\n        const newItem: KnownEntityItem = {\n            element: entity.wrapper,\n        };\n\n        if (event?.shouldPersist) {\n            newItem.canPersist = true;\n        }\n\n        this.state.entityMap[entity.id] = newItem;\n    }\n\n    private getExistingEntities(): Entity[] {\n        return (\n            this.editor\n                ?.queryElements(getEntitySelector())\n                .map(getEntityFromElement)\n                .filter((x): x is Entity => !!x) ?? []\n        );\n    }\n\n    private ensureUniqueId(type: string, id: string, wrapper: HTMLElement) {\n        const match = ENTITY_ID_REGEX.exec(id);\n        const baseId = (match ? id.substr(0, id.length - match[0].length) : id) || type;\n\n        // Make sure entity id is unique\n        let newId = '';\n\n        for (let num = (match && parseInt(match[1])) || 0; ; num++) {\n            newId = num > 0 ? `${baseId}_${num}` : baseId;\n\n            const item = this.state.entityMap[newId];\n\n            if (!item || item.element == wrapper) {\n                break;\n            }\n        }\n\n        return newId;\n    }\n}\n\n/**\n * IE will show a resize border around the readonly content within content editable DIV\n * This is a workaround to remove it by temporarily move focus out of editor\n */\nconst workaroundSelectionIssueForIE = Browser.isIE\n    ? (editor: IEditor) => {\n          editor.runAsync(editor => {\n              const workaroundButton = editor.getCustomData('ENTITY_IE_FOCUS_BUTTON', () => {\n                  const button = createElement(\n                      {\n                          tag: 'button',\n                          style: 'overflow:hidden;position:fixed;width:0;height:0;top:-1000px',\n                      },\n                      editor.getDocument()\n                  ) as HTMLElement;\n                  button.onblur = () => {\n                      button.style.display = 'none';\n                  };\n\n                  editor.insertNode(button, {\n                      position: ContentPosition.Outside,\n                  });\n\n                  return button;\n              });\n\n              workaroundButton.style.display = '';\n              addRangeToSelection(createRange(workaroundButton, 0));\n          });\n      }\n    : () => {};\n"]}