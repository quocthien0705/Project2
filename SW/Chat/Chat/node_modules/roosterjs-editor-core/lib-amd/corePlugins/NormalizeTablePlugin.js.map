{"version":3,"file":"NormalizeTablePlugin.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-core/lib/corePlugins/NormalizeTablePlugin.ts"],"names":[],"mappings":"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","sourcesContent":["import { PluginEventType, SelectionRangeTypes } from 'roosterjs-editor-types';\nimport {\n    changeElementTag,\n    getTagOfNode,\n    moveChildNodes,\n    safeInstanceOf,\n    toArray,\n} from 'roosterjs-editor-dom';\nimport type { EditorPlugin, IEditor, PluginEvent } from 'roosterjs-editor-types';\n\n/**\n * @internal\n * TODO: Rename this plugin since it is not only for table now\n *\n * NormalizeTable plugin makes sure each table in editor has TBODY/THEAD/TFOOT tag around TR tags\n *\n * When we retrieve HTML content using innerHTML, browser will always add TBODY around TR nodes if there is not.\n * This causes some issue when we restore the HTML content with selection path since the selection path is\n * deeply coupled with DOM structure. So we need to always make sure there is already TBODY tag whenever\n * new table is inserted, to make sure the selection path we created is correct.\n */\nexport default class NormalizeTablePlugin implements EditorPlugin {\n    private editor: IEditor | null = null;\n\n    /**\n     * Get a friendly name of this plugin\n     */\n    getName() {\n        return 'NormalizeTable';\n    }\n\n    /**\n     * The first method that editor will call to a plugin when editor is initializing.\n     * It will pass in the editor instance, plugin should take this chance to save the\n     * editor reference so that it can call to any editor method or format API later.\n     * @param editor The editor object\n     */\n    initialize(editor: IEditor) {\n        this.editor = editor;\n    }\n\n    /**\n     * The last method that editor will call to a plugin before it is disposed.\n     * Plugin can take this chance to clear the reference to editor. After this method is\n     * called, plugin should not call to any editor method since it will result in error.\n     */\n    dispose() {\n        this.editor = null;\n    }\n\n    /**\n     * Core method for a plugin. Once an event happens in editor, editor will call this\n     * method of each plugin to handle the event as long as the event is not handled\n     * exclusively by another plugin.\n     * @param event The event to handle:\n     */\n    onPluginEvent(event: PluginEvent) {\n        switch (event.eventType) {\n            case PluginEventType.EditorReady:\n            case PluginEventType.ContentChanged:\n                if (this.editor) {\n                    this.normalizeTables(this.editor.queryElements('table'));\n                }\n                break;\n\n            case PluginEventType.BeforePaste:\n                this.normalizeTables(toArray(event.fragment.querySelectorAll('table')));\n                break;\n\n            case PluginEventType.MouseDown:\n                this.normalizeTableFromEvent(event.rawEvent);\n                break;\n\n            case PluginEventType.KeyDown:\n                if (event.rawEvent.shiftKey) {\n                    this.normalizeTableFromEvent(event.rawEvent);\n                }\n                break;\n\n            case PluginEventType.ExtractContentWithDom:\n                normalizeListsForExport(event.clonedRoot);\n                break;\n        }\n    }\n\n    private normalizeTableFromEvent(event: KeyboardEvent | MouseEvent) {\n        const table = this.editor?.getElementAtCursor('table', event.target as Node);\n\n        if (table) {\n            this.normalizeTables([<HTMLTableElement>table]);\n        }\n    }\n\n    private normalizeTables(tables: HTMLTableElement[]) {\n        if (this.editor && tables.length > 0) {\n            const rangeEx = this.editor.getSelectionRangeEx();\n            const { startContainer, endContainer, startOffset, endOffset } =\n                (rangeEx?.type == SelectionRangeTypes.Normal && rangeEx.ranges[0]) || {};\n\n            const isChanged = normalizeTables(tables);\n\n            if (isChanged) {\n                if (\n                    startContainer &&\n                    endContainer &&\n                    typeof startOffset === 'number' &&\n                    typeof endOffset === 'number'\n                ) {\n                    this.editor.select(startContainer, startOffset, endContainer, endOffset);\n                } else if (\n                    rangeEx?.type == SelectionRangeTypes.TableSelection &&\n                    rangeEx.coordinates\n                ) {\n                    this.editor.select(rangeEx.table, rangeEx.coordinates);\n                }\n            }\n        }\n    }\n}\n\nfunction normalizeTables(tables: HTMLTableElement[]) {\n    let isDOMChanged = false;\n    tables.forEach(table => {\n        let tbody: HTMLTableSectionElement | null = null;\n\n        for (let child = table.firstChild; child; child = child.nextSibling) {\n            const tag = getTagOfNode(child);\n            switch (tag) {\n                case 'TR':\n                    if (!tbody) {\n                        tbody = table.ownerDocument.createElement('tbody');\n                        table.insertBefore(tbody, child);\n                    }\n\n                    tbody.appendChild(child);\n                    child = tbody;\n                    isDOMChanged = true;\n\n                    break;\n                case 'TBODY':\n                    if (tbody) {\n                        moveChildNodes(tbody, child, true /*keepExistingChildren*/);\n                        child.parentNode?.removeChild(child);\n                        child = tbody;\n                        isDOMChanged = true;\n                    } else {\n                        tbody = child as HTMLTableSectionElement;\n                    }\n                    break;\n                default:\n                    tbody = null;\n                    break;\n            }\n        }\n\n        const colgroups = table.querySelectorAll('colgroup');\n        const thead = table.querySelector('thead');\n        if (thead) {\n            colgroups.forEach(colgroup => {\n                if (!thead.contains(colgroup)) {\n                    thead.appendChild(colgroup);\n                }\n            });\n        }\n    });\n\n    return isDOMChanged;\n}\n\nfunction normalizeListsForExport(root: ParentNode) {\n    toArray(root.querySelectorAll('li')).forEach(li => {\n        const prevElement = li.previousSibling;\n\n        if (li.style.display == 'block' && safeInstanceOf(prevElement, 'HTMLLIElement')) {\n            li.style.removeProperty('display');\n\n            prevElement.appendChild(changeElementTag(li, 'div'));\n        }\n    });\n}\n"]}