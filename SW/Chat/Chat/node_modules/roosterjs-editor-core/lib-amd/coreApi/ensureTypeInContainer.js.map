{"version":3,"file":"ensureTypeInContainer.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-core/lib/coreApi/ensureTypeInContainer.ts"],"names":[],"mappings":";;;;IAaA;;;;OAIG;IACI,IAAM,qBAAqB,GAA0B,UACxD,IAAgB,EAChB,QAAsB,EACtB,aAA6B;QAE7B,IAAM,KAAK,GAAG,IAAA,iDAA0B,EAAC,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;QAClF,IAAI,EAAsB,CAAC;QAE3B,IAAI,KAAK,IAAI,CAAC,EAAE,GAAG,KAAK,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC,EAAE;YAC9C,QAAQ,GAAG,IAAI,+BAAQ,CAAC,EAAE,gBAAqB,CAAC;SACnD;QACD,QAAQ,GAAG,QAAQ,CAAC,SAAS,EAAE,CAAC;QAEhC,IAAM,KAAK,GAAG,IAAA,4CAAqB,EAAC,IAAI,CAAC,UAAU,EAAE,QAAQ,CAAC,IAAI,CAAC,CAAC;QACpE,IAAI,UAA8B,CAAC;QAEnC,IAAI,KAAK,EAAE;YACP,UAAU,GAAG,KAAK,CAAC,uBAAuB,EAAE,CAAC;YAC7C,IAAI,IAAA,kCAAW,EAAC,UAAU,EAAE,KAAK,CAAC,iBAAiB,EAAE,IAAI,CAAC,4BAA4B,CAAC,EAAE;gBACrF,IAAM,IAAI,GAAG,UAAU,CAAC,aAAa,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;gBAC1D,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;aAC3B;YACD,8CAA8C;YAC9C,sFAAsF;YACtF,uFAAuF;YACvF,IAAM,mBAAmB,GACrB,IAAA,kCAAW,EAAC,UAAU,CAAC;gBACvB,CAAC,aAAa,IAAI,iCAAiC,CAAC,aAAa,EAAE,UAAU,CAAC,CAAC,CAAC;YACpF,UAAU,GAAG,UAAU,IAAI,mBAAmB,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC;SACtE;aAAM;YACH,oFAAoF;YACpF,gHAAgH;YAChH,8EAA8E;YAC9E,UAAU,GAAG,IAAA,oCAAa,qBAEtB,IAAI,CAAC,UAAU,CAAC,aAAa,CACjB,CAAC;YACjB,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,IAAI,EAAE,UAAU,EAAE;gBAClC,QAAQ,aAAqB;gBAC7B,YAAY,EAAE,KAAK;gBACnB,gBAAgB,EAAE,KAAK;gBACvB,eAAe,EAAE,KAAK;aACzB,CAAC,CAAC;YAEH,0GAA0G;YAC1G,QAAQ,GAAG,IAAI,+BAAQ,CAAC,UAAU,gBAAqB,CAAC;SAC3D;QAED,IAAI,UAAU,IAAI,IAAI,CAAC,SAAS,CAAC,aAAa,EAAE;YAC5C,IAAA,kCAAW,EACP,UAAU,EACV,IAAI,CAAC,SAAS,CAAC,aAAa,EAC5B,IAAI,CAAC,SAAS,CAAC,UAAU,EACzB,IAAI,CAAC,gBAAgB,CACxB,CAAC;SACL;QAED,0EAA0E;QAC1E,IAAI,aAAa,EAAE;YACf,IAAI,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,EAAE,IAAA,kCAAW,EAAC,IAAI,+BAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;SACnE;IACL,CAAC,CAAC;IA7DW,QAAA,qBAAqB,yBA6DhC;IAEF,SAAS,iCAAiC,CAAC,KAAoB,EAAE,UAAuB;QACpF,OAAO,CACH,IAAA,qCAAc,EAAC,KAAK,CAAC,MAAM,EAAE,MAAM,CAAC;YACpC,KAAK,CAAC,MAAM,CAAC,QAAQ,CAAC,UAAU,CAAC;YACjC,KAAK,CAAC,GAAG,KAAK,UAAU,CAAC,SAAS,CACrC,CAAC;IACN,CAAC","sourcesContent":["import { ContentPosition, KnownCreateElementDataIndex, PositionType } from 'roosterjs-editor-types';\nimport type { EditorCore, EnsureTypeInContainer, NodePosition } from 'roosterjs-editor-types';\nimport {\n    applyFormat,\n    createElement,\n    createRange,\n    findClosestElementAncestor,\n    getBlockElementAtNode,\n    isNodeEmpty,\n    Position,\n    safeInstanceOf,\n} from 'roosterjs-editor-dom';\n\n/**\n * @internal\n * When typing goes directly under content div, many things can go wrong\n * We fix it by wrapping it with a div and reposition cursor within the div\n */\nexport const ensureTypeInContainer: EnsureTypeInContainer = (\n    core: EditorCore,\n    position: NodePosition,\n    keyboardEvent?: KeyboardEvent\n) => {\n    const table = findClosestElementAncestor(position.node, core.contentDiv, 'table');\n    let td: HTMLElement | null;\n\n    if (table && (td = table.querySelector('td,th'))) {\n        position = new Position(td, PositionType.Begin);\n    }\n    position = position.normalize();\n\n    const block = getBlockElementAtNode(core.contentDiv, position.node);\n    let formatNode: HTMLElement | null;\n\n    if (block) {\n        formatNode = block.collapseToSingleElement();\n        if (isNodeEmpty(formatNode, false /* trimContent */, true /* shouldCountBrAsVisible */)) {\n            const brEl = formatNode.ownerDocument.createElement('br');\n            formatNode.append(brEl);\n        }\n        // if the block is empty, apply default format\n        // Otherwise, leave it as it is as we don't want to change the style for existing data\n        // unless the block was just created by the keyboard event (e.g. ctrl+a & start typing)\n        const shouldSetNodeStyles =\n            isNodeEmpty(formatNode) ||\n            (keyboardEvent && wasNodeJustCreatedByKeyboardEvent(keyboardEvent, formatNode));\n        formatNode = formatNode && shouldSetNodeStyles ? formatNode : null;\n    } else {\n        // Only reason we don't get the selection block is that we have an empty content div\n        // which can happen when users removes everything (i.e. select all and DEL, or backspace from very end to begin)\n        // The fix is to add a DIV wrapping, apply default format and move cursor over\n        formatNode = createElement(\n            KnownCreateElementDataIndex.EmptyLine,\n            core.contentDiv.ownerDocument\n        ) as HTMLElement;\n        core.api.insertNode(core, formatNode, {\n            position: ContentPosition.End,\n            updateCursor: false,\n            replaceSelection: false,\n            insertOnNewLine: false,\n        });\n\n        // element points to a wrapping node we added \"<div><br></div>\". We should move the selection left to <br>\n        position = new Position(formatNode, PositionType.Begin);\n    }\n\n    if (formatNode && core.lifecycle.defaultFormat) {\n        applyFormat(\n            formatNode,\n            core.lifecycle.defaultFormat,\n            core.lifecycle.isDarkMode,\n            core.darkColorHandler\n        );\n    }\n\n    // If this is triggered by a keyboard event, let's select the new position\n    if (keyboardEvent) {\n        core.api.selectRange(core, createRange(new Position(position)));\n    }\n};\n\nfunction wasNodeJustCreatedByKeyboardEvent(event: KeyboardEvent, formatNode: HTMLElement) {\n    return (\n        safeInstanceOf(event.target, 'Node') &&\n        event.target.contains(formatNode) &&\n        event.key === formatNode.innerText\n    );\n}\n"]}