{"version":3,"file":"restoreUndoSnapshot.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-core/lib/coreApi/restoreUndoSnapshot.ts"],"names":[],"mappings":";;;;IAIA;;;;;OAKG;IACI,IAAM,mBAAmB,GAAwB,UAAC,IAAgB,EAAE,IAAY;;QACnF,IAAI,IAAI,CAAC,IAAI,CAAC,aAAa,IAAI,IAAI,GAAG,CAAC,EAAE;YACrC,IAAI,CAAC,GAAG,CAAC,eAAe,CACpB,IAAI,EACJ,IAAI,CAAC,YAAY,EACjB,IAAI,CAAC,gBAAgB,EACrB,KAAK,CAAC,sBAAsB,CAC/B,CAAC;SACL;QAED,IAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAEvD,IAAI,QAAQ,IAAI,QAAQ,CAAC,IAAI,IAAI,IAAI,EAAE;YACnC,IAAI;gBACA,IAAI,CAAC,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;gBAC7B,IAAI,CAAC,GAAG,CAAC,UAAU,CACf,IAAI,EACJ,QAAQ,CAAC,IAAI,EACb,IAAI,CAAC,8BAA8B,EACnC,MAAA,QAAQ,CAAC,QAAQ,mCAAI,SAAS,CACjC,CAAC;gBAEF,IAAM,kBAAgB,GAAG,IAAI,CAAC,gBAAgB,CAAC;gBAC/C,IAAM,aAAW,GAAG,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC;gBAE9C,QAAQ,CAAC,WAAW,CAAC,OAAO,CAAC,UAAA,KAAK;oBAC9B,kBAAgB,CAAC,aAAa,CAC1B,KAAK,CAAC,cAAc,EACpB,aAAW,EACX,KAAK,CAAC,aAAa,CACtB,CAAC;gBACN,CAAC,CAAC,CAAC;gBAEH,MAAA,QAAQ,CAAC,YAAY,0CAAE,OAAO,CAAC,UAAA,WAAW;oBAC9B,IAAA,IAAI,GAAgB,WAAW,KAA3B,EAAE,EAAE,GAAY,WAAW,GAAvB,EAAE,KAAK,GAAK,WAAW,MAAhB,CAAiB;oBACxC,IAAM,OAAO,GAAG,IAAA,oCAAa,EACzB,IAAI,CAAC,UAAU,EACf,IAAA,wCAAiB,EAAC,IAAI,EAAE,EAAE,CAAC,CAC9B,CAAC,CAAC,CAAgB,CAAC;oBACpB,IAAM,MAAM,GAAG,OAAO,IAAI,IAAA,2CAAoB,EAAC,OAAO,CAAC,CAAC;oBAExD,IAAI,MAAM,EAAE;wBACR,IAAI,CAAC,GAAG,CAAC,YAAY,CACjB,IAAI,EACJ;4BACI,SAAS,0BAAiC;4BAC1C,SAAS,4BAAmC;4BAC5C,MAAM,EAAE,MAAM;4BACd,KAAK,OAAA;yBACR,EACD,KAAK,CACR,CAAC;qBACL;gBACL,CAAC,CAAC,CAAC;aACN;oBAAS;gBACN,IAAI,CAAC,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;aACjC;SACJ;IACL,CAAC,CAAC;IA1DW,QAAA,mBAAmB,uBA0D9B","sourcesContent":["import { EntityOperation, PluginEventType } from 'roosterjs-editor-types';\nimport { getEntityFromElement, getEntitySelector, queryElements } from 'roosterjs-editor-dom';\nimport type { EditorCore, RestoreUndoSnapshot } from 'roosterjs-editor-types';\n\n/**\n * @internal\n * Restore an undo snapshot into editor\n * @param core The editor core object\n * @param step Steps to move, can be 0, positive or negative\n */\nexport const restoreUndoSnapshot: RestoreUndoSnapshot = (core: EditorCore, step: number) => {\n    if (core.undo.hasNewContent && step < 0) {\n        core.api.addUndoSnapshot(\n            core,\n            null /*callback*/,\n            null /*changeSource*/,\n            false /*canUndoByBackspace*/\n        );\n    }\n\n    const snapshot = core.undo.snapshotsService.move(step);\n\n    if (snapshot && snapshot.html != null) {\n        try {\n            core.undo.isRestoring = true;\n            core.api.setContent(\n                core,\n                snapshot.html,\n                true /*triggerContentChangedEvent*/,\n                snapshot.metadata ?? undefined\n            );\n\n            const darkColorHandler = core.darkColorHandler;\n            const isDarkModel = core.lifecycle.isDarkMode;\n\n            snapshot.knownColors.forEach(color => {\n                darkColorHandler.registerColor(\n                    color.lightModeColor,\n                    isDarkModel,\n                    color.darkModeColor\n                );\n            });\n\n            snapshot.entityStates?.forEach(entityState => {\n                const { type, id, state } = entityState;\n                const wrapper = queryElements(\n                    core.contentDiv,\n                    getEntitySelector(type, id)\n                )[0] as HTMLElement;\n                const entity = wrapper && getEntityFromElement(wrapper);\n\n                if (entity) {\n                    core.api.triggerEvent(\n                        core,\n                        {\n                            eventType: PluginEventType.EntityOperation,\n                            operation: EntityOperation.UpdateEntityState,\n                            entity: entity,\n                            state,\n                        },\n                        false\n                    );\n                }\n            });\n        } finally {\n            core.undo.isRestoring = false;\n        }\n    }\n};\n"]}