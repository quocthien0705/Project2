{"version":3,"file":"inlineEntityOnPluginEvent.js","sourceRoot":"","sources":["../../../../../packages/roosterjs-editor-core/lib/corePlugins/utils/inlineEntityOnPluginEvent.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n    addDelimiters,\n    arrayPush,\n    createRange,\n    getDelimiterFromElement,\n    getEntityFromElement,\n    getEntitySelector,\n    isBlockElement,\n    isCharacterValue,\n    matchesSelector,\n    Position,\n    safeInstanceOf,\n    splitTextNode,\n} from 'roosterjs-editor-dom';\nimport type { Entity, IEditor, PluginEvent, PluginKeyDownEvent } from 'roosterjs-editor-types';\nimport {\n    ChangeSource,\n    DelimiterClasses,\n    Keys,\n    NodeType,\n    PluginEventType,\n    PositionType,\n    SelectionRangeTypes,\n} from 'roosterjs-editor-types';\n\nconst DELIMITER_SELECTOR =\n    '.' + DelimiterClasses.DELIMITER_AFTER + ',.' + DelimiterClasses.DELIMITER_BEFORE;\nconst ZERO_WIDTH_SPACE = '\\u200B';\nconst INLINE_ENTITY_SELECTOR = 'span' + getEntitySelector();\n\n/**\n * @internal\n */\nexport function inlineEntityOnPluginEvent(event: PluginEvent, editor: IEditor) {\n    switch (event.eventType) {\n        case PluginEventType.ContentChanged:\n            if (event.source === ChangeSource.SetContent) {\n                normalizeDelimitersInEditor(editor);\n            }\n            break;\n        case PluginEventType.EditorReady:\n            normalizeDelimitersInEditor(editor);\n            break;\n\n        case PluginEventType.BeforePaste:\n            const { fragment, sanitizingOption } = event;\n            addDelimitersIfNeeded(fragment.querySelectorAll(INLINE_ENTITY_SELECTOR));\n\n            if (sanitizingOption.additionalAllowedCssClasses) {\n                arrayPush(sanitizingOption.additionalAllowedCssClasses, [\n                    DelimiterClasses.DELIMITER_AFTER,\n                    DelimiterClasses.DELIMITER_BEFORE,\n                ]);\n            }\n            break;\n\n        case PluginEventType.ExtractContentWithDom:\n        case PluginEventType.BeforeCutCopy:\n            event.clonedRoot.querySelectorAll(DELIMITER_SELECTOR).forEach(node => {\n                if (getDelimiterFromElement(node)) {\n                    removeNode(node);\n                } else {\n                    removeDelimiterAttr(node);\n                }\n            });\n            break;\n\n        case PluginEventType.KeyDown:\n            handleKeyDownEvent(editor, event);\n            break;\n    }\n}\n\nfunction preventTypeInDelimiter(delimiter: HTMLElement) {\n    delimiter.normalize();\n    const textNode = delimiter.firstChild as Node;\n    const index = textNode.nodeValue?.indexOf(ZERO_WIDTH_SPACE) ?? -1;\n    if (index >= 0) {\n        splitTextNode(<Text>textNode, index == 0 ? 1 : index, false /* returnFirstPart */);\n        let nodeToMove: Node | undefined;\n        delimiter.childNodes.forEach(node => {\n            if (node.nodeValue !== ZERO_WIDTH_SPACE) {\n                nodeToMove = node;\n            }\n        });\n        if (nodeToMove) {\n            delimiter.parentElement?.insertBefore(\n                nodeToMove,\n                delimiter.className == DelimiterClasses.DELIMITER_BEFORE\n                    ? delimiter\n                    : delimiter.nextSibling\n            );\n            const selection = nodeToMove.ownerDocument?.getSelection();\n\n            if (selection) {\n                selection.setPosition(\n                    nodeToMove,\n                    new Position(nodeToMove, PositionType.End).offset\n                );\n            }\n        }\n    }\n}\n\n/**\n * @internal\n */\nexport function normalizeDelimitersInEditor(editor: IEditor) {\n    removeInvalidDelimiters(editor.queryElements(DELIMITER_SELECTOR));\n    addDelimitersIfNeeded(editor.queryElements(INLINE_ENTITY_SELECTOR));\n}\n\nfunction addDelimitersIfNeeded(nodes: Element[] | NodeListOf<Element>) {\n    nodes.forEach(node => {\n        if (isEntityElement(node)) {\n            addDelimiters(node);\n        }\n    });\n}\n\nfunction isEntityElement(node: Node | null): node is HTMLElement {\n    return !!(\n        node &&\n        safeInstanceOf(node, 'HTMLElement') &&\n        isReadOnly(getEntityFromElement(node))\n    );\n}\n\nfunction removeNode(el: Node | undefined | null) {\n    el?.parentElement?.removeChild(el);\n}\n\nfunction isReadOnly(entity: Entity | null) {\n    return (\n        entity?.isReadonly &&\n        !isBlockElement(entity.wrapper) &&\n        safeInstanceOf(entity.wrapper, 'HTMLElement')\n    );\n}\n\nfunction removeInvalidDelimiters(nodes: Element[] | NodeListOf<Element>) {\n    nodes.forEach(node => {\n        if (getDelimiterFromElement(node)) {\n            const sibling = node.classList.contains(DelimiterClasses.DELIMITER_BEFORE)\n                ? node.nextElementSibling\n                : node.previousElementSibling;\n            if (!(safeInstanceOf(sibling, 'HTMLElement') && getEntityFromElement(sibling))) {\n                removeNode(node);\n            }\n        } else {\n            removeDelimiterAttr(node);\n        }\n    });\n}\n\nfunction removeDelimiterAttr(node: Element | undefined | null, checkEntity: boolean = true) {\n    if (!node) {\n        return;\n    }\n\n    const isAfter = node.classList.contains(DelimiterClasses.DELIMITER_AFTER);\n    const entitySibling = isAfter ? node.previousElementSibling : node.nextElementSibling;\n    if (checkEntity && entitySibling && isEntityElement(entitySibling)) {\n        return;\n    }\n\n    node.classList.remove(DelimiterClasses.DELIMITER_AFTER, DelimiterClasses.DELIMITER_BEFORE);\n\n    node.normalize();\n    node.childNodes.forEach(cn => {\n        const index = cn.textContent?.indexOf(ZERO_WIDTH_SPACE) ?? -1;\n        if (index >= 0) {\n            createRange(cn, index, cn, index + 1)?.deleteContents();\n        }\n    });\n}\n\nfunction handleCollapsedEnter(editor: IEditor, delimiter: HTMLElement) {\n    const isAfter = delimiter.classList.contains(DelimiterClasses.DELIMITER_AFTER);\n    const entity = !isAfter ? delimiter.nextSibling : delimiter.previousSibling;\n    const block = getBlock(editor, delimiter);\n\n    editor.runAsync(() => {\n        if (!block) {\n            return;\n        }\n        const blockToCheck = isAfter ? block.nextSibling : block.previousSibling;\n        if (blockToCheck && safeInstanceOf(blockToCheck, 'HTMLElement')) {\n            const delimiters = blockToCheck.querySelectorAll(DELIMITER_SELECTOR);\n            // Check if the last or first delimiter still contain the delimiter class and remove it.\n            const delimiterToCheck = delimiters.item(isAfter ? 0 : delimiters.length - 1);\n            removeDelimiterAttr(delimiterToCheck);\n        }\n\n        if (isEntityElement(entity)) {\n            const { nextElementSibling, previousElementSibling } = entity;\n            [nextElementSibling, previousElementSibling].forEach(el => {\n                // Check if after Enter the ZWS got removed but we still have a element with the class\n                // Remove the attributes of the element if it is invalid now.\n                if (el && matchesSelector(el, DELIMITER_SELECTOR) && !getDelimiterFromElement(el)) {\n                    removeDelimiterAttr(el, false /* checkEntity */);\n                }\n            });\n            // Add delimiters to the entity if needed because on Enter we can sometimes lose the ZWS of the element.\n            addDelimiters(entity);\n        }\n    });\n}\n\nconst getPosition = (container: HTMLElement | null) => {\n    if (container && getDelimiterFromElement(container)) {\n        const isAfter = container.classList.contains(DelimiterClasses.DELIMITER_AFTER);\n        return new Position(container, isAfter ? PositionType.After : PositionType.Before);\n    }\n    return undefined;\n};\n\nfunction getBlock(editor: IEditor, element: Node | undefined) {\n    if (!element) {\n        return undefined;\n    }\n\n    let block = editor.getBlockElementAtNode(element)?.getStartNode();\n\n    while (block && !isBlockElement(block)) {\n        block = editor.contains(block.parentElement) ? block.parentElement! : undefined;\n    }\n\n    return block;\n}\n\nfunction handleSelectionNotCollapsed(editor: IEditor, range: Range, event: KeyboardEvent) {\n    const { startContainer, endContainer, startOffset, endOffset } = range;\n\n    const startElement = editor.getElementAtCursor(DELIMITER_SELECTOR, startContainer);\n    const endElement = editor.getElementAtCursor(DELIMITER_SELECTOR, endContainer);\n\n    const startUpdate = getPosition(startElement);\n    const endUpdate = getPosition(endElement);\n\n    if (startUpdate || endUpdate) {\n        editor.select(\n            startUpdate ?? new Position(startContainer, startOffset),\n            endUpdate ?? new Position(endContainer, endOffset)\n        );\n    }\n    editor.runAsync(aEditor => {\n        const delimiter = aEditor.getElementAtCursor(DELIMITER_SELECTOR);\n        if (delimiter) {\n            preventTypeInDelimiter(delimiter);\n            if (event.which === Keys.ENTER) {\n                removeDelimiterAttr(delimiter);\n            }\n        }\n    });\n}\n\nfunction handleKeyDownEvent(editor: IEditor, event: PluginKeyDownEvent) {\n    const range = editor.getSelectionRangeEx();\n    const { rawEvent } = event;\n    if (range.type != SelectionRangeTypes.Normal) {\n        return;\n    }\n\n    if (range.areAllCollapsed && (isCharacterValue(rawEvent) || rawEvent.which === Keys.ENTER)) {\n        const position = editor.getFocusedPosition()?.normalize();\n        if (!position) {\n            return;\n        }\n\n        const { element, node } = position;\n        const refNode = element == node ? element.childNodes.item(position.offset) : element;\n\n        const delimiter = editor.getElementAtCursor(DELIMITER_SELECTOR, refNode);\n        if (!delimiter) {\n            return;\n        }\n\n        if (rawEvent.which === Keys.ENTER) {\n            handleCollapsedEnter(editor, delimiter);\n        } else if (delimiter.firstChild?.nodeType == NodeType.Text) {\n            editor.runAsync(() => preventTypeInDelimiter(delimiter));\n        }\n    } else if (!range.areAllCollapsed && !rawEvent.shiftKey && rawEvent.which != Keys.SHIFT) {\n        const currentRange = range.ranges[0];\n        if (!currentRange) {\n            return;\n        }\n        handleSelectionNotCollapsed(editor, currentRange, rawEvent);\n    }\n}\n"]}