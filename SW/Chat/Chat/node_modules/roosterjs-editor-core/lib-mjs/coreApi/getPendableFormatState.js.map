{"version":3,"file":"getPendableFormatState.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-core/lib/coreApi/getPendableFormatState.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,QAAQ,EAAE,aAAa,EAAE,YAAY,EAAE,QAAQ,EAAE,MAAM,sBAAsB,CAAC;AAUvF;;;;;GAKG;AACH,MAAM,CAAC,IAAM,sBAAsB,GAA2B,UAC1D,IAAgB,EAChB,oBAA6B;;IAE7B,IAAM,KAAK,GAAG,IAAI,CAAC,GAAG,CAAC,iBAAiB,CAAC,IAAI,EAAE,IAAI,CAAC,oBAAoB,CAAC,CAAC;IAC1E,IAAM,yBAAyB,GAAG,IAAI,CAAC,kBAAkB,CAAC,mBAAmB,CAAC;IAC9E,IAAM,cAAc,GAAG,MAAA,IAAI,CAAC,kBAAkB,CAAC,sBAAsB,0CAAE,SAAS,EAAE,CAAC;IACnF,IAAM,eAAe,GAAG,KAAK,IAAI,QAAQ,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,SAAS,EAAE,CAAC;IACtE,IAAM,cAAc,GAChB,eAAe;QACf,cAAc;QACd,KAAK,CAAC,SAAS;QACf,eAAe,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;IAE5C,IAAI,KAAK,IAAI,yBAAyB,IAAI,cAAc,IAAI,CAAC,oBAAoB,EAAE;QAC/E,OAAO,yBAAyB,CAAC;KACpC;SAAM;QACH,OAAO,eAAe,CAAC,CAAC,CAAC,wBAAwB,CAAC,IAAI,EAAE,eAAe,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;KACjF;AACL,CAAC,CAAC;AAEF,IAAM,qBAAqB,GAGvB;IACA,MAAM,EAAE,UAAC,GAAG,EAAE,KAAK;QACf,OAAA,GAAG,IAAI,GAAG;YACV,GAAG,IAAI,QAAQ;YACf,GAAG,IAAI,IAAI;YACX,GAAG,IAAI,IAAI;YACX,GAAG,IAAI,IAAI;YACX,GAAG,IAAI,IAAI;YACX,GAAG,IAAI,IAAI;YACX,GAAG,IAAI,IAAI;YACX,QAAQ,CAAC,KAAK,CAAC,UAAU,CAAC,IAAI,GAAG;YACjC,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC,OAAO,CAAC,KAAK,CAAC,UAAU,CAAC,IAAI,CAAC;IATjD,CASiD;IACrD,WAAW,EAAE,UAAC,GAAG,EAAE,KAAK,IAAK,OAAA,GAAG,IAAI,GAAG,IAAI,KAAK,CAAC,cAAc,CAAC,OAAO,CAAC,WAAW,CAAC,IAAI,CAAC,EAA5D,CAA4D;IACzF,QAAQ,EAAE,UAAC,GAAG,EAAE,KAAK,IAAK,OAAA,GAAG,IAAI,GAAG,IAAI,GAAG,IAAI,IAAI,IAAI,KAAK,CAAC,SAAS,KAAK,QAAQ,EAAzD,CAAyD;IACnF,WAAW,EAAE,UAAC,GAAG,EAAE,KAAK,IAAK,OAAA,GAAG,IAAI,KAAK,IAAI,KAAK,CAAC,aAAa,KAAK,KAAK,EAA7C,CAA6C;IAC1E,aAAa,EAAE,UAAC,GAAG,EAAE,KAAK,IAAK,OAAA,GAAG,IAAI,KAAK,IAAI,KAAK,CAAC,aAAa,KAAK,OAAO,EAA/C,CAA+C;IAC9E,eAAe,EAAE,UAAC,GAAG,EAAE,KAAK;QACxB,OAAA,GAAG,IAAI,GAAG,IAAI,GAAG,IAAI,QAAQ,IAAI,KAAK,CAAC,cAAc,CAAC,OAAO,CAAC,cAAc,CAAC,IAAI,CAAC;IAAlF,CAAkF;CACzF,CAAC;AAEF;;GAEG;AAEH,IAAM,gBAAgB,GAAyE;IAC3F,MAAM,EAAE,UAAA,KAAK;QACT,OAAA,CAAC,KAAK,CAAC,UAAU,KAAK,EAAE,IAAI,QAAQ,CAAC,KAAK,CAAC,UAAU,CAAC,GAAG,GAAG,CAAC;YAC7D,KAAK,CAAC,UAAU,KAAK,QAAQ;IAD7B,CAC6B;IACjC,WAAW,EAAE,UAAA,KAAK;QACd,OAAA,KAAK,CAAC,cAAc,KAAK,EAAE,IAAI,KAAK,CAAC,cAAc,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,CAAC;IAA5E,CAA4E;IAChF,QAAQ,EAAE,UAAA,KAAK,IAAI,OAAA,KAAK,CAAC,SAAS,KAAK,EAAE,IAAI,KAAK,CAAC,SAAS,KAAK,QAAQ,EAAtD,CAAsD;IACzE,WAAW,EAAE,UAAA,KAAK,IAAI,OAAA,KAAK,CAAC,aAAa,KAAK,EAAE,IAAI,KAAK,CAAC,aAAa,KAAK,KAAK,EAA3D,CAA2D;IACjF,aAAa,EAAE,UAAA,KAAK,IAAI,OAAA,KAAK,CAAC,aAAa,KAAK,EAAE,IAAI,KAAK,CAAC,aAAa,KAAK,OAAO,EAA7D,CAA6D;IACrF,eAAe,EAAE,UAAA,KAAK;QAClB,OAAA,KAAK,CAAC,cAAc,KAAK,EAAE,IAAI,KAAK,CAAC,cAAc,CAAC,OAAO,CAAC,cAAc,CAAC,GAAG,CAAC;IAA/E,CAA+E;CACtF,CAAC;AAEF,SAAS,wBAAwB,CAC7B,IAAgB,EAChB,eAA6B;IAE7B,IAAI,IAAI,GAAgB,eAAe,CAAC,IAAI,CAAC;IAC7C,IAAM,WAAW,GAAwB,EAAE,CAAC;IAC5C,IAAM,YAAY,GAA0B,EAAE,CAAC;;QAE3C,IAAM,GAAG,GAAG,YAAY,CAAC,IAAI,CAAC,CAAC;QAC/B,IAAM,KAAK,GAAG,IAAI,CAAC,QAAQ,mBAAoB,IAAK,IAAoB,CAAC,KAAK,CAAC;QAC/E,IAAI,GAAG,IAAI,KAAK,EAAE;YACd,aAAa,CAAC,qBAAqB,CAAC,CAAC,OAAO,CAAC,UAAA,GAAG;gBAC5C,IAAI,CAAC,CAAC,YAAY,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,EAAE;oBACnC,WAAW,CAAC,GAAG,CAAC,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,qBAAqB,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;oBAC9E,IAAI,gBAAgB,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,EAAE;wBAC9B,YAAY,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;qBAC1B;iBACJ;YACL,CAAC,CAAC,CAAC;SACN;QACD,IAAI,GAAG,IAAI,CAAC,UAAU,CAAC;;IAb3B,OAAO,IAAI,IAAI,QAAQ,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC;;KAc7C;IACD,OAAO,WAAW,CAAC;AACvB,CAAC","sourcesContent":["import { contains, getObjectKeys, getTagOfNode, Position } from 'roosterjs-editor-dom';\nimport { NodeType } from 'roosterjs-editor-types';\nimport type { PendableFormatNames } from 'roosterjs-editor-dom';\nimport type {\n    EditorCore,\n    GetPendableFormatState,\n    NodePosition,\n    PendableFormatState,\n} from 'roosterjs-editor-types';\n\n/**\n * @internal\n * @param core The EditorCore object\n * @param forceGetStateFromDOM If set to true, will force get the format state from DOM tree.\n * @returns The cached format state if it exists. If the cached position do not exist, search for pendable elements in the DOM tree and return the pendable format state.\n */\nexport const getPendableFormatState: GetPendableFormatState = (\n    core: EditorCore,\n    forceGetStateFromDOM: boolean\n): PendableFormatState => {\n    const range = core.api.getSelectionRange(core, true /* tryGetFromCache*/);\n    const cachedPendableFormatState = core.pendingFormatState.pendableFormatState;\n    const cachedPosition = core.pendingFormatState.pendableFormatPosition?.normalize();\n    const currentPosition = range && Position.getStart(range).normalize();\n    const isSamePosition =\n        currentPosition &&\n        cachedPosition &&\n        range.collapsed &&\n        currentPosition.equalTo(cachedPosition);\n\n    if (range && cachedPendableFormatState && isSamePosition && !forceGetStateFromDOM) {\n        return cachedPendableFormatState;\n    } else {\n        return currentPosition ? queryCommandStateFromDOM(core, currentPosition) : {};\n    }\n};\n\nconst PendableStyleCheckers: Record<\n    PendableFormatNames,\n    (tagName: string, style: CSSStyleDeclaration) => boolean\n> = {\n    isBold: (tag, style) =>\n        tag == 'B' ||\n        tag == 'STRONG' ||\n        tag == 'H1' ||\n        tag == 'H2' ||\n        tag == 'H3' ||\n        tag == 'H4' ||\n        tag == 'H5' ||\n        tag == 'H6' ||\n        parseInt(style.fontWeight) >= 700 ||\n        ['bold', 'bolder'].indexOf(style.fontWeight) >= 0,\n    isUnderline: (tag, style) => tag == 'U' || style.textDecoration.indexOf('underline') >= 0,\n    isItalic: (tag, style) => tag == 'I' || tag == 'EM' || style.fontStyle === 'italic',\n    isSubscript: (tag, style) => tag == 'SUB' || style.verticalAlign === 'sub',\n    isSuperscript: (tag, style) => tag == 'SUP' || style.verticalAlign === 'super',\n    isStrikeThrough: (tag, style) =>\n        tag == 'S' || tag == 'STRIKE' || style.textDecoration.indexOf('line-through') >= 0,\n};\n\n/**\n * CssFalsyCheckers checks for non pendable format that might overlay a pendable format, then it can prevent getPendableFormatState return falsy pendable format states.\n */\n\nconst CssFalsyCheckers: Record<PendableFormatNames, (style: CSSStyleDeclaration) => boolean> = {\n    isBold: style =>\n        (style.fontWeight !== '' && parseInt(style.fontWeight) < 700) ||\n        style.fontWeight === 'normal',\n    isUnderline: style =>\n        style.textDecoration !== '' && style.textDecoration.indexOf('underline') < 0,\n    isItalic: style => style.fontStyle !== '' && style.fontStyle !== 'italic',\n    isSubscript: style => style.verticalAlign !== '' && style.verticalAlign !== 'sub',\n    isSuperscript: style => style.verticalAlign !== '' && style.verticalAlign !== 'super',\n    isStrikeThrough: style =>\n        style.textDecoration !== '' && style.textDecoration.indexOf('line-through') < 0,\n};\n\nfunction queryCommandStateFromDOM(\n    core: EditorCore,\n    currentPosition: NodePosition\n): PendableFormatState {\n    let node: Node | null = currentPosition.node;\n    const formatState: PendableFormatState = {};\n    const pendableKeys: PendableFormatNames[] = [];\n    while (node && contains(core.contentDiv, node)) {\n        const tag = getTagOfNode(node);\n        const style = node.nodeType == NodeType.Element && (node as HTMLElement).style;\n        if (tag && style) {\n            getObjectKeys(PendableStyleCheckers).forEach(key => {\n                if (!(pendableKeys.indexOf(key) >= 0)) {\n                    formatState[key] = formatState[key] || PendableStyleCheckers[key](tag, style);\n                    if (CssFalsyCheckers[key](style)) {\n                        pendableKeys.push(key);\n                    }\n                }\n            });\n        }\n        node = node.parentNode;\n    }\n    return formatState;\n}\n"]}