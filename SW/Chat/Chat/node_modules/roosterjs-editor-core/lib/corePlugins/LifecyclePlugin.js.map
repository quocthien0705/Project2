{"version":3,"file":"LifecyclePlugin.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-core/lib/corePlugins/LifecyclePlugin.ts"],"names":[],"mappings":"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","sourcesContent":["import { ChangeSource, PluginEventType } from 'roosterjs-editor-types';\nimport { getObjectKeys, setColor } from 'roosterjs-editor-dom';\nimport type {\n    EditorOptions,\n    IEditor,\n    LifecyclePluginState,\n    PluginWithState,\n    PluginEvent,\n} from 'roosterjs-editor-types';\n\nconst CONTENT_EDITABLE_ATTRIBUTE_NAME = 'contenteditable';\n\nconst DARK_MODE_DEFAULT_FORMAT = {\n    backgroundColors: {\n        darkModeColor: 'rgb(51,51,51)',\n        lightModeColor: 'rgb(255,255,255)',\n    },\n    textColors: {\n        darkModeColor: 'rgb(255,255,255)',\n        lightModeColor: 'rgb(0,0,0)',\n    },\n};\n\n/**\n * @internal\n * Lifecycle plugin handles editor initialization and disposing\n */\nexport default class LifecyclePlugin implements PluginWithState<LifecyclePluginState> {\n    private editor: IEditor | null = null;\n    private state: LifecyclePluginState;\n    private initialContent: string;\n    private initializer: (() => void) | null = null;\n    private disposer: (() => void) | null = null;\n    private adjustColor: () => void;\n\n    /**\n     * Construct a new instance of LifecyclePlugin\n     * @param options The editor options\n     * @param contentDiv The editor content DIV\n     */\n    constructor(options: EditorOptions, contentDiv: HTMLDivElement) {\n        this.initialContent = options.initialContent || contentDiv.innerHTML || '';\n\n        // Make the container editable and set its selection styles\n        if (contentDiv.getAttribute(CONTENT_EDITABLE_ATTRIBUTE_NAME) === null) {\n            this.initializer = () => {\n                contentDiv.contentEditable = 'true';\n                contentDiv.style.userSelect = 'text';\n            };\n            this.disposer = () => {\n                contentDiv.style.userSelect = '';\n                contentDiv.removeAttribute(CONTENT_EDITABLE_ATTRIBUTE_NAME);\n            };\n        }\n        this.adjustColor = options.doNotAdjustEditorColor\n            ? () => {}\n            : () => {\n                  const { textColors, backgroundColors } = DARK_MODE_DEFAULT_FORMAT;\n                  const { isDarkMode } = this.state;\n                  const darkColorHandler = this.editor?.getDarkColorHandler();\n                  setColor(\n                      contentDiv,\n                      textColors,\n                      false /*isBackground*/,\n                      isDarkMode,\n                      false /*shouldAdaptFontColor*/,\n                      darkColorHandler\n                  );\n                  setColor(\n                      contentDiv,\n                      backgroundColors,\n                      true /*isBackground*/,\n                      isDarkMode,\n                      false /*shouldAdaptFontColor*/,\n                      darkColorHandler\n                  );\n              };\n\n        const getDarkColor = options.getDarkColor ?? ((color: string) => color);\n        const defaultFormat = options.defaultFormat ? { ...options.defaultFormat } : null;\n\n        if (defaultFormat) {\n            if (defaultFormat.textColor && !defaultFormat.textColors) {\n                defaultFormat.textColors = {\n                    lightModeColor: defaultFormat.textColor,\n                    darkModeColor: getDarkColor(defaultFormat.textColor),\n                };\n                delete defaultFormat.textColor;\n            }\n\n            if (defaultFormat.backgroundColor && !defaultFormat.backgroundColors) {\n                defaultFormat.backgroundColors = {\n                    lightModeColor: defaultFormat.backgroundColor,\n                    darkModeColor: getDarkColor(defaultFormat.backgroundColor),\n                };\n                delete defaultFormat.backgroundColor;\n            }\n        }\n\n        this.state = {\n            customData: {},\n            defaultFormat,\n            isDarkMode: !!options.inDarkMode,\n            getDarkColor,\n            onExternalContentTransform: options.onExternalContentTransform ?? null,\n            experimentalFeatures: options.experimentalFeatures || [],\n            shadowEditFragment: null,\n            shadowEditEntities: null,\n            shadowEditSelectionPath: null,\n            shadowEditTableSelectionPath: null,\n            shadowEditImageSelectionPath: null,\n        };\n    }\n\n    /**\n     * Get a friendly name of  this plugin\n     */\n    getName() {\n        return 'Lifecycle';\n    }\n\n    /**\n     * Initialize this plugin. This should only be called from Editor\n     * @param editor Editor instance\n     */\n    initialize(editor: IEditor) {\n        this.editor = editor;\n\n        // Ensure initial content and its format\n        this.editor.setContent(this.initialContent, false /*triggerContentChangedEvent*/);\n\n        // Set content DIV to be editable\n        this.initializer?.();\n\n        // Set editor background color for dark mode\n        this.adjustColor();\n\n        // Let other plugins know that we are ready\n        this.editor.triggerPluginEvent(PluginEventType.EditorReady, {}, true /*broadcast*/);\n    }\n\n    /**\n     * Dispose this plugin\n     */\n    dispose() {\n        this.editor?.triggerPluginEvent(PluginEventType.BeforeDispose, {}, true /*broadcast*/);\n\n        getObjectKeys(this.state.customData).forEach(key => {\n            const data = this.state.customData[key];\n\n            if (data && data.disposer) {\n                data.disposer(data.value);\n            }\n\n            delete this.state.customData[key];\n        });\n\n        if (this.disposer) {\n            this.disposer();\n            this.disposer = null;\n            this.initializer = null;\n        }\n\n        this.editor = null;\n    }\n\n    /**\n     * Get plugin state object\n     */\n    getState() {\n        return this.state;\n    }\n\n    /**\n     * Handle events triggered from editor\n     * @param event PluginEvent object\n     */\n    onPluginEvent(event: PluginEvent) {\n        if (\n            event.eventType == PluginEventType.ContentChanged &&\n            (event.source == ChangeSource.SwitchToDarkMode ||\n                event.source == ChangeSource.SwitchToLightMode)\n        ) {\n            this.state.isDarkMode = event.source == ChangeSource.SwitchToDarkMode;\n            this.adjustColor();\n        }\n    }\n}\n"]}