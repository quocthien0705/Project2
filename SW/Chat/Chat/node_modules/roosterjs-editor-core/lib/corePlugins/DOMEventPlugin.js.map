{"version":3,"file":"DOMEventPlugin.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-core/lib/corePlugins/DOMEventPlugin.ts"],"names":[],"mappings":"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","sourcesContent":["import { arrayPush, Browser, isCharacterValue } from 'roosterjs-editor-dom';\nimport { ChangeSource, Keys, PluginEventType } from 'roosterjs-editor-types';\nimport type {\n    ContextMenuProvider,\n    DOMEventHandler,\n    DOMEventPluginState,\n    EditorOptions,\n    EditorPlugin,\n    IEditor,\n    PluginWithState,\n} from 'roosterjs-editor-types';\n\n/**\n * @internal\n * DOMEventPlugin handles customized DOM events, including:\n * 1. Keyboard event\n * 2. Mouse event\n * 3. IME state\n * 4. Drop event\n * 5. Focus and blur event\n * 6. Input event\n * 7. Scroll event\n * It contains special handling for Safari since Safari cannot get correct selection when onBlur event is triggered in editor.\n */\nexport default class DOMEventPlugin implements PluginWithState<DOMEventPluginState> {\n    private editor: IEditor | null = null;\n    private disposer: (() => void) | null = null;\n    private state: DOMEventPluginState;\n\n    /**\n     * Construct a new instance of DOMEventPlugin\n     * @param options The editor options\n     * @param contentDiv The editor content DIV\n     */\n    constructor(options: EditorOptions, contentDiv: HTMLDivElement) {\n        this.state = {\n            isInIME: false,\n            scrollContainer: options.scrollContainer || contentDiv,\n            selectionRange: null,\n            stopPrintableKeyboardEventPropagation: !options.allowKeyboardEventPropagation,\n            contextMenuProviders:\n                options.plugins?.filter<ContextMenuProvider<any>>(isContextMenuProvider) || [],\n            tableSelectionRange: null,\n            imageSelectionRange: null,\n        };\n    }\n\n    /**\n     * Get a friendly name of  this plugin\n     */\n    getName() {\n        return 'DOMEvent';\n    }\n\n    /**\n     * Initialize this plugin. This should only be called from Editor\n     * @param editor Editor instance\n     */\n    initialize(editor: IEditor) {\n        this.editor = editor;\n\n        const document = this.editor.getDocument();\n        //Record<string, DOMEventHandler>\n        const eventHandlers: Partial<\n            { [P in keyof HTMLElementEventMap]: DOMEventHandler<HTMLElementEventMap[P]> }\n        > = {\n            // 1. Keyboard event\n            keypress: this.getEventHandler(PluginEventType.KeyPress),\n            keydown: this.getEventHandler(PluginEventType.KeyDown),\n            keyup: this.getEventHandler(PluginEventType.KeyUp),\n\n            // 2. Mouse event\n            mousedown: PluginEventType.MouseDown,\n            contextmenu: this.onContextMenuEvent,\n\n            // 3. IME state management\n            compositionstart: () => (this.state.isInIME = true),\n            compositionend: (rawEvent: CompositionEvent) => {\n                this.state.isInIME = false;\n                editor.triggerPluginEvent(PluginEventType.CompositionEnd, {\n                    rawEvent,\n                });\n            },\n\n            // 4. Drag and Drop event\n            dragstart: this.onDragStart,\n            drop: this.onDrop,\n\n            // 5. Focus management\n            focus: this.onFocus,\n\n            // 6. Input event\n            [Browser.isIE ? 'textinput' : 'input']: this.getEventHandler(PluginEventType.Input),\n        };\n\n        // 7. onBlur handlers\n        if (Browser.isSafari) {\n            document.addEventListener('selectionchange', this.onSelectionChangeSafari);\n        } else if (Browser.isIEOrEdge) {\n            type EventHandlersIE = {\n                beforedeactivate: DOMEventHandler<HTMLElementEventMap['blur']>;\n            };\n            (eventHandlers as EventHandlersIE).beforedeactivate = this.cacheSelection;\n        } else {\n            eventHandlers.blur = this.cacheSelection;\n        }\n\n        this.disposer = editor.addDomEventHandler(<Record<string, DOMEventHandler>>eventHandlers);\n\n        // 8. Scroll event\n        this.state.scrollContainer.addEventListener('scroll', this.onScroll);\n        document.defaultView?.addEventListener('scroll', this.onScroll);\n        document.defaultView?.addEventListener('resize', this.onScroll);\n    }\n\n    /**\n     * Dispose this plugin\n     */\n    dispose() {\n        const document = this.editor?.getDocument();\n        if (document && Browser.isSafari) {\n            document.removeEventListener('selectionchange', this.onSelectionChangeSafari);\n        }\n\n        document?.defaultView?.removeEventListener('resize', this.onScroll);\n        document?.defaultView?.removeEventListener('scroll', this.onScroll);\n        this.state.scrollContainer.removeEventListener('scroll', this.onScroll);\n        this.disposer?.();\n        this.disposer = null;\n        this.editor = null;\n    }\n\n    /**\n     * Get plugin state object\n     */\n    getState() {\n        return this.state;\n    }\n\n    private onDragStart = (e: Event) => {\n        const dragEvent = e as DragEvent;\n        const element = this.editor?.getElementAtCursor('*', dragEvent.target as Node);\n\n        if (element && !element.isContentEditable) {\n            dragEvent.preventDefault();\n        }\n    };\n    private onDrop = () => {\n        this.editor?.runAsync(editor => {\n            editor.addUndoSnapshot(() => {}, ChangeSource.Drop);\n        });\n    };\n\n    private onFocus = () => {\n        if (!this.state.skipReselectOnFocus) {\n            const { table, coordinates } = this.state.tableSelectionRange || {};\n            const { image } = this.state.imageSelectionRange || {};\n\n            if (table && coordinates) {\n                this.editor?.select(table, coordinates);\n            } else if (image) {\n                this.editor?.select(image);\n            } else if (this.state.selectionRange) {\n                this.editor?.select(this.state.selectionRange);\n            }\n        }\n\n        if (!Browser.isSafari) {\n            this.state.selectionRange = null;\n        }\n    };\n\n    private onSelectionChangeSafari = () => {\n        // Safari has problem to handle onBlur event. When blur, we cannot get the original selection from editor.\n        // So we always save a selection whenever editor has focus. Then after blur, we can still use this cached selection.\n        if (this.editor?.hasFocus() && !this.editor.isInShadowEdit()) {\n            this.state.selectionRange = this.editor.getSelectionRange(false /*tryGetFromCache*/);\n        }\n    };\n\n    private cacheSelection = () => {\n        if (!this.state.selectionRange && this.editor) {\n            this.state.selectionRange = this.editor.getSelectionRange(false /*tryGetFromCache*/);\n        }\n    };\n\n    private onScroll = (e: Event) => {\n        this.editor?.triggerPluginEvent(PluginEventType.Scroll, {\n            rawEvent: e,\n            scrollContainer: this.state.scrollContainer,\n        });\n    };\n\n    private getEventHandler(eventType: PluginEventType): DOMEventHandler {\n        const beforeDispatch = (event: Event) =>\n            eventType == PluginEventType.Input\n                ? this.onInputEvent(<InputEvent>event)\n                : this.onKeyboardEvent(<KeyboardEvent>event);\n\n        return this.state.stopPrintableKeyboardEventPropagation\n            ? {\n                  pluginEventType: eventType,\n                  beforeDispatch,\n              }\n            : eventType;\n    }\n\n    private onKeyboardEvent = (event: KeyboardEvent) => {\n        if (isCharacterValue(event) || (event.which >= Keys.PAGEUP && event.which <= Keys.DOWN)) {\n            // Stop propagation for Character keys and Up/Down/Left/Right/Home/End/PageUp/PageDown\n            // since editor already handles these keys and no need to propagate to parents\n            event.stopPropagation();\n        }\n    };\n\n    private onInputEvent = (event: InputEvent) => {\n        event.stopPropagation();\n    };\n\n    private onContextMenuEvent = (event: MouseEvent) => {\n        const allItems: any[] = [];\n        const searcher = this.editor?.getContentSearcherOfCursor();\n        const elementBeforeCursor = searcher?.getInlineElementBefore();\n\n        let eventTargetNode = event.target as Node;\n        if (event.button != 2 && elementBeforeCursor) {\n            eventTargetNode = elementBeforeCursor.getContainerNode();\n        }\n        this.state.contextMenuProviders.forEach(provider => {\n            const items = provider.getContextMenuItems(eventTargetNode) ?? [];\n            if (items?.length > 0) {\n                if (allItems.length > 0) {\n                    allItems.push(null);\n                }\n                arrayPush(allItems, items);\n            }\n        });\n        this.editor?.triggerPluginEvent(PluginEventType.ContextMenu, {\n            rawEvent: event,\n            items: allItems,\n        });\n    };\n}\n\nfunction isContextMenuProvider(source: EditorPlugin): source is ContextMenuProvider<any> {\n    return !!(<ContextMenuProvider<any>>source)?.getContextMenuItems;\n}\n"]}