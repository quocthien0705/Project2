{"version":3,"file":"CopyPastePlugin.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-core/lib/corePlugins/CopyPastePlugin.ts"],"names":[],"mappings":"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","sourcesContent":["import { forEachSelectedCell } from './utils/forEachSelectedCell';\nimport { removeCellsOutsideSelection } from './utils/removeCellsOutsideSelection';\nimport {\n    addRangeToSelection,\n    createElement,\n    extractClipboardEvent,\n    moveChildNodes,\n    Browser,\n    setHtmlWithMetadata,\n    createRange,\n    VTable,\n    isWholeTableSelected,\n} from 'roosterjs-editor-dom';\nimport type {\n    CopyPastePluginState,\n    EditorOptions,\n    IEditor,\n    PluginWithState,\n    SelectionRangeEx,\n    TableSelection,\n} from 'roosterjs-editor-types';\nimport {\n    ChangeSource,\n    GetContentMode,\n    PluginEventType,\n    KnownCreateElementDataIndex,\n    SelectionRangeTypes,\n    TableOperation,\n} from 'roosterjs-editor-types';\n\n/**\n * @internal\n * Copy and paste plugin for handling onCopy and onPaste event\n */\nexport default class CopyPastePlugin implements PluginWithState<CopyPastePluginState> {\n    private editor: IEditor | null = null;\n    private disposer: (() => void) | null = null;\n    private state: CopyPastePluginState;\n\n    /**\n     * Construct a new instance of CopyPastePlugin\n     * @param options The editor options\n     */\n    constructor(options: EditorOptions) {\n        this.state = {\n            allowedCustomPasteType: options.allowedCustomPasteType || [],\n        };\n    }\n\n    /**\n     * Get a friendly name of  this plugin\n     */\n    getName() {\n        return 'CopyPaste';\n    }\n\n    /**\n     * Initialize this plugin. This should only be called from Editor\n     * @param editor Editor instance\n     */\n    initialize(editor: IEditor) {\n        this.editor = editor;\n        this.disposer = this.editor.addDomEventHandler({\n            paste: e => this.onPaste(e),\n            copy: e => this.onCutCopy(e, false /*isCut*/),\n            cut: e => this.onCutCopy(e, true /*isCut*/),\n        });\n    }\n\n    /**\n     * Dispose this plugin\n     */\n    dispose() {\n        if (this.disposer) {\n            this.disposer();\n        }\n        this.disposer = null;\n        this.editor = null;\n    }\n\n    /**\n     * Get plugin state object\n     */\n    getState() {\n        return this.state;\n    }\n\n    private onCutCopy(event: Event, isCut: boolean) {\n        if (this.editor) {\n            const selection = this.editor.getSelectionRangeEx();\n            if (selection && !selection.areAllCollapsed) {\n                const html = this.editor.getContent(GetContentMode.RawHTMLWithSelection);\n                const tempDiv = this.getTempDiv(this.editor, true /*forceInLightMode*/);\n                const metadata = setHtmlWithMetadata(\n                    tempDiv,\n                    html,\n                    this.editor.getTrustedHTMLHandler()\n                );\n                let newRange: Range | null = null;\n\n                if (\n                    selection.type === SelectionRangeTypes.TableSelection &&\n                    selection.coordinates\n                ) {\n                    const table = tempDiv.querySelector(\n                        `#${selection.table.id}`\n                    ) as HTMLTableElement;\n                    newRange = this.createTableRange(table, selection.coordinates);\n                    if (isCut) {\n                        this.deleteTableContent(\n                            this.editor,\n                            selection.table,\n                            selection.coordinates\n                        );\n                    }\n                } else if (selection.type === SelectionRangeTypes.ImageSelection) {\n                    const image = tempDiv.querySelector('#' + selection.image.id);\n\n                    if (image) {\n                        newRange = createRange(image);\n                        if (isCut) {\n                            this.deleteImage(this.editor, selection.image.id);\n                        }\n                    }\n                } else {\n                    newRange =\n                        metadata?.type === SelectionRangeTypes.Normal\n                            ? createRange(tempDiv, metadata.start, metadata.end)\n                            : null;\n                }\n                if (newRange) {\n                    const cutCopyEvent = this.editor.triggerPluginEvent(\n                        PluginEventType.BeforeCutCopy,\n                        {\n                            clonedRoot: tempDiv,\n                            range: newRange,\n                            rawEvent: event as ClipboardEvent,\n                            isCut,\n                        }\n                    );\n\n                    if (cutCopyEvent.range) {\n                        addRangeToSelection(newRange);\n                    }\n\n                    this.editor.runAsync(editor => {\n                        this.cleanUpAndRestoreSelection(tempDiv, selection, !isCut /* isCopy */);\n\n                        if (isCut) {\n                            editor.addUndoSnapshot(() => {\n                                const position = editor.deleteSelectedContent();\n                                editor.focus();\n                                editor.select(position);\n                            }, ChangeSource.Cut);\n                        }\n                    });\n                }\n            }\n        }\n    }\n\n    private onPaste = (event: Event) => {\n        let range: Range | null = null;\n        if (this.editor) {\n            const editor = this.editor;\n            extractClipboardEvent(\n                event as ClipboardEvent,\n                clipboardData => {\n                    if (editor && !editor.isDisposed()) {\n                        editor.paste(clipboardData);\n                    }\n                },\n                {\n                    allowedCustomPasteType: this.state.allowedCustomPasteType,\n                    getTempDiv: () => {\n                        range = editor.getSelectionRange() ?? null;\n                        return this.getTempDiv(editor);\n                    },\n                    removeTempDiv: div => {\n                        if (range) {\n                            this.cleanUpAndRestoreSelection(div, range, false /* isCopy */);\n                        }\n                    },\n                },\n                this.editor.getSelectionRange() ?? undefined\n            );\n        }\n    };\n\n    private getTempDiv(editor: IEditor, forceInLightMode?: boolean) {\n        const div = editor.getCustomData(\n            'CopyPasteTempDiv',\n            () => {\n                const tempDiv = createElement(\n                    KnownCreateElementDataIndex.CopyPasteTempDiv,\n                    editor.getDocument()\n                ) as HTMLDivElement;\n\n                editor.getDocument().body.appendChild(tempDiv);\n\n                return tempDiv;\n            },\n            tempDiv => tempDiv.parentNode?.removeChild(tempDiv)\n        );\n\n        if (forceInLightMode) {\n            div.style.backgroundColor = 'white';\n            div.style.color = 'black';\n        }\n\n        div.style.display = '';\n        div.focus();\n\n        return div;\n    }\n\n    private cleanUpAndRestoreSelection(\n        tempDiv: HTMLDivElement,\n        range: Range | SelectionRangeEx,\n        isCopy: boolean\n    ) {\n        if (!!(<SelectionRangeEx>range)?.type || (<SelectionRangeEx>range).type == 0) {\n            const selection = <SelectionRangeEx>range;\n            switch (selection.type) {\n                case SelectionRangeTypes.TableSelection:\n                case SelectionRangeTypes.ImageSelection:\n                    this.editor?.select(selection);\n                    break;\n                case SelectionRangeTypes.Normal:\n                    const range = selection.ranges?.[0];\n                    this.restoreRange(range, isCopy);\n                    break;\n            }\n        } else {\n            this.restoreRange(<Range>range, isCopy);\n        }\n\n        tempDiv.style.backgroundColor = '';\n        tempDiv.style.color = '';\n        tempDiv.style.display = 'none';\n        moveChildNodes(tempDiv);\n    }\n\n    private restoreRange(range: Range, isCopy: boolean) {\n        if (range && this.editor) {\n            if (isCopy && Browser.isAndroid) {\n                range.collapse();\n            }\n            this.editor.select(range);\n        }\n    }\n\n    private createTableRange(table: HTMLTableElement, selection: TableSelection) {\n        const clonedVTable = new VTable(table as HTMLTableElement);\n        clonedVTable.selection = selection;\n        removeCellsOutsideSelection(clonedVTable);\n        clonedVTable.writeBack();\n        return createRange(clonedVTable.table);\n    }\n\n    private deleteTableContent(\n        editor: IEditor,\n        table: HTMLTableElement,\n        selection: TableSelection\n    ) {\n        const selectedVTable = new VTable(table);\n        selectedVTable.selection = selection;\n\n        forEachSelectedCell(selectedVTable, cell => {\n            if (cell?.td) {\n                cell.td.innerHTML = editor.getTrustedHTMLHandler()('<br>');\n            }\n        });\n\n        const wholeTableSelected = isWholeTableSelected(selectedVTable, selection);\n        const isWholeColumnSelected =\n            table.rows.length - 1 === selection.lastCell.y && selection.firstCell.y === 0;\n        if (wholeTableSelected) {\n            selectedVTable.edit(TableOperation.DeleteTable);\n            selectedVTable.writeBack();\n        } else if (isWholeColumnSelected) {\n            selectedVTable.edit(TableOperation.DeleteColumn);\n            selectedVTable.writeBack();\n        }\n        if (wholeTableSelected || isWholeColumnSelected) {\n            table.style.removeProperty('width');\n            table.style.removeProperty('height');\n        }\n    }\n\n    private deleteImage(editor: IEditor, imageId: string) {\n        editor.queryElements('#' + imageId, node => {\n            editor.deleteNode(node);\n        });\n    }\n}\n"]}