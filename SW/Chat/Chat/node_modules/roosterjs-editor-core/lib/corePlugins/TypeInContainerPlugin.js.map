{"version":3,"file":"TypeInContainerPlugin.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-core/lib/corePlugins/TypeInContainerPlugin.ts"],"names":[],"mappings":";;AAEA,6DAM8B;AAE9B;;;GAGG;AACH;IAAA;QACY,WAAM,GAAmB,IAAI,CAAC;IAmF1C,CAAC;IAjFG;;OAEG;IACH,uCAAO,GAAP;QACI,OAAO,iBAAiB,CAAC;IAC7B,CAAC;IAED;;;OAGG;IACH,0CAAU,GAAV,UAAW,MAAe;QACtB,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;IACzB,CAAC;IAED;;OAEG;IACH,uCAAO,GAAP;QACI,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;IACvB,CAAC;IAEO,4CAAY,GAApB,UAAqB,KAAY;QAC7B,IACI,KAAK,CAAC,SAAS;YACf,KAAK,CAAC,cAAc,CAAC,QAAQ,KAAK,IAAI,CAAC,YAAY;YACnD,IAAA,mCAAY,EAAC,KAAK,CAAC,cAAc,CAAC,IAAI,KAAK;YAC3C,CAAC,KAAK,CAAC,cAAc,CAAC,UAAU,EAClC;YACE,OAAO,IAAI,CAAC;SACf;QACD,OAAO,KAAK,CAAC;IACjB,CAAC;IAED;;;OAGG;IACH,6CAAa,GAAb,UAAc,KAAkB;QAAhC,iBA0CC;;QAzCG,+DAA+D;QAC/D,+EAA+E;QAC/E,IACI,KAAK,CAAC,SAAS,oBAA4B;YAC3C,IAAI,CAAC,MAAM;YACX,CAAC,CAAC,KAAK,CAAC,QAAQ,IAAI,IAAA,0CAAmB,EAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,EAC1D;YACE,yDAAyD;YACzD,sFAAsF;YACtF,EAAE;YACF,yFAAyF;YACzF,kFAAkF;YAClF,EAAE;YACF,yEAAyE;YACzE,IAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,iBAAiB,EAAE,CAAC;YAE9C,IAAM,cAAc,GAChB,KAAK;gBACL,IAAA,iDAA0B,EAAC,KAAK,CAAC,cAAc,EAAE,SAAS,CAAC,UAAU,EAAE,SAAS,CAAC,CAAC;YAEtF,IAAI,CAAC,KAAK,IAAI,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,IAAI,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC,EAAE;gBAC/E,OAAO;aACV;YAED,IAAI,KAAK,CAAC,SAAS,EAAE;gBACjB,IAAI,CAAC,MAAM,CAAC,qBAAqB,CAAC,+BAAQ,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE,KAAK,CAAC,QAAQ,CAAC,CAAC;aAC/E;iBAAM;gBACH,IAAM,QAAQ,GAAG;;oBACb,IAAM,eAAe,GAAG,MAAA,KAAI,CAAC,MAAM,0CAAE,kBAAkB,EAAE,CAAC;oBAC1D,IAAI,eAAe,EAAE;wBACjB,MAAA,KAAI,CAAC,MAAM,0CAAE,qBAAqB,CAAC,eAAe,EAAE,KAAK,CAAC,QAAQ,CAAC,CAAC;qBACvE;gBACL,CAAC,CAAC;gBAEF,IAAI,8BAAO,CAAC,gBAAgB,EAAE;oBAC1B,MAAA,IAAI,CAAC,MAAM,CAAC,WAAW,EAAE,CAAC,WAAW,0CAAE,UAAU,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC;iBACpE;qBAAM;oBACH,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;iBAClC;aACJ;SACJ;IACL,CAAC;IACL,4BAAC;AAAD,CAAC,AApFD,IAoFC","sourcesContent":["import { PluginEventType } from 'roosterjs-editor-types';\nimport type { EditorPlugin, IEditor, PluginEvent } from 'roosterjs-editor-types';\nimport {\n    Browser,\n    findClosestElementAncestor,\n    getTagOfNode,\n    isCtrlOrMetaPressed,\n    Position,\n} from 'roosterjs-editor-dom';\n\n/**\n * @internal\n * Typing Component helps to ensure typing is always happening under a DOM container\n */\nexport default class TypeInContainerPlugin implements EditorPlugin {\n    private editor: IEditor | null = null;\n\n    /**\n     * Get a friendly name of  this plugin\n     */\n    getName() {\n        return 'TypeInContainer';\n    }\n\n    /**\n     * Initialize this plugin. This should only be called from Editor\n     * @param editor Editor instance\n     */\n    initialize(editor: IEditor) {\n        this.editor = editor;\n    }\n\n    /**\n     * Dispose this plugin\n     */\n    dispose() {\n        this.editor = null;\n    }\n\n    private isRangeEmpty(range: Range) {\n        if (\n            range.collapsed &&\n            range.startContainer.nodeType === Node.ELEMENT_NODE &&\n            getTagOfNode(range.startContainer) == 'DIV' &&\n            !range.startContainer.firstChild\n        ) {\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * Handle events triggered from editor\n     * @param event PluginEvent object\n     */\n    onPluginEvent(event: PluginEvent) {\n        // We need to check if the ctrl key or the meta key is pressed,\n        // browsers like Safari fire the \"keypress\" event when the meta key is pressed.\n        if (\n            event.eventType == PluginEventType.KeyPress &&\n            this.editor &&\n            !(event.rawEvent && isCtrlOrMetaPressed(event.rawEvent))\n        ) {\n            // If normalization was not possible before the keypress,\n            // check again after the keyboard event has been processed by browser native behavior.\n            //\n            // This handles the case where the keyboard event that first inserts content happens when\n            // there is already content under the selection (e.g. Ctrl+a -> type new content).\n            //\n            // Only schedule when the range is not collapsed to catch this edge case.\n            const range = this.editor.getSelectionRange();\n\n            const styledAncestor =\n                range &&\n                findClosestElementAncestor(range.startContainer, undefined /* root */, '[style]');\n\n            if (!range || (!this.isRangeEmpty(range) && this.editor.contains(styledAncestor))) {\n                return;\n            }\n\n            if (range.collapsed) {\n                this.editor.ensureTypeInContainer(Position.getStart(range), event.rawEvent);\n            } else {\n                const callback = () => {\n                    const focusedPosition = this.editor?.getFocusedPosition();\n                    if (focusedPosition) {\n                        this.editor?.ensureTypeInContainer(focusedPosition, event.rawEvent);\n                    }\n                };\n\n                if (Browser.isMobileOrTablet) {\n                    this.editor.getDocument().defaultView?.setTimeout(callback, 100);\n                } else {\n                    this.editor.runAsync(callback);\n                }\n            }\n        }\n    }\n}\n"]}