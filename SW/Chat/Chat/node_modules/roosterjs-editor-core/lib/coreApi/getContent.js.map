{"version":3,"file":"getContent.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-core/lib/coreApi/getContent.ts"],"names":[],"mappings":";;;AAEA,6DAM8B;AAG9B;;;;;;GAMG;AACI,IAAM,UAAU,GAAe,UAClC,IAAgB,EAChB,IAA+C;IAE/C,IAAI,OAAO,GAAkB,EAAE,CAAC;IAChC,IAAM,0BAA0B,GAAG,IAAI,qBAA4B,CAAC;IACpE,IAAM,sBAAsB,GAAG,IAAI,gCAAuC,CAAC;IAE3E,+GAA+G;IAC/G,uEAAuE;IACvE,IAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,kBAAkB,IAAI,IAAI,CAAC,UAAU,CAAC;IAElE,IAAI,IAAI,yBAAgC,EAAE;QACtC,OAAO,GAAG,IAAI,CAAC,WAAW,CAAC;KAC9B;SAAM,IAAI,IAAI,qBAA4B,EAAE;QACzC,OAAO,GAAG,IAAA,qCAAc,EAAC,IAAI,CAAC,CAAC;KAClC;SAAM;QACH,IAAM,UAAU,GAAG,SAAS,CAAC,IAAI,CAAC,CAAC;QACnC,UAAU,CAAC,SAAS,EAAE,CAAC;QAEvB,IAAM,aAAa,GAAG,IAAI,CAAC,GAAG,CAAC,iBAAiB,CAAC,IAAI,EAAE,IAAI,CAAC,mBAAmB,CAAC,CAAC;QACjF,IAAM,IAAI,GAAG,CAAC,sBAAsB;YAChC,CAAC,CAAC,IAAI;YACN,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,kBAAkB;gBACnC,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,uBAAuB;gBACxC,CAAC,CAAC,aAAa;oBACf,CAAC,CAAC,IAAA,uCAAgB,EAAC,IAAI,CAAC,UAAU,EAAE,aAAa,CAAC;oBAClD,CAAC,CAAC,IAAI,CAAC;QACX,IAAM,KAAK,GAAG,IAAI,IAAI,IAAA,kCAAW,EAAC,UAAU,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC;QAEpE,IAAI,CAAC,GAAG,CAAC,cAAc,CACnB,IAAI,EACJ,UAAU,EACV,KAAK,CAAC,eAAe,EACrB,IAAI,CAAC,YAAY,uBAEjB,IAAI,CAAC,kBAAkB,EACvB,IAAI,CAAC,SAAS,CAAC,UAAU,CAC5B,CAAC;QAEF,IAAI,0BAA0B,EAAE;YAC5B,IAAI,CAAC,GAAG,CAAC,YAAY,CACjB,IAAI,EACJ;gBACI,SAAS,+BAAuC;gBAChD,UAAU,YAAA;aACb,EACD,IAAI,CAAC,aAAa,CACrB,CAAC;YAEF,OAAO,GAAG,UAAU,CAAC,SAAS,CAAC;SAClC;aAAM,IAAI,KAAK,EAAE;YACd,oFAAoF;YACpF,OAAO,GAAG,IAAA,+CAAwB,EAAC,UAAU,EAAE,KAAK,CAAC,CAAC;SACzD;aAAM;YACH,OAAO,GAAG,UAAU,CAAC,SAAS,CAAC;SAClC;KACJ;IAED,OAAO,OAAO,aAAP,OAAO,cAAP,OAAO,GAAI,EAAE,CAAC;AACzB,CAAC,CAAC;AA5DW,QAAA,UAAU,cA4DrB;AAEF,SAAS,SAAS,CAAC,IAAoC;IACnD,IAAI,UAAuB,CAAC;IAC5B,IAAI,IAAA,qCAAc,EAAC,IAAI,EAAE,kBAAkB,CAAC,EAAE;QAC1C,UAAU,GAAG,IAAI,CAAC,aAAa,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QACrD,UAAU,CAAC,WAAW,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;KACzD;SAAM;QACH,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,QAAQ,CAAgB,CAAC;KAC7D;IAED,OAAO,UAAU,CAAC;AACtB,CAAC","sourcesContent":["import { ColorTransformDirection, GetContentMode, PluginEventType } from 'roosterjs-editor-types';\nimport type { EditorCore, GetContent } from 'roosterjs-editor-types';\nimport {\n    createRange,\n    getHtmlWithSelectionPath,\n    getSelectionPath,\n    getTextContent,\n    safeInstanceOf,\n} from 'roosterjs-editor-dom';\nimport type { CompatibleGetContentMode } from 'roosterjs-editor-types/lib/compatibleTypes';\n\n/**\n * @internal\n * Get current editor content as HTML string\n * @param core The EditorCore object\n * @param mode specify what kind of HTML content to retrieve\n * @returns HTML string representing current editor content\n */\nexport const getContent: GetContent = (\n    core: EditorCore,\n    mode: GetContentMode | CompatibleGetContentMode\n): string => {\n    let content: string | null = '';\n    const triggerExtractContentEvent = mode == GetContentMode.CleanHTML;\n    const includeSelectionMarker = mode == GetContentMode.RawHTMLWithSelection;\n\n    // When there is fragment for shadow edit, always use the cached fragment as document since HTML node in editor\n    // has been changed by uncommitted shadow edit which should be ignored.\n    const root = core.lifecycle.shadowEditFragment || core.contentDiv;\n\n    if (mode == GetContentMode.PlainTextFast) {\n        content = root.textContent;\n    } else if (mode == GetContentMode.PlainText) {\n        content = getTextContent(root);\n    } else {\n        const clonedRoot = cloneNode(root);\n        clonedRoot.normalize();\n\n        const originalRange = core.api.getSelectionRange(core, true /*tryGetFromCache*/);\n        const path = !includeSelectionMarker\n            ? null\n            : core.lifecycle.shadowEditFragment\n            ? core.lifecycle.shadowEditSelectionPath\n            : originalRange\n            ? getSelectionPath(core.contentDiv, originalRange)\n            : null;\n        const range = path && createRange(clonedRoot, path.start, path.end);\n\n        core.api.transformColor(\n            core,\n            clonedRoot,\n            false /*includeSelf*/,\n            null /*callback*/,\n            ColorTransformDirection.DarkToLight,\n            true /*forceTransform*/,\n            core.lifecycle.isDarkMode\n        );\n\n        if (triggerExtractContentEvent) {\n            core.api.triggerEvent(\n                core,\n                {\n                    eventType: PluginEventType.ExtractContentWithDom,\n                    clonedRoot,\n                },\n                true /*broadcast*/\n            );\n\n            content = clonedRoot.innerHTML;\n        } else if (range) {\n            // range is not null, which means we want to include a selection path in the content\n            content = getHtmlWithSelectionPath(clonedRoot, range);\n        } else {\n            content = clonedRoot.innerHTML;\n        }\n    }\n\n    return content ?? '';\n};\n\nfunction cloneNode(node: HTMLElement | DocumentFragment): HTMLElement {\n    let clonedNode: HTMLElement;\n    if (safeInstanceOf(node, 'DocumentFragment')) {\n        clonedNode = node.ownerDocument.createElement('div');\n        clonedNode.appendChild(node.cloneNode(true /*deep*/));\n    } else {\n        clonedNode = node.cloneNode(true /*deep*/) as HTMLElement;\n    }\n\n    return clonedNode;\n}\n"]}