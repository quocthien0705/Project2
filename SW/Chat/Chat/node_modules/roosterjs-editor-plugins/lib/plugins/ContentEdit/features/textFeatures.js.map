{"version":3,"file":"textFeatures.js","sourceRoot":"","sources":["../../../../../../packages/roosterjs-editor-plugins/lib/plugins/ContentEdit/features/textFeatures.ts"],"names":[],"mappings":"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","sourcesContent":["import { setIndentation } from 'roosterjs-editor-api';\nimport {\n    createRange,\n    getEntitySelector,\n    getTagOfNode,\n    Position,\n    queryElements,\n} from 'roosterjs-editor-dom';\nimport type {\n    BuildInEditFeature,\n    IEditor,\n    TextFeatureSettings,\n    PluginKeyboardEvent,\n    NodePosition,\n} from 'roosterjs-editor-types';\nimport {\n    Indentation,\n    Keys,\n    SelectionRangeTypes,\n    ContentPosition,\n    PositionType,\n    ExperimentalFeatures,\n    QueryScope,\n} from 'roosterjs-editor-types';\n\nconst TAB_SPACES = 6;\n\n/**\n * Requires @see ExperimentalFeatures.TabKeyTextFeatures to be enabled\n * Provides additional functionality when press Tab:\n *      If Whole Paragraph selected, indent paragraph,\n *      If range is collapsed, add tab spaces\n *      If range is not collapsed but not all the paragraph is selected, replace selection with Tab spaces\n *      If there are more than one block in the selection, indent all selection\n */\nconst IndentWhenTabText: BuildInEditFeature<PluginKeyboardEvent> = {\n    keys: [Keys.TAB],\n    shouldHandleEvent: (event, editor) => {\n        if (\n            editor.isFeatureEnabled(ExperimentalFeatures.TabKeyTextFeatures) &&\n            !event.rawEvent.shiftKey\n        ) {\n            const activeElement = editor.getDocument().activeElement as HTMLElement;\n            const listOrTable = editor.getElementAtCursor(\n                'LI,TABLE',\n                undefined /*startFrom*/,\n                event\n            );\n            const entity = editor.getElementAtCursor(\n                getEntitySelector(),\n                undefined /*startFrom*/,\n                event\n            );\n\n            return (\n                !listOrTable &&\n                (entity ? entity.isContentEditable : activeElement.isContentEditable)\n            );\n        }\n\n        return false;\n    },\n    handleEvent: (event, editor) => {\n        const selection = editor.getSelectionRangeEx();\n        if (selection.type == SelectionRangeTypes.Normal) {\n            editor.addUndoSnapshot(() => {\n                if (selection.areAllCollapsed) {\n                    insertTab(editor, event);\n                } else {\n                    const { ranges } = selection;\n                    const range = ranges[0];\n                    if (shouldSetIndentation(editor, range)) {\n                        setIndentation(editor, Indentation.Increase);\n                    } else {\n                        const tempRange = createRange(range.startContainer, range.startOffset);\n                        ranges.forEach(range => range.deleteContents());\n                        editor.select(tempRange);\n                        insertTab(editor, event);\n                    }\n                }\n            });\n\n            event.rawEvent.preventDefault();\n        }\n    },\n};\n\n/**\n * Requires @see ExperimentalFeatures.TabKeyTextFeatures to be enabled\n * If Whole Paragraph selected, outdent paragraph on Tab press\n */\nconst OutdentWhenTabText: BuildInEditFeature<PluginKeyboardEvent> = {\n    keys: [Keys.TAB],\n    shouldHandleEvent: (event, editor) => {\n        if (\n            event.rawEvent.shiftKey &&\n            editor.isFeatureEnabled(ExperimentalFeatures.TabKeyTextFeatures)\n        ) {\n            const selection = editor.getSelectionRangeEx();\n\n            return (\n                selection.type == SelectionRangeTypes.Normal &&\n                !selection.areAllCollapsed &&\n                editor.getElementAtCursor('blockquote', undefined, event) &&\n                !editor.getElementAtCursor('LI,TABLE', undefined /*startFrom*/, event) &&\n                shouldSetIndentation(editor, selection.ranges[0])\n            );\n        }\n\n        return false;\n    },\n    handleEvent: (event, editor) => {\n        editor.addUndoSnapshot(() => setIndentation(editor, Indentation.Decrease));\n\n        event.rawEvent.preventDefault();\n    },\n};\n\n/**\n * @deprecated\n * Automatically transform -- into hyphen, if typed between two words.\n */\nconst AutoHyphen: BuildInEditFeature<PluginKeyboardEvent> = {\n    keys: [],\n    shouldHandleEvent: (event, editor) => {\n        return false;\n    },\n    handleEvent: (event, editor) => {\n        return false;\n    },\n    defaultDisabled: true,\n};\n\n/**\n * @internal\n */\nexport const TextFeatures: Record<\n    keyof TextFeatureSettings,\n    BuildInEditFeature<PluginKeyboardEvent>\n> = {\n    indentWhenTabText: IndentWhenTabText,\n    outdentWhenTabText: OutdentWhenTabText,\n    autoHyphen: AutoHyphen,\n};\n\nfunction shouldSetIndentation(editor: IEditor, range: Range): boolean {\n    let result: boolean = false;\n\n    const startPosition: NodePosition = Position.getStart(range);\n    const endPosition: NodePosition = Position.getEnd(range);\n    const firstBlock = editor.getBlockElementAtNode(startPosition.node);\n    const lastBlock = editor.getBlockElementAtNode(endPosition.node);\n\n    if (!firstBlock || !lastBlock) {\n        return false;\n    }\n\n    if (!firstBlock.equals(lastBlock)) {\n        //If the selections has more than one block, we indent all the blocks in the selection\n        return true;\n    } else {\n        //We only indent a single block if all the block is selected.\n        const blockStart = new Position(firstBlock.getStartNode(), PositionType.Begin);\n        const blockEnd = new Position(firstBlock.getEndNode(), PositionType.End);\n\n        const rangeBefore = createRange(blockStart, Position.getStart(range));\n        const rangeAfter = createRange(Position.getEnd(range), blockEnd);\n\n        if (!result && isRangeEmpty(rangeBefore) && isRangeEmpty(rangeAfter)) {\n            result = true;\n        }\n\n        return result;\n    }\n}\n\nfunction isRangeEmpty(range: Range) {\n    return (\n        range.toString() == '' &&\n        queryElements(\n            range.commonAncestorContainer as ParentNode,\n            'img,table,ul,ol',\n            null,\n            QueryScope.InSelection,\n            range\n        ).length == 0\n    );\n}\n\nfunction insertTab(editor: IEditor, event: PluginKeyboardEvent) {\n    const span = editor.getDocument().createElement('span');\n    const searcher = editor.getContentSearcherOfCursor(event);\n    if (!searcher) {\n        return;\n    }\n    const charsBefore = searcher.getSubStringBefore(Number.MAX_SAFE_INTEGER);\n    const numberOfChars = TAB_SPACES - (charsBefore.length % TAB_SPACES);\n    let span2: HTMLSpanElement | null = null;\n\n    let textContent = '';\n    for (let index = 0; index < numberOfChars; index++) {\n        textContent += '&ensp;';\n    }\n    editor.insertNode(span);\n    if (span.nextElementSibling && getTagOfNode(span.nextElementSibling) == 'A') {\n        span2 = editor.getDocument().createElement('span');\n        span2.textContent = ' ';\n        editor.insertNode(span2);\n        editor.select(createRange(span2, PositionType.Before));\n    }\n    editor.insertContent(textContent, {\n        position: ContentPosition.Range,\n        range: createRange(span, PositionType.Begin),\n        updateCursor: false,\n    });\n    editor.select(createRange(span, PositionType.After));\n    if (span2) {\n        editor.deleteNode(span2);\n    }\n}\n"]}