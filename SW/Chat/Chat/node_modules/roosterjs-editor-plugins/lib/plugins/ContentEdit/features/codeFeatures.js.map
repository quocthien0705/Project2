{"version":3,"file":"codeFeatures.js","sourceRoot":"","sources":["../../../../../../packages/roosterjs-editor-plugins/lib/plugins/ContentEdit/features/codeFeatures.ts"],"names":[],"mappings":"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","sourcesContent":["import { Keys, PositionType, QueryScope } from 'roosterjs-editor-types';\nimport {\n    isNodeEmpty,\n    cacheGetEventData,\n    safeInstanceOf,\n    splitBalancedNodeRange,\n    unwrap,\n} from 'roosterjs-editor-dom';\nimport type {\n    BuildInEditFeature,\n    PluginKeyboardEvent,\n    IEditor,\n    CodeFeatureSettings,\n} from 'roosterjs-editor-types';\n\nconst RemoveCodeWhenEnterOnEmptyLine: BuildInEditFeature<PluginKeyboardEvent> = {\n    keys: [Keys.ENTER],\n    shouldHandleEvent: (event, editor) => {\n        const childOfCode = cacheGetCodeChild(event, editor);\n        return childOfCode && isNodeEmpty(childOfCode);\n    },\n    handleEvent: (event, editor) => {\n        event.rawEvent.preventDefault();\n        editor.addUndoSnapshot(\n            () => {\n                splitCode(event, editor);\n            },\n            undefined /* changeSource */,\n            true /* canUndoByBackspace */\n        );\n    },\n};\n\nconst RemoveCodeWhenBackspaceOnEmptyFirstLine: BuildInEditFeature<PluginKeyboardEvent> = {\n    keys: [Keys.BACKSPACE],\n    shouldHandleEvent: (event, editor) => {\n        const childOfCode = cacheGetCodeChild(event, editor);\n        return childOfCode && isNodeEmpty(childOfCode) && !childOfCode.previousSibling;\n    },\n    handleEvent: (event, editor) => {\n        event.rawEvent.preventDefault();\n        editor.addUndoSnapshot(() => splitCode(event, editor));\n    },\n};\n\nfunction cacheGetCodeChild(event: PluginKeyboardEvent, editor: IEditor): Node | null {\n    return cacheGetEventData(event, 'CODE_CHILD', () => {\n        const codeElement =\n            editor.getElementAtCursor('code') ??\n            editor.queryElements('code', QueryScope.OnSelection)[0];\n        if (codeElement) {\n            const pos = editor.getFocusedPosition();\n            const block = pos && editor.getBlockElementAtNode(pos.normalize().node);\n            if (block) {\n                const node =\n                    block.getStartNode() == codeElement.parentNode\n                        ? block.getStartNode()\n                        : block.collapseToSingleElement();\n                return isNodeEmpty(node) ? node : null;\n            }\n        }\n\n        return null;\n    });\n}\n\nfunction splitCode(event: PluginKeyboardEvent, editor: IEditor) {\n    const currentContainer = cacheGetCodeChild(event, editor);\n    if (!safeInstanceOf(currentContainer, 'HTMLElement')) {\n        return;\n    }\n    const codeChild = currentContainer.querySelector('code');\n    if (!codeChild) {\n        const codeParent = splitBalancedNodeRange(currentContainer);\n        if (codeParent) {\n            unwrap(codeParent);\n        }\n        if (safeInstanceOf(currentContainer.parentElement, 'HTMLPreElement')) {\n            const preParent = splitBalancedNodeRange(currentContainer);\n            if (preParent) {\n                unwrap(preParent);\n            }\n        }\n    } else {\n        //Content model\n        unwrap(codeChild);\n    }\n    editor.select(currentContainer, PositionType.Begin);\n}\n\n/**\n * @internal\n */\nexport const CodeFeatures: Record<\n    keyof CodeFeatureSettings,\n    BuildInEditFeature<PluginKeyboardEvent>\n> = {\n    removeCodeWhenEnterOnEmptyLine: RemoveCodeWhenEnterOnEmptyLine,\n    removeCodeWhenBackspaceOnEmptyFirstLine: RemoveCodeWhenBackspaceOnEmptyFirstLine,\n};\n"]}