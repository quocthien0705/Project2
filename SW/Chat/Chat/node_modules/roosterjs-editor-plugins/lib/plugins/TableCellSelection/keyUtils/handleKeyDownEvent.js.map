{"version":3,"file":"handleKeyDownEvent.js","sourceRoot":"","sources":["../../../../../../packages/roosterjs-editor-plugins/lib/plugins/TableCellSelection/keyUtils/handleKeyDownEvent.ts"],"names":[],"mappings":"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","sourcesContent":["import { getCellAtCursor } from '../utils/getCellAtCursor';\nimport { getCellCoordinates } from '../utils/getCellCoordinates';\nimport { isAfter } from '../utils/isAfter';\nimport { Keys, PositionType, SelectionRangeTypes } from 'roosterjs-editor-types';\nimport { prepareSelection } from '../utils/prepareSelection';\nimport { selectTable } from '../utils/selectTable';\nimport { setData } from '../utils/setData';\nimport { TABLE_CELL_SELECTOR } from '../constants';\nimport { updateSelection } from '../utils/updateSelection';\nimport type { TableCellSelectionState } from '../TableCellSelectionState';\nimport {\n    contains,\n    createRange,\n    isCtrlOrMetaPressed,\n    Position,\n    safeInstanceOf,\n    VTable,\n} from 'roosterjs-editor-dom';\nimport type { Coordinates, IEditor, PluginKeyDownEvent } from 'roosterjs-editor-types';\n\n/**\n * @internal\n */\nexport function handleKeyDownEvent(\n    event: PluginKeyDownEvent,\n    state: TableCellSelectionState,\n    editor: IEditor\n) {\n    const { shiftKey, ctrlKey, metaKey, which, defaultPrevented } = event.rawEvent;\n    if ((shiftKey && (ctrlKey || metaKey)) || which == Keys.SHIFT || defaultPrevented) {\n        state.preventKeyUp = defaultPrevented;\n        return;\n    }\n\n    const range = editor.getSelectionRangeEx();\n    if (shiftKey) {\n        if (!state.firstTarget) {\n            const pos = editor.getFocusedPosition();\n            const cell = pos && getCellAtCursor(editor, pos.node);\n\n            state.firstTarget = cell;\n        }\n\n        //If first target is not a table cell, we should ignore this plugin\n        if (!safeInstanceOf(state.firstTarget, 'HTMLTableCellElement')) {\n            return;\n        }\n        editor.runAsync(editor => {\n            const pos = editor.getFocusedPosition();\n            const newTarget = state.tableSelection ? state.lastTarget : pos?.node;\n            if (newTarget) {\n                setData(newTarget, state, editor);\n            }\n\n            if (state.firstTable! == state.targetTable!) {\n                if (!shouldConvertToTableSelection(state, editor) && !state.tableSelection) {\n                    return;\n                }\n                //When selection start and end is inside of the same table\n                handleKeySelectionInsideTable(event, state, editor);\n            } else if (state.tableSelection) {\n                if (state.firstTable) {\n                    editor.select(state.firstTable, null /* coordinates */);\n                }\n                state.tableSelection = false;\n            }\n        });\n    } else if (\n        range?.type == SelectionRangeTypes.TableSelection &&\n        (!isCtrlOrMetaPressed(event.rawEvent) || which == Keys.HOME || which == Keys.END)\n    ) {\n        // Select all content in the first cell\n        const row = range.ranges[0];\n        const firstCell = row.startContainer.childNodes[row.startOffset];\n        const children = firstCell.childNodes;\n        const contentRange = createRange(children[0], children[children.length - 1]);\n        editor.select(contentRange);\n    }\n}\n\n/**\n * @internal\n */\nfunction handleKeySelectionInsideTable(\n    event: PluginKeyDownEvent,\n    state: TableCellSelectionState,\n    editor: IEditor\n) {\n    state.firstTarget = getCellAtCursor(editor, state.firstTarget);\n    state.lastTarget = getCellAtCursor(editor, state.lastTarget);\n\n    updateSelection(editor, state.firstTarget, 0);\n    state.vTable = state.vTable || new VTable(state.firstTable as HTMLTableElement);\n\n    const firstCell = getCellCoordinates(state.vTable, state.firstTarget as Element);\n    const lastCell = getNextTD(event, editor, state);\n\n    if (!firstCell || !lastCell) {\n        return;\n    }\n    state.vTable.selection = {\n        firstCell,\n        lastCell,\n    };\n\n    const { selection } = state.vTable;\n\n    if (\n        !selection.lastCell ||\n        (state.vTable.cells && selection.lastCell.y > state.vTable.cells.length - 1) ||\n        selection.lastCell.y == -1\n    ) {\n        //When selection is moving from inside of a table to outside\n        state.lastTarget = editor.getElementAtCursor(\n            TABLE_CELL_SELECTOR + ',div',\n            state.firstTable ?? undefined\n        );\n        if (safeInstanceOf(state.lastTarget, 'HTMLTableCellElement')) {\n            prepareSelection(state, editor);\n        } else {\n            const position =\n                state.targetTable &&\n                new Position(\n                    state.targetTable,\n                    selection.lastCell.y == null || selection.lastCell.y == -1\n                        ? PositionType.Before\n                        : PositionType.After\n                );\n\n            const sel = editor.getDocument().defaultView?.getSelection();\n            const { anchorNode, anchorOffset } = sel || {};\n            if (\n                sel &&\n                anchorNode &&\n                anchorOffset != undefined &&\n                anchorOffset != null &&\n                position\n            ) {\n                editor.select(sel.getRangeAt(0));\n                sel.setBaseAndExtent(anchorNode, anchorOffset, position.node, position.offset);\n                state.lastTarget = position.node;\n                event.rawEvent.preventDefault();\n                return;\n            }\n        }\n    }\n\n    selectTable(editor, state);\n\n    const isBeginAboveEnd = isAfter(state.firstTarget, state.lastTarget);\n    if (state.lastTarget) {\n        const targetPosition = new Position(\n            state.lastTarget,\n            isBeginAboveEnd ? PositionType.Begin : PositionType.End\n        );\n        updateSelection(editor, targetPosition.node, targetPosition.offset);\n    }\n\n    state.tableSelection = true;\n    event.rawEvent.preventDefault();\n}\n\nfunction getNextTD(\n    event: PluginKeyDownEvent,\n    editor: IEditor,\n    state: TableCellSelectionState\n): Coordinates | undefined {\n    state.lastTarget =\n        state.lastTarget && editor.getElementAtCursor(TABLE_CELL_SELECTOR, state.lastTarget);\n\n    if (safeInstanceOf(state.lastTarget, 'HTMLTableCellElement') && state.vTable?.cells) {\n        const coordinates = getCellCoordinates(state.vTable, state.lastTarget);\n\n        if (state.tableSelection && coordinates) {\n            switch (event.rawEvent.which) {\n                case Keys.RIGHT:\n                    coordinates.x += state.lastTarget.colSpan;\n                    if (state.vTable.cells[coordinates.y][coordinates.x] == null) {\n                        coordinates.x = state.vTable.cells[coordinates.y].length - 1;\n                        coordinates.y++;\n                    }\n                    break;\n                case Keys.LEFT:\n                    if (coordinates.x == 0) {\n                        coordinates.y--;\n                    } else {\n                        coordinates.x--;\n                    }\n                    break;\n                case Keys.UP:\n                    coordinates.y--;\n                    break;\n                case Keys.DOWN:\n                    coordinates.y++;\n                    break;\n            }\n        }\n\n        if (coordinates && coordinates.y >= 0 && coordinates.x >= 0) {\n            state.lastTarget = state.vTable.getTd(coordinates.y, coordinates.x);\n        }\n        return coordinates;\n    }\n    return undefined;\n}\n\nfunction shouldConvertToTableSelection(state: TableCellSelectionState, editor: IEditor) {\n    if (!state.firstTable || !editor) {\n        return false;\n    }\n    const regions = editor.getSelectedRegions();\n    if (regions.length == 1) {\n        return false;\n    }\n\n    let result = true;\n\n    regions.forEach(value => {\n        if (!contains(state.firstTable, value.rootNode)) {\n            result = false;\n        }\n    });\n\n    return result;\n}\n"]}