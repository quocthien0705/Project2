{"version":3,"file":"autoLinkFeatures.js","sourceRoot":"","sources":["../../../../../../packages/roosterjs-editor-plugins/lib/plugins/ContentEdit/features/autoLinkFeatures.ts"],"names":[],"mappings":"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","sourcesContent":["import { ChangeSource, Keys, PluginEventType } from 'roosterjs-editor-types';\nimport { removeLink, replaceWithNode } from 'roosterjs-editor-api';\nimport type {\n    AutoLinkFeatureSettings,\n    BuildInEditFeature,\n    ClipboardData,\n    IEditor,\n    LinkData,\n    PluginEvent,\n    PluginKeyboardEvent,\n} from 'roosterjs-editor-types';\nimport {\n    cacheGetEventData,\n    clearEventDataCache,\n    LinkInlineElement,\n    matchLink,\n} from 'roosterjs-editor-dom';\n\n/**\n * When user type, they may end a link with a punctuation, i.e. www.bing.com;\n * we need to trim off the trailing punctuation before turning it to link match\n */\nconst TRAILING_PUNCTUATION_REGEX = /[.+=\\s:;\"',>]+$/i;\nconst MINIMUM_LENGTH = 5;\n\n/**\n * AutoLink edit feature, provides the ability to automatically convert text user typed or pasted\n * in hyperlink format into a real hyperlink\n */\nconst AutoLink: BuildInEditFeature<PluginEvent> = {\n    keys: [Keys.ENTER, Keys.SPACE, Keys.CONTENTCHANGED],\n    shouldHandleEvent: cacheGetLinkData,\n    handleEvent: autoLink,\n};\n\n/**\n * UnlinkWhenBackspaceAfterLink edit feature, provides the ability to convert a hyperlink back into text\n * if user presses BACKSPACE right after a hyperlink\n */\nconst UnlinkWhenBackspaceAfterLink: BuildInEditFeature<PluginKeyboardEvent> = {\n    keys: [Keys.BACKSPACE],\n    shouldHandleEvent: hasLinkBeforeCursor,\n    handleEvent: (event, editor) => {\n        event.rawEvent.preventDefault();\n        removeLink(editor);\n    },\n    defaultDisabled: true,\n};\n\nfunction cacheGetLinkData(event: PluginEvent, editor: IEditor): LinkData | null {\n    return event.eventType == PluginEventType.KeyDown ||\n        (event.eventType == PluginEventType.ContentChanged && event.source == ChangeSource.Paste)\n        ? cacheGetEventData(event, 'LINK_DATA', () => {\n              // First try to match link from the whole paste string from the plain text in clipboard.\n              // This helps when we paste a link next to some existing character, and the text we got\n              // from clipboard will only contain what we pasted, any existing characters will not\n              // be included.\n              const clipboardData =\n                  (event.eventType == PluginEventType.ContentChanged &&\n                      event.source == ChangeSource.Paste &&\n                      (event.data as ClipboardData)) ||\n                  null;\n              const link = matchLink((clipboardData?.text || '').trim());\n              const searcher = editor.getContentSearcherOfCursor(event);\n\n              // In case the matched link is already inside a <A> tag, we do a range search.\n              // getRangeFromText will return null if the given text is already in a LinkInlineElement\n              if (link && searcher?.getRangeFromText(link.originalUrl, false /*exactMatch*/)) {\n                  return link;\n              }\n\n              const word = searcher && searcher.getWordBefore();\n              if (word && word.length > MINIMUM_LENGTH) {\n                  // Check for trailing punctuation\n                  const trailingPunctuations = word.match(TRAILING_PUNCTUATION_REGEX);\n                  const trailingPunctuation = (trailingPunctuations || [])[0] || '';\n                  let candidate = word.substring(0, word.length - trailingPunctuation.length);\n\n                  // Do special handling for ')', '}', ']'\n                  ['()', '{}', '[]'].forEach(str => {\n                      if (\n                          candidate[candidate.length - 1] == str[1] &&\n                          candidate.indexOf(str[0]) < 0\n                      ) {\n                          candidate = candidate.substr(0, candidate.length - 1);\n                      }\n                  });\n\n                  // Match and replace in editor\n                  return matchLink(candidate);\n              }\n              return null;\n          })\n        : null;\n}\n\nfunction hasLinkBeforeCursor(event: PluginKeyboardEvent, editor: IEditor): boolean {\n    const contentSearcher = editor.getContentSearcherOfCursor(event);\n    const inline = contentSearcher?.getInlineElementBefore();\n    return inline instanceof LinkInlineElement;\n}\n\nfunction autoLink(event: PluginEvent, editor: IEditor) {\n    const linkData = cacheGetLinkData(event, editor);\n    if (!linkData) {\n        return;\n    }\n    const anchor = editor.getDocument().createElement('a');\n    // Need to get searcher before we enter the async callback since the callback can happen when cursor is moved to next line\n    // and at that time a new searcher won't be able to find the link text to replace\n    const searcher = editor.getContentSearcherOfCursor();\n    anchor.textContent = linkData.originalUrl;\n    anchor.href = linkData.normalizedUrl;\n\n    editor.runAsync(editor => {\n        editor.addUndoSnapshot(\n            () => {\n                replaceWithNode(\n                    editor,\n                    linkData.originalUrl,\n                    anchor,\n                    false /* exactMatch */,\n                    searcher ?? undefined\n                );\n\n                // The content at cursor has changed. Should also clear the cursor data cache\n                clearEventDataCache(event);\n                return anchor;\n            },\n            ChangeSource.AutoLink,\n            true /*canUndoByBackspace*/\n        );\n    });\n}\n\n/**\n * @internal\n */\nexport const AutoLinkFeatures: Record<\n    keyof AutoLinkFeatureSettings,\n    BuildInEditFeature<PluginEvent>\n> = {\n    autoLink: AutoLink,\n    unlinkWhenBackspaceAfterLink: UnlinkWhenBackspaceAfterLink as BuildInEditFeature<PluginEvent>,\n};\n"]}