{"version":3,"file":"handleLineMerge.js","sourceRoot":"","sources":["../../../../../../packages/roosterjs-editor-plugins/lib/plugins/Paste/lineMerge/handleLineMerge.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n    changeElementTag,\n    ContentTraverser,\n    findClosestElementAncestor,\n    getBlockElementAtNode,\n    getNextLeafSibling,\n    getPreviousLeafSibling,\n    getTagOfNode,\n} from 'roosterjs-editor-dom';\n\n/**\n * @internal\n * Process pasted content, if there are multiple blocks that are not wrapped by a shared ancestor node,\n * change the tag of first and last node to be SPAN so that it will be merged into current block\n * @param root Root node of content to process\n */\nexport default function handleLineMerge(root: Node) {\n    const traverser = ContentTraverser.createBodyTraverser(root);\n    const blocks: { start: Node; end: Node }[] = [];\n\n    for (\n        let block = traverser?.currentBlockElement;\n        block;\n        block = traverser.getNextBlockElement()\n    ) {\n        blocks.push({\n            start: block.getStartNode(),\n            end: block.getEndNode(),\n        });\n    }\n\n    if (blocks.length > 0) {\n        const blocksLength = blocks.length - 1;\n        processBlock(blocks[0]);\n        processBlock(blocks[blocksLength]);\n        checkAndAddBr(root, blocks[0], true /*isFirst*/);\n        checkAndAddBr(root, blocks[blocksLength], false /*isFirst*/, blocks[0]);\n    }\n}\n\nfunction processBlock(block: { start: Node; end: Node }) {\n    const { start, end } = block;\n\n    if (start == end && getTagOfNode(start) == 'DIV') {\n        const node = changeElementTag(start as HTMLElement, 'SPAN') as Node;\n        block.start = node;\n        block.end = node;\n\n        if (node && node.lastChild && getTagOfNode(node.lastChild) == 'BR') {\n            node.removeChild(node.lastChild);\n        }\n    } else if (getTagOfNode(end) == 'BR') {\n        const node = end.ownerDocument?.createTextNode('');\n        if (node) {\n            end.parentNode?.insertBefore(node, end);\n            block.end = node;\n            end.parentNode?.removeChild(end);\n        }\n    }\n}\n\nfunction checkAndAddBr(\n    root: Node,\n    block: { start: Node; end: Node },\n    isFirst: boolean,\n    firstBlock?: { start: Node; end: Node }\n) {\n    const blockElement = getBlockElementAtNode(root, block.start);\n    const sibling = isFirst\n        ? getNextLeafSibling(root, block.end)\n        : getPreviousLeafSibling(root, block.start);\n\n    if (!sibling) {\n        return;\n    }\n\n    if (blockElement?.contains(sibling)) {\n        const br = block.start.ownerDocument?.createElement('br');\n        if (br) {\n            const blockToUse = isFirst ? block.end : block.start;\n            blockToUse.parentNode?.insertBefore(br, isFirst ? block.end.nextSibling : block.start);\n        }\n    } else if (\n        firstBlock &&\n        firstBlock.end == firstBlock.start &&\n        getTagOfNode(firstBlock.end) == 'SPAN'\n    ) {\n        // If the first block and the last block are Siblings, add a BR before so the only two\n        // lines that are being pasted are not merged.\n        const previousSibling = getPreviousLeafSibling(root, block.start);\n        if (\n            firstBlock.end.contains(previousSibling) &&\n            !findClosestElementAncestor(block.start, root, 'li')\n        ) {\n            const br = block.start.ownerDocument?.createElement('br');\n            if (br) {\n                block.start.parentNode?.insertBefore(br, block.start);\n            }\n        }\n    }\n}\n"]}