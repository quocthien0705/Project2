{"version":3,"file":"CustomReplace.js","sourceRoot":"","sources":["../../../../../packages/roosterjs-editor-plugins/lib/plugins/CustomReplace/CustomReplace.ts"],"names":[],"mappings":"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","sourcesContent":["import { PluginEventType, PositionType } from 'roosterjs-editor-types';\nimport type { CustomReplacement, EditorPlugin, IEditor, PluginEvent } from 'roosterjs-editor-types';\n\nconst makeReplacement = (\n    sourceString: string,\n    replacementHTML: string,\n    matchSourceCaseSensitive: boolean,\n    shouldReplace?: (\n        replacement: CustomReplacement,\n        content: string,\n        sourceEditor?: IEditor\n    ) => boolean\n): CustomReplacement => ({\n    sourceString,\n    replacementHTML,\n    matchSourceCaseSensitive,\n    shouldReplace,\n});\n\nconst defaultReplacements: CustomReplacement[] = [\n    makeReplacement(':)', '🙂', true),\n    makeReplacement(';)', '😉', true),\n    makeReplacement(':O', '😲', true),\n    makeReplacement(':o', '😯', true),\n    makeReplacement('<3', '❤️', true),\n];\n\n/**\n * Wrapper for CustomReplaceContentEditFeature that provides an API for updating the\n * content edit feature\n */\nexport default class CustomReplacePlugin implements EditorPlugin {\n    private longestReplacementLength: number | null = null;\n    private editor: IEditor | null = null;\n    private replacements: CustomReplacement[] | null = null;\n    private replacementEndCharacters: Set<string> | null = null;\n\n    /**\n     * Create instance of CustomReplace plugin\n     * @param replacements Replacement rules. If not passed, a default replacement rule set will be applied\n     */\n    constructor(replacements: CustomReplacement[] = defaultReplacements) {\n        this.updateReplacements(replacements);\n    }\n\n    /**\n     * Set the replacements that this plugin is looking for.\n     * @param newReplacements new set of replacements for this plugin\n     */\n    updateReplacements(newReplacements: CustomReplacement[]) {\n        this.replacements = newReplacements;\n        this.longestReplacementLength = getLongestReplacementSourceLength(this.replacements);\n        this.replacementEndCharacters = getReplacementEndCharacters(this.replacements);\n    }\n\n    /**\n     * Get a friendly name of this plugin\n     */\n    getName() {\n        return 'CustomReplace';\n    }\n\n    /**\n     * Initialize this plugin\n     * @param editor The editor instance\n     */\n    public initialize(editor: IEditor): void {\n        this.editor = editor;\n    }\n\n    /**\n     * Dispose this plugin\n     */\n    public dispose(): void {\n        this.editor = null;\n    }\n\n    /**\n     * Handle events triggered from editor\n     * @param event PluginEvent object\n     */\n    public onPluginEvent(event: PluginEvent) {\n        if (event.eventType != PluginEventType.Input || !this.editor || this.editor.isInIME()) {\n            return;\n        }\n\n        // Exit early on input events that do not insert a replacement's final character.\n        if (!event.rawEvent.data || !this.replacementEndCharacters?.has(event.rawEvent.data)) {\n            return;\n        }\n\n        // Get the matching replacement\n        const searcher = this.editor.getContentSearcherOfCursor(event);\n        if (!searcher || this.longestReplacementLength == null) {\n            return;\n        }\n        const stringToSearch = searcher.getSubStringBefore(this.longestReplacementLength);\n\n        const replacement = this.getMatchingReplacement(stringToSearch);\n\n        if (\n            !replacement ||\n            (replacement.shouldReplace &&\n                searcher &&\n                !replacement.shouldReplace(replacement, searcher.getWordBefore(), this.editor))\n        ) {\n            return;\n        }\n\n        // Reconstruct a selection of the text on the document that matches the\n        // replacement we selected.\n        const matchingText = searcher.getSubStringBefore(replacement.sourceString.length);\n        const matchingRange = searcher.getRangeFromText(matchingText, true /* exactMatch */);\n\n        // parse the html string off the dom and inline the resulting element.\n        const document = this.editor.getDocument();\n        const parsingSpan = document.createElement('span');\n        parsingSpan.innerHTML = this.editor.getTrustedHTMLHandler()(replacement.replacementHTML);\n        const nodeToInsert =\n            parsingSpan.childNodes.length == 1 ? parsingSpan.childNodes[0] : parsingSpan;\n\n        // Switch the node for the selection range\n        if (matchingRange) {\n            this.editor.addUndoSnapshot(\n                () => {\n                    matchingRange.deleteContents();\n                    matchingRange.insertNode(nodeToInsert);\n                    this.editor?.select(nodeToInsert, PositionType.End);\n                },\n                undefined /*changeSource*/,\n                true /*canUndoByBackspace*/\n            );\n        }\n    }\n\n    private getMatchingReplacement(stringToSearch: string): CustomReplacement | null {\n        if (stringToSearch.length == 0 || !this.replacements) {\n            return null;\n        }\n        const originalStringToSearch = stringToSearch.replace(/\\s/g, ' ');\n        const lowerCaseStringToSearch = originalStringToSearch.toLocaleLowerCase();\n        for (const replacement of this.replacements) {\n            const [sourceMatch, replacementMatch] = replacement.matchSourceCaseSensitive\n                ? [originalStringToSearch, replacement.sourceString]\n                : [lowerCaseStringToSearch, replacement.sourceString.toLocaleLowerCase()];\n\n            if (\n                sourceMatch.substring(sourceMatch.length - replacementMatch.length) ==\n                replacementMatch\n            ) {\n                return replacement;\n            }\n        }\n        return null;\n    }\n}\n\nfunction getLongestReplacementSourceLength(replacements: CustomReplacement[]): number {\n    return Math.max.apply(\n        null,\n        replacements.map(replacement => replacement.sourceString.length)\n    );\n}\n\nfunction getReplacementEndCharacters(replacements: CustomReplacement[]): Set<string> {\n    const endChars = new Set<string>();\n    for (const replacement of replacements) {\n        const sourceString = replacement.sourceString;\n        if (sourceString.length == 0) {\n            continue;\n        }\n        const lastChar = sourceString[sourceString.length - 1];\n        if (!replacement.matchSourceCaseSensitive) {\n            endChars.add(lastChar.toLocaleLowerCase());\n            endChars.add(lastChar.toLocaleUpperCase());\n        } else {\n            endChars.add(lastChar);\n        }\n    }\n    return endChars;\n}\n"]}