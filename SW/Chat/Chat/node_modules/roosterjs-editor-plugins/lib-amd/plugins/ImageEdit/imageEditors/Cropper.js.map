{"version":3,"file":"Cropper.js","sourceRoot":"","sources":["../../../../../../packages/roosterjs-editor-plugins/lib/plugins/ImageEdit/imageEditors/Cropper.ts"],"names":[],"mappings":";;;;IAeA;;;OAGG;IACU,QAAA,OAAO,GAAqD;QACrE,WAAW,EAAE,UAAC,EAAY;gBAAV,QAAQ,cAAA;YAAO,OAAA,2BAAM,QAAQ,EAAG;QAAjB,CAAiB;QAChD,UAAU,EAAE,UAAC,EAA2B,EAAE,CAAC,EAAE,IAAI,EAAE,EAAE,EAAE,EAAE;;gBAA1C,QAAQ,cAAA,EAAE,CAAC,OAAA,EAAE,CAAC,OAAA,EAAE,OAAO,aAAA;YAClC,KAAA,oBAAW,IAAA,0BAAgB,EAAC,EAAE,EAAE,EAAE,EAAE,QAAQ,CAAC,QAAQ,CAAC,IAAA,EAArD,EAAE,QAAA,EAAE,EAAE,QAAA,CAAgD;YAGnD,IAAA,OAAO,GAMP,QAAQ,QAND,EACP,QAAQ,GAKR,QAAQ,SALA,EACR,WAAW,GAIX,QAAQ,YAJG,EACX,YAAY,GAGZ,QAAQ,aAHI,EACZ,UAAU,GAEV,QAAQ,WAFE,EACV,aAAa,GACb,QAAQ,cADK,CACJ;YACL,IAAA,QAAQ,GAAgB,OAAO,SAAvB,EAAE,SAAS,GAAK,OAAO,UAAZ,CAAa;YACxC,IAAM,YAAY,GAAG,CAAC,GAAG,WAAW,GAAG,YAAY,CAAC;YACpD,IAAM,aAAa,GAAG,CAAC,GAAG,UAAU,GAAG,aAAa,CAAC;YAErD,IACI,YAAY,GAAG,CAAC;gBAChB,aAAa,GAAG,CAAC;gBACjB,QAAQ,KAAK,SAAS;gBACtB,SAAS,KAAK,SAAS,EACzB;gBACE,IAAM,SAAS,GAAG,OAAO,GAAG,YAAY,CAAC;gBACzC,IAAM,UAAU,GAAG,QAAQ,GAAG,aAAa,CAAC;gBAC5C,IAAM,OAAO,GACT,CAAC,IAAI,GAAG;oBACJ,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,EAAE,EAAE,SAAS,EAAE,YAAY,EAAE,QAAQ,CAAC;oBAC/D,CAAC,CAAC,WAAW,CAAC;gBACtB,IAAM,QAAQ,GACV,CAAC,IAAI,GAAG;oBACJ,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC,EAAE,EAAE,SAAS,EAAE,WAAW,EAAE,QAAQ,CAAC;oBAChE,CAAC,CAAC,YAAY,CAAC;gBACvB,IAAM,MAAM,GACR,CAAC,IAAI,GAAG;oBACJ,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,EAAE,EAAE,UAAU,EAAE,aAAa,EAAE,SAAS,CAAC;oBACjE,CAAC,CAAC,UAAU,CAAC;gBACrB,IAAM,SAAS,GACX,CAAC,IAAI,GAAG;oBACJ,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC,EAAE,EAAE,UAAU,EAAE,UAAU,EAAE,SAAS,CAAC;oBAClE,CAAC,CAAC,aAAa,CAAC;gBAExB,QAAQ,CAAC,WAAW,GAAG,OAAO,CAAC;gBAC/B,QAAQ,CAAC,YAAY,GAAG,QAAQ,CAAC;gBACjC,QAAQ,CAAC,UAAU,GAAG,MAAM,CAAC;gBAC7B,QAAQ,CAAC,aAAa,GAAG,SAAS,CAAC;gBACnC,QAAQ,CAAC,OAAO,GAAG,SAAS,GAAG,CAAC,CAAC,GAAG,OAAO,GAAG,QAAQ,CAAC,CAAC;gBACxD,QAAQ,CAAC,QAAQ,GAAG,UAAU,GAAG,CAAC,CAAC,GAAG,MAAM,GAAG,SAAS,CAAC,CAAC;gBAE1D,OAAO,IAAI,CAAC;aACf;iBAAM;gBACH,OAAO,KAAK,CAAC;aAChB;QACL,CAAC;KACJ,CAAC;IAEF,SAAS,IAAI,CACT,cAAsB,EACtB,UAAkB,EAClB,SAAiB,EACjB,iBAAyB,EACzB,QAAgB;QAEhB,IAAM,QAAQ,GAAG,SAAS,GAAG,CAAC,CAAC,GAAG,iBAAiB,CAAC,GAAG,QAAQ,CAAC;QAChE,IAAM,QAAQ,GAAG,SAAS,GAAG,cAAc,GAAG,UAAU,CAAC;QACzD,IAAM,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;QAC7D,OAAO,UAAU,GAAG,SAAS,CAAC;IAClC,CAAC;IAED;;;OAGG;IACH,SAAgB,WAAW;QACvB,IAAM,WAAW,GAAsB;YACnC,GAAG,EAAE,KAAK;YACV,KAAK,EAAE,uEAAuE;YAC9E,SAAS,6BAAmC;SAC/C,CAAC;QACF,IAAM,aAAa,GAAsB;YACrC,GAAG,EAAE,KAAK;YACV,KAAK,EAAE,mCAAmC;YAC1C,SAAS,+BAAqC;YAC9C,QAAQ,EAAE,EAAE;SACf,CAAC;QACF,IAAI,aAAa,EAAE;YACf,mBAAO,CAAC,OAAO,CAAC,UAAA,CAAC;gBACb,OAAA,mBAAO,CAAC,OAAO,CAAC,UAAA,CAAC,YAAI,OAAA,MAAA,aAAa,CAAC,QAAQ,0CAAE,IAAI,CAAC,mBAAmB,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAA,EAAA,CAAC;YAA7E,CAA6E,CAChF,CAAC;SACL;QACD,OAAO,CAAC,aAAa,EAAE,WAAW,EAAE,WAAW,EAAE,WAAW,EAAE,WAAW,CAAC,CAAC;IAC/E,CAAC;IAlBD,kCAkBC;IAED,SAAS,mBAAmB,CAAC,CAAgB,EAAE,CAAgB;QAC3D,IAAM,WAAW,GAAG,CAAC,IAAI,GAAG,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,OAAO,CAAC;QAChD,IAAM,WAAW,GAAG,CAAC,IAAI,GAAG,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,QAAQ,CAAC;QAChD,IAAM,QAAQ,GAAG,oBAAQ,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;QAEjC,OAAO;YACH,GAAG,EAAE,KAAK;YACV,SAAS,4BAAkC;YAC3C,KAAK,EAAE,kDAAgD,CAAC,GAAG,CAAC,gBAAW,WAAW,WAAM,WAAW,iBAAY,4BAAgB,kBAAa,4BAAgB,4BAAuB,QAAQ,SAAM;YACjM,OAAO,EAAE,EAAE,CAAC,GAAA,EAAE,CAAC,GAAA,EAAE;YACjB,QAAQ,EAAE,iBAAiB,EAAE;SAChC,CAAC;IACN,CAAC;IAED,SAAS,iBAAiB;QACtB,IAAM,MAAM,GAAwB,EAAE,CAAC;QACvC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,UAAA,KAAK;YAChB,OAAA,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,UAAA,GAAG;gBACd,MAAM,CAAC,IAAI,CAAC,yBAAyB,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC,CAAC;YACvD,CAAC,CAAC;QAFF,CAEE,CACL,CAAC;QACF,OAAO,MAAM,CAAC;IAClB,CAAC;IAED,SAAS,yBAAyB,CAAC,KAAa,EAAE,GAAW;QACzD,IAAM,QAAQ,GACV,GAAG,IAAI,CAAC;YACJ,CAAC,CAAC,WAAS,KAAK,mBAAa,6BAAiB,GAAG,KAAK,GAAG,CAAC,SAAK;YAC/D,CAAC,CAAC,SAAO,KAAK,kBAAY,6BAAiB,GAAG,KAAK,GAAG,CAAC,SAAK,CAAC;QACrE,IAAM,OAAO,GAAG,KAAK,IAAI,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC;QAE/C,OAAO;YACH,GAAG,EAAE,KAAK;YACV,KAAK,EAAE,4BAA0B,KAAK,kBAAa,KAAK,WAAM,QAAQ,0BAAqB,OAAS;SACvG,CAAC;IACN,CAAC","sourcesContent":["import { ImageEditElementClass } from '../types/ImageEditElementClass';\nimport { rotateCoordinate } from './Resizer';\nimport type { DNDDirectionX, DnDDirectionY } from '../types/DragAndDropContext';\nimport type DragAndDropContext from '../types/DragAndDropContext';\nimport type DragAndDropHandler from '../../../pluginUtils/DragAndDropHandler';\nimport type { CreateElementData } from 'roosterjs-editor-types';\nimport type { CropInfo } from '../types/ImageEditInfo';\nimport {\n    CROP_HANDLE_SIZE,\n    CROP_HANDLE_WIDTH,\n    ROTATION,\n    XS_CROP,\n    YS_CROP,\n} from '../constants/constants';\n\n/**\n * @internal\n * Crop handle for DragAndDropHelper\n */\nexport const Cropper: DragAndDropHandler<DragAndDropContext, CropInfo> = {\n    onDragStart: ({ editInfo }) => ({ ...editInfo }),\n    onDragging: ({ editInfo, x, y, options }, e, base, dx, dy) => {\n        [dx, dy] = rotateCoordinate(dx, dy, editInfo.angleRad);\n\n        const {\n            widthPx,\n            heightPx,\n            leftPercent,\n            rightPercent,\n            topPercent,\n            bottomPercent,\n        } = editInfo;\n        const { minWidth, minHeight } = options;\n        const widthPercent = 1 - leftPercent - rightPercent;\n        const heightPercent = 1 - topPercent - bottomPercent;\n\n        if (\n            widthPercent > 0 &&\n            heightPercent > 0 &&\n            minWidth !== undefined &&\n            minHeight !== undefined\n        ) {\n            const fullWidth = widthPx / widthPercent;\n            const fullHeight = heightPx / heightPercent;\n            const newLeft =\n                x != 'e'\n                    ? crop(base.leftPercent, dx, fullWidth, rightPercent, minWidth)\n                    : leftPercent;\n            const newRight =\n                x != 'w'\n                    ? crop(base.rightPercent, -dx, fullWidth, leftPercent, minWidth)\n                    : rightPercent;\n            const newTop =\n                y != 's'\n                    ? crop(base.topPercent, dy, fullHeight, bottomPercent, minHeight)\n                    : topPercent;\n            const newBottom =\n                y != 'n'\n                    ? crop(base.bottomPercent, -dy, fullHeight, topPercent, minHeight)\n                    : bottomPercent;\n\n            editInfo.leftPercent = newLeft;\n            editInfo.rightPercent = newRight;\n            editInfo.topPercent = newTop;\n            editInfo.bottomPercent = newBottom;\n            editInfo.widthPx = fullWidth * (1 - newLeft - newRight);\n            editInfo.heightPx = fullHeight * (1 - newTop - newBottom);\n\n            return true;\n        } else {\n            return false;\n        }\n    },\n};\n\nfunction crop(\n    basePercentage: number,\n    deltaValue: number,\n    fullValue: number,\n    currentPercentage: number,\n    minValue: number\n): number {\n    const maxValue = fullValue * (1 - currentPercentage) - minValue;\n    const newValue = fullValue * basePercentage + deltaValue;\n    const validValue = Math.max(Math.min(newValue, maxValue), 0);\n    return validValue / fullValue;\n}\n\n/**\n * @internal\n * Get HTML for crop elements, including 4 overlays (to show dark shadow), 1 container and 4 crop handles\n */\nexport function getCropHTML(): CreateElementData[] {\n    const overlayHTML: CreateElementData = {\n        tag: 'div',\n        style: 'position:absolute;background-color:rgb(0,0,0,0.5);pointer-events:none',\n        className: ImageEditElementClass.CropOverlay,\n    };\n    const containerHTML: CreateElementData = {\n        tag: 'div',\n        style: 'position:absolute;overflow:hidden',\n        className: ImageEditElementClass.CropContainer,\n        children: [],\n    };\n    if (containerHTML) {\n        XS_CROP.forEach(x =>\n            YS_CROP.forEach(y => containerHTML.children?.push(getCropHTMLInternal(x, y)))\n        );\n    }\n    return [containerHTML, overlayHTML, overlayHTML, overlayHTML, overlayHTML];\n}\n\nfunction getCropHTMLInternal(x: DNDDirectionX, y: DnDDirectionY): CreateElementData {\n    const leftOrRight = x == 'w' ? 'left' : 'right';\n    const topOrBottom = y == 'n' ? 'top' : 'bottom';\n    const rotation = ROTATION[y + x];\n\n    return {\n        tag: 'div',\n        className: ImageEditElementClass.CropHandle,\n        style: `position:absolute;pointer-events:auto;cursor:${y}${x}-resize;${leftOrRight}:0;${topOrBottom}:0;width:${CROP_HANDLE_SIZE}px;height:${CROP_HANDLE_SIZE}px;transform:rotate(${rotation}deg)`,\n        dataset: { x, y },\n        children: getCropHandleHTML(),\n    };\n}\n\nfunction getCropHandleHTML(): CreateElementData[] {\n    const result: CreateElementData[] = [];\n    [0, 1].forEach(layer =>\n        [0, 1].forEach(dir => {\n            result.push(getCropHandleHTMLInternal(layer, dir));\n        })\n    );\n    return result;\n}\n\nfunction getCropHandleHTMLInternal(layer: number, dir: number): CreateElementData {\n    const position =\n        dir == 0\n            ? `right:${layer}px;height:${CROP_HANDLE_WIDTH - layer * 2}px;`\n            : `top:${layer}px;width:${CROP_HANDLE_WIDTH - layer * 2}px;`;\n    const bgColor = layer == 0 ? 'white' : 'black';\n\n    return {\n        tag: 'div',\n        style: `position:absolute;left:${layer}px;bottom:${layer}px;${position};background-color:${bgColor}`,\n    };\n}\n"]}