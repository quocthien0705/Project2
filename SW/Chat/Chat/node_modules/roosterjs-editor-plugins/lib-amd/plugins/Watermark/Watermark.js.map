{"version":3,"file":"Watermark.js","sourceRoot":"","sources":["../../../../../packages/roosterjs-editor-plugins/lib/plugins/Watermark/Watermark.ts"],"names":[],"mappings":"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","sourcesContent":["import { applyFormat, getEntitySelector, getTagOfNode } from 'roosterjs-editor-dom';\r\nimport { ContentPosition, EntityOperation, PluginEventType } from 'roosterjs-editor-types';\r\nimport { insertEntity } from 'roosterjs-editor-api';\r\nimport type {\r\n    DefaultFormat,\r\n    EditorPlugin,\r\n    Entity,\r\n    IEditor,\r\n    PluginEvent,\r\n} from 'roosterjs-editor-types';\r\n\r\nconst ENTITY_TYPE = 'WATERMARK_WRAPPER';\r\n\r\n/**\r\n * A watermark plugin to manage watermark string for roosterjs\r\n */\r\nexport default class Watermark implements EditorPlugin {\r\n    private editor: IEditor | null = null;\r\n    private disposer: (() => void) | null = null;\r\n    private format: DefaultFormat;\r\n\r\n    /**\r\n     * Create an instance of Watermark plugin\r\n     * @param watermark The watermark string\r\n     */\r\n    constructor(private watermark: string, format?: DefaultFormat, private customClass?: string) {\r\n        this.format = format || {\r\n            fontSize: '14px',\r\n            textColors: {\r\n                lightModeColor: '#AAAAAA',\r\n                darkModeColor: '#6B6B6B',\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Updates the watermark text.\r\n     * @param watermark - The new watermark text.\r\n     */\r\n    updateWatermark(watermark: string) {\r\n        this.watermark = watermark;\r\n\r\n        if (!this.editor) {\r\n            return;\r\n        }\r\n        const watermarks = this.editor.queryElements(getEntitySelector(ENTITY_TYPE));\r\n        const isShowing = watermarks.length > 0;\r\n        // re-render watermark only if it's already displayed\r\n        if (isShowing) {\r\n            // hide watermark\r\n            const watermarks = this.editor.queryElements(getEntitySelector(ENTITY_TYPE));\r\n            watermarks.forEach(this.removeWatermark);\r\n            // show watermark\r\n            this.showHideWatermark();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get a friendly name of  this plugin\r\n     */\r\n    getName() {\r\n        return 'Watermark';\r\n    }\r\n\r\n    /**\r\n     * Initialize this plugin. This should only be called from Editor\r\n     * @param editor Editor instance\r\n     */\r\n    initialize(editor: IEditor) {\r\n        this.editor = editor;\r\n        this.disposer = this.editor.addDomEventHandler({\r\n            focus: this.showHideWatermark,\r\n            blur: this.showHideWatermark,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Dispose this plugin\r\n     */\r\n    dispose() {\r\n        this.disposer?.();\r\n        this.disposer = null;\r\n        this.editor = null;\r\n    }\r\n\r\n    /**\r\n     * Handle events triggered from editor\r\n     * @param event PluginEvent object\r\n     */\r\n    onPluginEvent(event: PluginEvent) {\r\n        if (\r\n            event.eventType == PluginEventType.EditorReady ||\r\n            (event.eventType == PluginEventType.ContentChanged &&\r\n                (<Entity>event.data)?.type != ENTITY_TYPE)\r\n        ) {\r\n            this.showHideWatermark();\r\n        } else if (\r\n            event.eventType == PluginEventType.EntityOperation &&\r\n            event.entity.type == ENTITY_TYPE &&\r\n            this.editor\r\n        ) {\r\n            const {\r\n                operation,\r\n                entity: { wrapper },\r\n            } = event;\r\n            if (operation == EntityOperation.ReplaceTemporaryContent) {\r\n                this.removeWatermark(wrapper);\r\n            } else if (event.operation == EntityOperation.NewEntity) {\r\n                applyFormat(\r\n                    wrapper,\r\n                    this.format,\r\n                    this.editor.isDarkMode(),\r\n                    this.editor.getDarkColorHandler()\r\n                );\r\n                wrapper.spellcheck = false;\r\n            }\r\n        }\r\n    }\r\n\r\n    private showHideWatermark = () => {\r\n        if (!this.editor) {\r\n            return;\r\n        }\r\n        const hasFocus = this.editor.hasFocus();\r\n        const watermarks = this.editor.queryElements(getEntitySelector(ENTITY_TYPE));\r\n        const isShowing = watermarks.length > 0;\r\n\r\n        if (hasFocus && isShowing) {\r\n            watermarks.forEach(this.removeWatermark);\r\n            this.editor.focus();\r\n        } else if (!hasFocus && !isShowing && this.editor.isEmpty()) {\r\n            const newEntity = insertEntity(\r\n                this.editor,\r\n                ENTITY_TYPE,\r\n                this.editor.getDocument().createTextNode(this.watermark),\r\n                false /*isBlock*/,\r\n                false /*isReadonly*/,\r\n                ContentPosition.Begin\r\n            );\r\n            if (this.customClass) {\r\n                newEntity.wrapper.classList.add(this.customClass);\r\n            }\r\n        }\r\n    };\r\n\r\n    private removeWatermark = (wrapper: HTMLElement) => {\r\n        const parentNode = wrapper.parentNode;\r\n        parentNode?.removeChild(wrapper);\r\n\r\n        // After remove watermark node, if it leaves an empty DIV, append a BR node into it to make it a regular empty line\r\n        if (\r\n            parentNode &&\r\n            this.editor?.contains(parentNode) &&\r\n            getTagOfNode(parentNode) == 'DIV' &&\r\n            !parentNode.firstChild\r\n        ) {\r\n            parentNode.appendChild(this.editor.getDocument().createElement('BR'));\r\n        }\r\n    };\r\n}\r\n"]}