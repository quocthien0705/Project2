{"version":3,"file":"AnnouncePlugin.js","sourceRoot":"","sources":["../../../../../packages/roosterjs-editor-plugins/lib/plugins/Announce/AnnouncePlugin.ts"],"names":[],"mappings":"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","sourcesContent":["import { AnnounceFeatures } from './features/AnnounceFeatures';\nimport { createElement, getObjectKeys } from 'roosterjs-editor-dom';\nimport { PluginEventType } from 'roosterjs-editor-types';\nimport type { AnnounceFeatureKey } from './features/AnnounceFeatures';\nimport type { AnnounceFeature } from './AnnounceFeature';\nimport type { CompatibleKnownAnnounceStrings } from 'roosterjs-editor-types/lib/compatibleTypes';\nimport type {\n    EditorPlugin,\n    IEditor,\n    PluginEvent,\n    AnnounceData,\n    PluginKeyDownEvent,\n    KnownAnnounceStrings,\n} from 'roosterjs-editor-types';\n\nconst ARIA_LIVE_STYLE =\n    'clip: rect(0px, 0px, 0px, 0px); clip-path: inset(100%); height: 1px; overflow: hidden; position: absolute; white-space: nowrap; width: 1px;';\nconst ARIA_LIVE_ASSERTIVE = 'assertive';\nconst DIV_TAG = 'div';\nconst createAriaLiveElement = (document: Document): HTMLDivElement => {\n    const element = createElement(\n        {\n            tag: DIV_TAG,\n            style: ARIA_LIVE_STYLE,\n            attributes: {\n                'aria-live': ARIA_LIVE_ASSERTIVE,\n            },\n        },\n        document\n    ) as HTMLDivElement;\n\n    document.body.appendChild(element);\n\n    return element;\n};\n\n/**\n * Announce messages to screen reader by using aria live element.\n */\nexport default class Announce implements EditorPlugin {\n    private ariaLiveElement: HTMLDivElement | undefined;\n    private editor: IEditor | undefined;\n    private features: AnnounceFeature[];\n    private lastFocusedElement: HTMLElement | null = null;\n\n    constructor(\n        private stringsMapOrGetter?:\n            | Map<KnownAnnounceStrings | CompatibleKnownAnnounceStrings, string>\n            | ((key: KnownAnnounceStrings | CompatibleKnownAnnounceStrings) => string)\n            | undefined,\n        skipAnnounceFeatures: AnnounceFeatureKey[] = [],\n        additionalFeatures?: AnnounceFeature[]\n    ) {\n        this.features = getObjectKeys(AnnounceFeatures)\n            .map(key => {\n                if (skipAnnounceFeatures.indexOf(key) == -1) {\n                    return AnnounceFeatures[key];\n                }\n\n                return undefined;\n            })\n            .filter(feature => !!feature)\n            .concat(additionalFeatures || []) as AnnounceFeature[];\n    }\n\n    /**\n     * Get a friendly name of this plugin\n     */\n    getName() {\n        return 'Announce';\n    }\n\n    /**\n     * Initialize this plugin\n     * @param editor The editor instance\n     */\n    initialize(editor: IEditor) {\n        this.editor = editor;\n    }\n\n    /**\n     * Dispose this plugin\n     */\n    dispose() {\n        this.ariaLiveElement?.parentElement?.removeChild(this.ariaLiveElement);\n        this.ariaLiveElement = undefined;\n        this.stringsMapOrGetter = undefined;\n        this.lastFocusedElement = null;\n        while (this.features.length > 0) {\n            this.features.pop();\n        }\n        this.editor = undefined;\n    }\n\n    /**\n     * Handle events triggered from editor\n     * @param event PluginEvent object\n     */\n    onPluginEvent(ev: PluginEvent) {\n        if (\n            this.editor &&\n            ev.eventType == PluginEventType.ContentChanged &&\n            ev.additionalData?.getAnnounceData\n        ) {\n            const data = ev.additionalData.getAnnounceData();\n            if (data) {\n                this.announce(data, this.editor);\n            }\n        }\n\n        if (ev.eventType == PluginEventType.KeyDown && this.editor) {\n            this.handleFeatures(ev, this.editor);\n        }\n    }\n\n    private handleFeatures(event: PluginKeyDownEvent, editorInput: IEditor) {\n        editorInput.runAsync(editor => {\n            this.features\n                .filter(feature => feature.keys.indexOf(event.rawEvent.which) > -1)\n                .some(feature => {\n                    const announceData = feature.shouldHandle(editor, this.lastFocusedElement);\n                    if (announceData) {\n                        this.announce(announceData, editor);\n                    }\n                    return !!announceData;\n                });\n\n            this.lastFocusedElement = editor.getElementAtCursor();\n        });\n    }\n\n    protected announce(announceData: AnnounceData, editor: IEditor) {\n        const { text, defaultStrings, formatStrings = [] } = announceData;\n        const textToAnnounce = formatString(this.getString(defaultStrings) || text, formatStrings);\n        if (textToAnnounce) {\n            if (!this.ariaLiveElement || textToAnnounce == this.ariaLiveElement?.textContent) {\n                this.ariaLiveElement?.parentElement?.removeChild(this.ariaLiveElement);\n                this.ariaLiveElement = createAriaLiveElement(editor.getDocument());\n            }\n            if (this.ariaLiveElement) {\n                this.ariaLiveElement.textContent = textToAnnounce;\n            }\n        }\n    }\n\n    private getString(key: CompatibleKnownAnnounceStrings | KnownAnnounceStrings | undefined) {\n        if (this.stringsMapOrGetter == undefined || key == undefined) {\n            return undefined;\n        }\n\n        if (typeof this.stringsMapOrGetter === 'function') {\n            return this.stringsMapOrGetter(key);\n        } else {\n            return this.stringsMapOrGetter.get(key);\n        }\n    }\n\n    /**\n     * @internal\n     * Public only for unit testing.\n     * @returns\n     */\n    public getAriaLiveElement() {\n        return this.ariaLiveElement;\n    }\n}\n\nfunction formatString(text: string | undefined, formatStrings: string[]) {\n    if (text == undefined) {\n        return text;\n    }\n\n    formatStrings.forEach((value, index) => {\n        text = text?.replace(`{${index}}`, value);\n    });\n\n    return text;\n}\n"]}