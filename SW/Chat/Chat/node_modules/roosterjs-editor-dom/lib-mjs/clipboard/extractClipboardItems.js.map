{"version":3,"file":"extractClipboardItems.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-dom/lib/clipboard/extractClipboardItems.ts"],"names":[],"mappings":"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","sourcesContent":["import readFile from '../utils/readFile';\r\nimport { Browser } from '../utils/Browser';\r\nimport { ContentType, ContentTypePrefix } from 'roosterjs-editor-types';\r\nimport type {\r\n    ClipboardData,\r\n    EdgeLinkPreview,\r\n    ExtractClipboardItemsOption,\r\n} from 'roosterjs-editor-types';\r\n\r\n// HTML header to indicate where is the HTML content started from.\r\n// Sample header:\r\n// Version:0.9\r\n// StartHTML:71\r\n// EndHTML:170\r\n// StartFragment:140\r\n// EndFragment:160\r\n// StartSelection:140\r\n// EndSelection:160\r\nconst CLIPBOARD_HTML_HEADER_REGEX = /^Version:[0-9\\.]+\\s+StartHTML:\\s*([0-9]+)\\s+EndHTML:\\s*([0-9]+)\\s+/i;\r\nconst OTHER_TEXT_TYPE = ContentTypePrefix.Text + '*';\r\nconst EDGE_LINK_PREVIEW = 'link-preview';\r\nconst ContentHandlers: {\r\n    [contentType: string]: (data: ClipboardData, value: string, type?: string) => void;\r\n} = {\r\n    [ContentType.HTML]: (data, value) =>\r\n        (data.rawHtml = Browser.isEdge ? workaroundForEdge(value) : value),\r\n    [ContentType.PlainText]: (data, value) => (data.text = value),\r\n    [OTHER_TEXT_TYPE]: (data, value, type?) => !!type && (data.customValues[type] = value),\r\n    [ContentTypePrefix.Text + EDGE_LINK_PREVIEW]: tryParseLinkPreview,\r\n};\r\n\r\n/**\r\n * Extract clipboard items to be a ClipboardData object for IE\r\n * @param items The clipboard items retrieve from a DataTransfer object\r\n * @param callback Callback function when data is ready\r\n * @returns An object with the following properties:\r\n *  types: Available types from the clipboard event\r\n *  text: Plain text from the clipboard event\r\n *  image: Image file from the clipboard event\r\n *  html: Html string from the clipboard event. When set to null, it means there's no HTML found from the event.\r\n *   When set to undefined, it means can't retrieve HTML string, there may be HTML string but direct retrieving is\r\n *   not supported by browser.\r\n */\r\nexport default function extractClipboardItems(\r\n    items: DataTransferItem[],\r\n    options?: ExtractClipboardItemsOption,\r\n    pasteNativeEvent?: boolean\r\n): Promise<ClipboardData> {\r\n    const data: ClipboardData = {\r\n        types: [],\r\n        text: '',\r\n        image: null,\r\n        files: [],\r\n        rawHtml: null,\r\n        customValues: {},\r\n        pasteNativeEvent: pasteNativeEvent,\r\n    };\r\n\r\n    return Promise.all(\r\n        (items || []).map(item => {\r\n            const type = item.type;\r\n\r\n            if (type.indexOf(ContentTypePrefix.Image) == 0 && !data.image && item.kind == 'file') {\r\n                data.types.push(type);\r\n                data.image = item.getAsFile();\r\n                return new Promise<void>(resolve => {\r\n                    if (data.image) {\r\n                        readFile(data.image, dataUrl => {\r\n                            data.imageDataUri = dataUrl;\r\n                            resolve();\r\n                        });\r\n                    } else {\r\n                        resolve();\r\n                    }\r\n                });\r\n            } else if (item.kind == 'file') {\r\n                return new Promise<void>(resolve => {\r\n                    const file = item.getAsFile();\r\n                    if (!!file) {\r\n                        data.types.push(type);\r\n                        data.files!.push(file);\r\n                    }\r\n                    resolve();\r\n                });\r\n            } else {\r\n                const customType = getAllowedCustomType(type, options?.allowedCustomPasteType);\r\n                const handler =\r\n                    ContentHandlers[type] || (customType ? ContentHandlers[OTHER_TEXT_TYPE] : null);\r\n                return new Promise<void>(resolve =>\r\n                    handler\r\n                        ? item.getAsString(value => {\r\n                              data.types.push(type);\r\n                              handler(data, value, customType);\r\n                              resolve();\r\n                          })\r\n                        : resolve()\r\n                );\r\n            }\r\n        })\r\n    ).then(() => data);\r\n}\r\n\r\n/**\r\n * Edge sometimes doesn't remove the headers, which cause we paste more things then expected.\r\n * So we need to remove it in our code\r\n * @param html The HTML string got from clipboard\r\n */\r\nfunction workaroundForEdge(html: string) {\r\n    const headerValues = CLIPBOARD_HTML_HEADER_REGEX.exec(html);\r\n\r\n    if (headerValues?.length == 3) {\r\n        const start = parseInt(headerValues[1]);\r\n        const end = parseInt(headerValues[2]);\r\n        if (start > 0 && end > start) {\r\n            html = html.substring(start, end);\r\n        }\r\n    }\r\n\r\n    return html;\r\n}\r\n\r\nfunction tryParseLinkPreview(data: ClipboardData, value: string) {\r\n    try {\r\n        data.customValues[EDGE_LINK_PREVIEW] = value;\r\n        data.linkPreview = JSON.parse(value) as EdgeLinkPreview;\r\n    } catch {}\r\n}\r\n\r\nfunction getAllowedCustomType(type: string, allowedCustomPasteType?: string[]) {\r\n    const textType =\r\n        type.indexOf(ContentTypePrefix.Text) == 0\r\n            ? type.substring(ContentTypePrefix.Text.length)\r\n            : null;\r\n    const index =\r\n        allowedCustomPasteType && textType ? allowedCustomPasteType.indexOf(textType) : -1;\r\n    return textType && index >= 0 ? textType : undefined;\r\n}\r\n"]}