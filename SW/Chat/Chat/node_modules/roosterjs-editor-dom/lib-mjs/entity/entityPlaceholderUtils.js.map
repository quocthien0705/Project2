{"version":3,"file":"entityPlaceholderUtils.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-dom/lib/entity/entityPlaceholderUtils.ts"],"names":[],"mappings":"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","sourcesContent":["import getEntityFromElement from './getEntityFromElement';\nimport getEntitySelector from './getEntitySelector';\nimport safeInstanceOf from '../utils/safeInstanceOf';\nimport { EntityClasses } from 'roosterjs-editor-types';\nimport type { Entity, KnownEntityItem } from 'roosterjs-editor-types';\n\nconst EntityPlaceHolderTagName = 'ENTITY-PLACEHOLDER';\n\n/**\n * @deprecated\n * Create a placeholder comment node for entity\n * @param entity The entity to create placeholder from\n * @returns A placeholder comment node as\n */\nexport function createEntityPlaceholder(entity: Entity): HTMLElement {\n    const placeholder = entity.wrapper.ownerDocument.createElement(EntityPlaceHolderTagName);\n    placeholder.id = entity.id;\n\n    return placeholder;\n}\n\n/**\n * Move content from a container into a new Document fragment, and try keep entities to be reusable by creating placeholder\n * for them in the document fragment.\n * If an entity is directly under root container, the whole entity can be reused and no need to move it at all.\n * If an entity is not directly under root container, it is still reusable, but it may need some movement.\n * In any case, entities will be replaced with a placeholder in the target document fragment.\n * We will use an entity map (the \"entities\" parameter) to save the map from entity id to its wrapper element.\n * @param root The root element\n * @param entities A map from entity id to entity wrapper element\n * @returns A new document fragment contains all the content and entity placeholders\n */\nexport function moveContentWithEntityPlaceholders(\n    root: HTMLDivElement,\n    entities: Record<string, HTMLElement>\n) {\n    const entitySelector = getEntitySelector();\n    const fragment = root.ownerDocument.createDocumentFragment();\n    let next: Node | null = null;\n\n    for (let child: Node | null = root.firstChild; child; child = next) {\n        let entity: Entity | null;\n        let nodeToAppend = child;\n\n        next = child.nextSibling;\n\n        if (safeInstanceOf(child, 'HTMLElement')) {\n            if ((entity = getEntityFromElement(child))) {\n                nodeToAppend = getPlaceholder(entity, entities);\n            } else {\n                child.querySelectorAll<HTMLElement>(entitySelector).forEach(wrapper => {\n                    if ((entity = getEntityFromElement(wrapper))) {\n                        const placeholder = getPlaceholder(entity, entities);\n\n                        wrapper.parentNode?.replaceChild(placeholder, wrapper);\n                    }\n                });\n            }\n        }\n\n        fragment.appendChild(nodeToAppend);\n    }\n\n    fragment.normalize();\n\n    return fragment;\n}\n\n/**\n * Restore HTML content from a document fragment that may contain entity placeholders.\n * @param source Source document fragment that contains HTML content and entity placeholders\n * @param target Target container, usually to be editor root container\n * @param entities A map from entity id to entity wrapper, used for reusing existing DOM structure for entity\n * @param insertClonedNode When pass true, merge with a cloned copy of the nodes from source fragment rather than the nodes themselves @default false\n */\nexport function restoreContentWithEntityPlaceholder(\n    source: ParentNode,\n    target: HTMLElement,\n    entities: Record<string, HTMLElement | KnownEntityItem> | null,\n    insertClonedNode?: boolean\n) {\n    let anchor = target.firstChild;\n\n    const entitySelector = getEntitySelector();\n\n    for (let current = source.firstChild; current; ) {\n        const next = current.nextSibling;\n        const wrapper = tryGetWrapperFromEntityPlaceholder(entities, current);\n\n        if (wrapper) {\n            anchor = removeUntil(anchor, wrapper);\n\n            if (anchor) {\n                anchor = anchor.nextSibling;\n            } else {\n                target.appendChild(wrapper);\n            }\n        } else {\n            const nodeToInsert = insertClonedNode ? current.cloneNode(true /*deep*/) : current;\n            target.insertBefore(nodeToInsert, anchor);\n\n            if (safeInstanceOf(nodeToInsert, 'HTMLElement')) {\n                nodeToInsert.querySelectorAll(entitySelector).forEach(placeholder => {\n                    const wrapper = tryGetWrapperFromEntityPlaceholder(entities, placeholder);\n\n                    if (wrapper) {\n                        placeholder.parentNode?.replaceChild(wrapper, placeholder);\n                    }\n                });\n            }\n        }\n\n        current = next;\n    }\n\n    removeUntil(anchor);\n}\n\nfunction removeUntil(anchor: ChildNode | null, nodeToStop?: HTMLElement) {\n    while (anchor && (!nodeToStop || anchor != nodeToStop)) {\n        const nodeToRemove = anchor;\n        anchor = anchor.nextSibling;\n        nodeToRemove.parentNode?.removeChild(nodeToRemove);\n    }\n    return anchor;\n}\n\nfunction tryGetWrapperFromEntityPlaceholder(\n    entities: Record<string, HTMLElement | KnownEntityItem> | null,\n    node: Node\n): HTMLElement | null {\n    const id =\n        safeInstanceOf(node, 'HTMLElement') &&\n        node.classList.contains(EntityClasses.ENTITY_INFO_NAME) &&\n        getEntityFromElement(node as HTMLElement)?.id;\n    const item = id ? entities?.[id] : null;\n\n    return !item\n        ? null\n        : safeInstanceOf(item, 'HTMLElement')\n        ? item\n        : item?.canPersist\n        ? item.element\n        : null;\n}\n\nfunction getPlaceholder(entity: Entity, entities: Record<string, HTMLElement>) {\n    entities[entity.id] = entity.wrapper;\n\n    return entity.wrapper.cloneNode(true /*deep*/);\n}\n"]}