{"version":3,"file":"applyTextStyle.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-dom/lib/inlineElements/applyTextStyle.ts"],"names":[],"mappings":"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","sourcesContent":["import getTagOfNode from '../utils/getTagOfNode';\nimport Position from '../selection/Position';\nimport safeInstanceOf from '../utils/safeInstanceOf';\nimport splitTextNode from '../utils/splitTextNode';\nimport wrap from '../utils/wrap';\nimport { getNextLeafSibling } from '../utils/getLeafSibling';\nimport { NodeType, PositionType } from 'roosterjs-editor-types';\nimport { splitBalancedNodeRange } from '../utils/splitParentNode';\nimport type { NodePosition } from 'roosterjs-editor-types';\n\nconst STYLET_AGS = 'SPAN,B,I,U,EM,STRONG,STRIKE,S,SMALL,SUP,SUB'.split(',');\n\n/**\n * Apply style using a styler function to the given container node in the given range\n * @param container The container node to apply style to\n * @param styler The styler function\n * @param fromPosition From position\n * @param toPosition To position\n */\nexport default function applyTextStyle(\n    container: Node,\n    styler: (node: HTMLElement, isInnerNode?: boolean) => any,\n    from: NodePosition = new Position(container, PositionType.Begin).normalize(),\n    to: NodePosition = new Position(container, PositionType.End).normalize()\n) {\n    let formatNodes: Node[] = [];\n    let fromPosition: NodePosition | null = from;\n    const toPosition: NodePosition | null = to;\n\n    while (fromPosition && toPosition && toPosition.isAfter(fromPosition)) {\n        let formatNode = fromPosition.node;\n        const parentTag = getTagOfNode(formatNode.parentNode);\n\n        // The code below modifies DOM. Need to get the next sibling first otherwise you won't be able to reliably get a good next sibling node\n        const nextNode = getNextLeafSibling(container, formatNode);\n\n        if (formatNode.nodeType == NodeType.Text && ['TR', 'TABLE'].indexOf(parentTag) < 0) {\n            if (formatNode == toPosition.node && !toPosition.isAtEnd) {\n                formatNode = splitTextNode(\n                    <Text>formatNode,\n                    toPosition.offset,\n                    true /*returnFirstPart*/\n                );\n            }\n\n            if (fromPosition.offset > 0) {\n                formatNode = splitTextNode(\n                    <Text>formatNode,\n                    fromPosition.offset,\n                    false /*returnFirstPart*/\n                );\n            }\n\n            formatNodes.push(formatNode);\n        }\n\n        fromPosition = nextNode && new Position(nextNode, PositionType.Begin);\n    }\n\n    if (formatNodes.length > 0) {\n        if (formatNodes.every(node => node.parentNode == formatNodes[0].parentNode)) {\n            const newNode = formatNodes.shift()!;\n            formatNodes.forEach(node => {\n                const newNodeValue = (newNode.nodeValue || '') + (node.nodeValue || '');\n                newNode.nodeValue = newNodeValue;\n                node.parentNode?.removeChild(node);\n            });\n            formatNodes = [newNode];\n        }\n\n        formatNodes.forEach(startingNode => {\n            // When apply style within style tags like B/I/U/..., we split the tag and apply outside them\n            // So that the inner style tag such as U, STRIKE can inherit the style we added\n            let node: Node | null = startingNode;\n            while (\n                node &&\n                getTagOfNode(node) != 'SPAN' &&\n                STYLET_AGS.indexOf(getTagOfNode(node.parentNode)) >= 0\n            ) {\n                callStylerWithInnerNode(node, styler);\n                node = splitBalancedNodeRange(node);\n            }\n\n            if (node && getTagOfNode(node) != 'SPAN') {\n                callStylerWithInnerNode(node, styler);\n                node = wrap(node, 'SPAN');\n            }\n\n            if (safeInstanceOf(node, 'HTMLElement')) {\n                styler(node);\n            }\n        });\n    }\n}\n\nfunction callStylerWithInnerNode(\n    node: Node,\n    styler: (node: HTMLElement, isInnerNode?: boolean) => any\n) {\n    if (node && node.nodeType == NodeType.Element) {\n        styler(node as HTMLElement, true /*isInnerNode*/);\n    }\n}\n"]}