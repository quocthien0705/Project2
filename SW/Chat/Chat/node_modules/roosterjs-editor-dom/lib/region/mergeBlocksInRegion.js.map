{"version":3,"file":"mergeBlocksInRegion.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-dom/lib/region/mergeBlocksInRegion.ts"],"names":[],"mappings":";;;AAAA,8DAAyD;AACzD,8CAAyC;AACzC,gFAA2E;AAC3E,0FAAqF;AACrF,gDAA2C;AAC3C,mDAA8C;AAC9C,0DAAqD;AACrD,gDAA2C;AAC3C,wDAAkD;AAGlD;;;;;GAKG;AACH,SAAwB,mBAAmB,CAAC,MAAkB,EAAE,OAAa,EAAE,UAAgB;;IAC3F,IAAI,KAA0B,CAAC;IAE/B,IACI,CAAC,IAAA,wBAAc,EAAC,MAAM,EAAE,OAAO,CAAC;QAChC,CAAC,IAAA,wBAAc,EAAC,MAAM,EAAE,UAAU,CAAC;QACnC,CAAC,CAAC,KAAK,GAAG,IAAA,+BAAqB,EAAC,MAAM,CAAC,QAAQ,EAAE,UAAU,CAAC,CAAC;QAC7D,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,EACzB;QACE,OAAO;KACV;IAED,IAAM,SAAS,GAAG,KAAK,CAAC,uBAAuB,EAAE,CAAC;IAClD,IAAM,eAAe,GAAG,IAAA,wBAAQ,EAC5B,MAAM,CAAC,QAAQ,EACf,SAAS,EACT,OAAO,EACP,KAAK,CAAC,WAAW,EACjB,IAAI,CAAC,kBAAkB,CAC1B,CAAC;IAEF,6CAA6C;IAC7C,KAAK,IAAI,IAAI,GAAgB,SAAS,EAAE,IAAA,kBAAQ,EAAC,eAAe,EAAE,IAAI,CAAC,GAAI;QACvE,IAAM,QAAM,GAAgB,IAAK,CAAC,UAAU,CAAC;QAC7C,IAAI,IAAA,wBAAc,EAAC,QAAM,EAAE,aAAa,CAAC,EAAE;YACvC,IAAM,MAAM,yEACL,CAAC,IAAA,oCAA0B,EAAC,QAAM,CAAC,IAAI,EAAE,CAAC,GAC1C,IAAA,mBAAS,EAAC,QAAM,CAAC,GACjB,IAAA,mBAAS,EAAC,SAAS,CAAC,CAC1B,CAAC;YACF,IAAA,mBAAS,EAAC,SAAS,EAAE,MAAM,CAAC,CAAC;SAChC;QACD,IAAI,GAAG,QAAM,CAAC;KACjB;IAED,IAAI,YAAY,GAAgB,IAAI,CAAC;IACrC,IAAM,WAAW,GACb,SAAS,CAAC,UAAU,CAAC,MAAM,IAAI,CAAC,IAAI,SAAS,CAAC,UAAU,CAAC,MAAM,IAAI,CAAC;QAChE,CAAC,CAAC,SAAS,CAAC,UAAW;QACvB,CAAC,CAAC,IAAA,0BAAgB,EAAC,SAAS,EAAE,MAAM,CAAE,CAAC;IAE/C,oBAAoB;IACpB,KACI,IAAI,IAAI,GAAgB,WAAW,EACnC,IAAA,kBAAQ,EAAC,eAAe,EAAE,IAAI,CAAC,IAAI,CAAA,MAAA,IAAI,CAAC,UAAU,0CAAE,UAAU,CAAC,MAAM,KAAI,CAAC,EAC1E,IAAI,GAAG,IAAK,CAAC,UAAU,EACzB;QACE,8FAA8F;QAC9F,YAAY,GAAG,IAAI,CAAC,UAAU,CAAC;KAClC;IAED,gDAAgD;IAChD,MAAA,OAAO,CAAC,UAAU,0CAAE,YAAY,CAAC,WAAW,EAAE,OAAO,CAAC,WAAW,CAAC,CAAC;IACnE,MAAA,YAAY,aAAZ,YAAY,uBAAZ,YAAY,CAAE,UAAU,0CAAE,WAAW,CAAC,YAAY,CAAC,CAAC;AACxD,CAAC;AAtDD,sCAsDC","sourcesContent":["import changeElementTag from '../utils/changeElementTag';\nimport contains from '../utils/contains';\nimport getBlockElementAtNode from '../blockElements/getBlockElementAtNode';\nimport getPredefinedCssForElement from '../htmlSanitizer/getPredefinedCssForElement';\nimport getStyles from '../style/getStyles';\nimport isNodeInRegion from './isNodeInRegion';\nimport safeInstanceOf from '../utils/safeInstanceOf';\nimport setStyles from '../style/setStyles';\nimport { collapse } from '../utils/collapseNodes';\nimport type { BlockElement, RegionBase } from 'roosterjs-editor-types';\n\n/**\n * Merge a BlockElement of given node after another node\n * @param region Region to operate in\n * @param refNode The node to merge after\n * @param targetNode The node of target block element\n */\nexport default function mergeBlocksInRegion(region: RegionBase, refNode: Node, targetNode: Node) {\n    let block: BlockElement | null;\n\n    if (\n        !isNodeInRegion(region, refNode) ||\n        !isNodeInRegion(region, targetNode) ||\n        !(block = getBlockElementAtNode(region.rootNode, targetNode)) ||\n        block.contains(refNode)\n    ) {\n        return;\n    }\n\n    const blockRoot = block.collapseToSingleElement();\n    const commonContainer = collapse(\n        region.rootNode,\n        blockRoot,\n        refNode,\n        false /*isStart*/,\n        true /*canSplitParent*/\n    );\n\n    // Copy styles of parent nodes into blockRoot\n    for (let node: Node | null = blockRoot; contains(commonContainer, node); ) {\n        const parent: Node | null = node!.parentNode;\n        if (safeInstanceOf(parent, 'HTMLElement')) {\n            const styles = {\n                ...(getPredefinedCssForElement(parent) || {}),\n                ...getStyles(parent),\n                ...getStyles(blockRoot),\n            };\n            setStyles(blockRoot, styles);\n        }\n        node = parent;\n    }\n\n    let nodeToRemove: Node | null = null;\n    const nodeToMerge =\n        blockRoot.childNodes.length == 1 && blockRoot.attributes.length == 0\n            ? blockRoot.firstChild!\n            : changeElementTag(blockRoot, 'SPAN')!;\n\n    // Remove empty node\n    for (\n        let node: Node | null = nodeToMerge;\n        contains(commonContainer, node) && node.parentNode?.childNodes.length == 1;\n        node = node!.parentNode\n    ) {\n        // If the only child is the one which is about to be removed, this node should also be removed\n        nodeToRemove = node.parentNode;\n    }\n\n    // Finally, merge blocks, and remove empty nodes\n    refNode.parentNode?.insertBefore(nodeToMerge, refNode.nextSibling);\n    nodeToRemove?.parentNode?.removeChild(nodeToRemove);\n}\n"]}