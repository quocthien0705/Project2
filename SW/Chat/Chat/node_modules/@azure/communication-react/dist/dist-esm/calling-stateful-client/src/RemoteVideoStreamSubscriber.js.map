{"version":3,"file":"RemoteVideoStreamSubscriber.js","sourceRoot":"","sources":["../../../../preprocess-dist/calling-stateful-client/src/RemoteVideoStreamSubscriber.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\n\nimport { RemoteVideoStream } from '@azure/communication-calling';\nimport { RemoteVideoStreamState } from './CallClientState';\nimport { CallContext } from './CallContext';\nimport { CallIdRef } from './CallIdRef';\n\n/**\n * @private\n */\nexport class RemoteVideoStreamSubscriber {\n  private _callIdRef: CallIdRef;\n  private _participantKey: string;\n  private _remoteVideoStream: RemoteVideoStream;\n  private _context: CallContext;\n  constructor(callIdRef: CallIdRef, participantKey: string, remoteVideoStream: RemoteVideoStream, context: CallContext) {\n    this._callIdRef = callIdRef;\n    this._participantKey = participantKey;\n    this._remoteVideoStream = remoteVideoStream;\n    this._context = context;\n    this.subscribe();\n  }\n  private subscribe = (): void => {\n    this._remoteVideoStream.on('isAvailableChanged', this.isAvailableChanged);\n    this._remoteVideoStream.on('sizeChanged', this.isSizeChanged);\n    this.checkAndUpdateScreenShareState();\n  };\n  public unsubscribe = (): void => {\n    this._remoteVideoStream.off('isAvailableChanged', this.isAvailableChanged);\n    this._remoteVideoStream.off('sizeChanged', this.isSizeChanged);\n  };\n  private includesActiveScreenShareStream = (streams: {\n    [key: number]: RemoteVideoStreamState;\n  }): boolean => {\n    for (const stream of Object.values(streams)) {\n      if (stream.mediaStreamType === 'ScreenSharing' && stream.isAvailable) {\n        return true;\n      }\n    }\n    return false;\n  };\n\n  /**\n   * Update the state with the active screen share stream. If there is an existing stream will overwrite it if this one\n   * is active (newer stream takes priority). If there is an existing stream and this one is set to unavailable, and the\n   * existing stream is different participant, then don't set the active screen share stream to undefined, else set it\n   * to undefined.\n   */\n  private checkAndUpdateScreenShareState = (): void => {\n    if (this._remoteVideoStream.mediaStreamType !== 'ScreenSharing') {\n      return;\n    }\n    if (this._remoteVideoStream.isAvailable) {\n      this._context.setCallScreenShareParticipant(this._callIdRef.callId, this._participantKey);\n      return;\n    }\n    const existingScreenShare = this._context.getState().calls[this._callIdRef.callId]?.screenShareRemoteParticipant;\n\n    // If somehow we end up with an event where a RemoteParticipant's ScreenShare stream is set to\n    // unavailable but there exists already another different participant actively sharing, and they are still\n    // sharing then this event shouldn't set the screenShareRemoteParticipant to undefined.\n    if (!existingScreenShare || existingScreenShare === this._participantKey) {\n      this._context.setCallScreenShareParticipant(this._callIdRef.callId, undefined);\n      return;\n    }\n    const streams = this._context.getState().calls[this._callIdRef.callId]?.remoteParticipants[existingScreenShare]?.videoStreams;\n    if (!streams) {\n      this._context.setCallScreenShareParticipant(this._callIdRef.callId, undefined);\n      return;\n    }\n\n    // If the existing ScreenShare that is not owned by the current RemoteParticipant is still active, don't\n    // overwrite it with undefined. So only overwrite if it is not active.\n    if (!this.includesActiveScreenShareStream(streams)) {\n      this._context.setCallScreenShareParticipant(this._callIdRef.callId, undefined);\n      return;\n    }\n  };\n  private isAvailableChanged = (): void => {\n    this._context.setRemoteVideoStreamIsAvailable(this._callIdRef.callId, this._participantKey, this._remoteVideoStream.id, this._remoteVideoStream.isAvailable);\n    this.checkAndUpdateScreenShareState();\n  };\n  private isSizeChanged = (): void => {\n    if (this._remoteVideoStream?.size.width === 0 && this._remoteVideoStream?.size.height === 0) {\n      return;\n    }\n    const streamSize = this._context.getState().calls[this._callIdRef.callId]?.remoteParticipants[this._participantKey]?.videoStreams[this._remoteVideoStream.id]?.streamSize;\n    const existingAspectRatio = streamSize ? streamSize.width / streamSize.height : undefined;\n    const newAspectRatio = this._remoteVideoStream?.size.width / this._remoteVideoStream?.size.height;\n    if (!streamSize || existingAspectRatio !== newAspectRatio) {\n      this._context.setRemoteVideoStreamSize(this._callIdRef.callId, this._participantKey, this._remoteVideoStream.id, this._remoteVideoStream.size);\n    }\n  };\n}"]}