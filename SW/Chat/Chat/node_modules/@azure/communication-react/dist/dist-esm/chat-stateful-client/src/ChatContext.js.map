{"version":3,"file":"ChatContext.js","sourceRoot":"","sources":["../../../../preprocess-dist/chat-stateful-client/src/ChatContext.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\n\nimport EventEmitter from 'events';\nimport { enableMapSet, enablePatches, produce, Patch } from 'immer';\nimport { ChatClientState, ChatErrors, ChatThreadClientState, ChatThreadProperties, ChatErrorTarget, ChatError } from './ChatClientState';\nimport { ChatMessageWithStatus } from './types/ChatMessageWithStatus';\nimport { ChatMessageReadReceipt, ChatParticipant } from '@azure/communication-chat';\nimport { CommunicationIdentifierKind, UnknownIdentifierKind } from '@azure/communication-common';\nimport { AzureLogger, createClientLogger, getLogLevel } from '@azure/logger';\nimport { _safeJSONStringify, toFlatCommunicationIdentifier } from '@internal/acs-ui-common';\nimport { Constants } from './Constants';\nimport { TypingIndicatorReceivedEvent } from '@azure/communication-chat';\nimport { chatStatefulLogger } from './Logger';\n/* @conditional-compile-remove(teams-inline-images-and-file-sharing) */\nimport type { CommunicationTokenCredential } from '@azure/communication-common';\n/* @conditional-compile-remove(teams-inline-images-and-file-sharing) */\nimport { ResourceDownloadQueue, fetchImageSource } from './ResourceDownloadQueue';\nenableMapSet();\n// Needed to generate state diff for verbose logging.\nenablePatches();\n\n/**\n * @internal\n */\nexport class ChatContext {\n  private _state: ChatClientState = {\n    userId: ({\n      id: ''\n    } as UnknownIdentifierKind),\n    displayName: '',\n    threads: {},\n    latestErrors: ({} as ChatErrors)\n  };\n  private _batchMode = false;\n  private _logger: AzureLogger;\n  private _emitter: EventEmitter;\n  private typingIndicatorInterval: number | undefined = undefined;\n  /* @conditional-compile-remove(teams-inline-images-and-file-sharing) */\n  private _inlineImageQueue: ResourceDownloadQueue | undefined = undefined;\n  /* @conditional-compile-remove(teams-inline-images-and-file-sharing) */\n  private _fullsizeImageQueue: ResourceDownloadQueue | undefined = undefined;\n  constructor(maxListeners?: number, /* @conditional-compile-remove(teams-inline-images-and-file-sharing) */credential?: CommunicationTokenCredential, /* @conditional-compile-remove(teams-inline-images-and-file-sharing) */endpoint?: string) {\n    this._logger = createClientLogger('communication-react:chat-context');\n    this._emitter = new EventEmitter();\n    /* @conditional-compile-remove(teams-inline-images-and-file-sharing) */\n    if (credential) {\n      this._inlineImageQueue = new ResourceDownloadQueue(this, {\n        credential,\n        endpoint: endpoint ?? ''\n      });\n      this._fullsizeImageQueue = new ResourceDownloadQueue(this, {\n        credential,\n        endpoint: endpoint ?? ''\n      });\n    }\n    if (maxListeners) {\n      this._emitter.setMaxListeners(maxListeners);\n    }\n  }\n  public getState(): ChatClientState {\n    return this._state;\n  }\n  public modifyState(modifier: (draft: ChatClientState) => void): void {\n    const priorState = this._state;\n    this._state = produce(this._state, modifier, (patches: Patch[]) => {\n      if (getLogLevel() === 'verbose') {\n        // Log to `info` because AzureLogger.verbose() doesn't show up in console.\n        this._logger.info(`State change: ${_safeJSONStringify(patches)}`);\n      }\n    });\n    if (!this._batchMode && this._state !== priorState) {\n      this._emitter.emit('stateChanged', this._state);\n    }\n  }\n\n  /* @conditional-compile-remove(teams-inline-images-and-file-sharing) */\n  public dispose(): void {\n    this.modifyState((draft: ChatClientState) => {\n      this._inlineImageQueue?.cancelAllRequests();\n      this._fullsizeImageQueue?.cancelAllRequests();\n      Object.keys(draft.threads).forEach(threadId => {\n        const thread = draft.threads[threadId];\n        Object.keys(thread.chatMessages).forEach(messageId => {\n          const cache = thread.chatMessages[messageId].resourceCache;\n          if (cache) {\n            Object.keys(cache).forEach(resourceUrl => {\n              const resource = cache[resourceUrl];\n              if (resource.sourceUrl) {\n                URL.revokeObjectURL(resource.sourceUrl);\n              }\n            });\n          }\n          thread.chatMessages[messageId].resourceCache = undefined;\n        });\n      });\n    });\n    // Any item in queue should be removed.\n  }\n  /* @conditional-compile-remove(teams-inline-images-and-file-sharing) */\n  public async downloadResourceToCache(threadId: string, messageId: string, resourceUrl: string): Promise<void> {\n    let message = this.getState().threads[threadId]?.chatMessages[messageId];\n    if (message && this._fullsizeImageQueue) {\n      if (!message.resourceCache) {\n        message = {\n          ...message,\n          resourceCache: {}\n        };\n      }\n      // Need to discuss retry logic in case of failure\n      this._fullsizeImageQueue.addMessage(message);\n      await this._fullsizeImageQueue.startQueue(threadId, fetchImageSource, {\n        singleUrl: resourceUrl\n      });\n    }\n  }\n  /* @conditional-compile-remove(teams-inline-images-and-file-sharing) */\n  public removeResourceFromCache(threadId: string, messageId: string, resourceUrl: string): void {\n    this.modifyState((draft: ChatClientState) => {\n      const message = draft.threads[threadId]?.chatMessages[messageId];\n      if (message && this._fullsizeImageQueue && this._fullsizeImageQueue.containsMessageWithSameAttachments(message)) {\n        this._fullsizeImageQueue?.cancelRequest(resourceUrl);\n      } else if (message && this._inlineImageQueue && this._inlineImageQueue.containsMessageWithSameAttachments(message)) {\n        this._inlineImageQueue?.cancelRequest(resourceUrl);\n      }\n      if (message && message.resourceCache && message.resourceCache[resourceUrl]) {\n        const resource = message.resourceCache[resourceUrl];\n        if (resource.sourceUrl) {\n          URL.revokeObjectURL(resource.sourceUrl);\n        }\n        delete message.resourceCache[resourceUrl];\n      }\n    });\n  }\n  public setThread(threadId: string, threadState: ChatThreadClientState): void {\n    this.modifyState((draft: ChatClientState) => {\n      draft.threads[threadId] = threadState;\n    });\n  }\n  public createThread(threadId: string, properties?: ChatThreadProperties): void {\n    this.modifyState((draft: ChatClientState) => {\n      draft.threads[threadId] = {\n        chatMessages: {},\n        threadId: threadId,\n        properties: properties,\n        participants: {},\n        readReceipts: [],\n        typingIndicators: [],\n        latestReadTime: new Date(0)\n      };\n    });\n  }\n  public updateChatConfig(userId: CommunicationIdentifierKind, displayName: string): void {\n    this.modifyState((draft: ChatClientState) => {\n      draft.displayName = displayName;\n      draft.userId = userId;\n    });\n  }\n  public createThreadIfNotExist(threadId: string, properties?: ChatThreadProperties): boolean {\n    const exists = Object.prototype.hasOwnProperty.call(this.getState().threads, threadId);\n    if (!exists) {\n      this.createThread(threadId, properties);\n      return true;\n    }\n    return false;\n  }\n  public updateThread(threadId: string, properties?: ChatThreadProperties): void {\n    this.modifyState((draft: ChatClientState) => {\n      const thread = draft.threads[threadId];\n      if (thread) {\n        thread.properties = properties;\n      }\n    });\n  }\n  public updateThreadTopic(threadId: string, topic?: string): void {\n    this.modifyState((draft: ChatClientState) => {\n      if (topic === undefined) {\n        return;\n      }\n      const thread = draft.threads[threadId];\n      if (thread && !thread.properties) {\n        thread.properties = {\n          topic: topic\n        };\n      } else if (thread && thread.properties) {\n        thread.properties.topic = topic;\n      }\n    });\n  }\n  public deleteThread(threadId: string): void {\n    this.modifyState((draft: ChatClientState) => {\n      const thread = draft.threads[threadId];\n      if (thread) {\n        delete draft.threads[threadId];\n      }\n    });\n  }\n  public setChatMessages(threadId: string, messages: {\n    [key: string]: ChatMessageWithStatus;\n  }): void {\n    this.modifyState((draft: ChatClientState) => {\n      const threadState = draft.threads[threadId];\n      if (threadState) {\n        threadState.chatMessages = messages;\n      }\n\n      // remove typing indicator when receive messages\n      const thread = draft.threads[threadId];\n      if (thread) {\n        for (const message of Object.values(messages)) {\n          this.filterTypingIndicatorForUser(thread, message.sender);\n        }\n      }\n    });\n  }\n  public updateChatMessageContent(threadId: string, messagesId: string, content: string | undefined): void {\n    this.modifyState((draft: ChatClientState) => {\n      const chatMessage = draft.threads[threadId]?.chatMessages[messagesId];\n      if (chatMessage) {\n        if (!chatMessage.content) {\n          chatMessage.content = {};\n        }\n        chatMessage.content.message = content;\n      }\n    });\n  }\n  public deleteLocalMessage(threadId: string, localId: string): boolean {\n    let localMessageDeleted = false;\n    this.modifyState((draft: ChatClientState) => {\n      const chatMessages = draft.threads[threadId]?.chatMessages;\n      const message: ChatMessageWithStatus | undefined = chatMessages ? chatMessages[localId] : undefined;\n      if (chatMessages && message && message.clientMessageId) {\n        delete chatMessages[message.clientMessageId];\n        localMessageDeleted = true;\n      }\n    });\n    return localMessageDeleted;\n  }\n  public deleteMessage(threadId: string, id: string): void {\n    this.modifyState((draft: ChatClientState) => {\n      const chatMessages = draft.threads[threadId]?.chatMessages;\n      if (chatMessages) {\n        delete chatMessages[id];\n      }\n    });\n  }\n  public setParticipant(threadId: string, participant: ChatParticipant): void {\n    this.modifyState((draft: ChatClientState) => {\n      const participants = draft.threads[threadId]?.participants;\n      if (participants) {\n        participants[toFlatCommunicationIdentifier(participant.id)] = participant;\n      }\n    });\n  }\n  public setParticipants(threadId: string, participants: ChatParticipant[]): void {\n    this.modifyState((draft: ChatClientState) => {\n      const participantsMap = draft.threads[threadId]?.participants;\n      if (participantsMap) {\n        for (const participant of participants) {\n          participantsMap[toFlatCommunicationIdentifier(participant.id)] = participant;\n        }\n      }\n    });\n  }\n  public deleteParticipants(threadId: string, participantIds: CommunicationIdentifierKind[]): void {\n    this.modifyState((draft: ChatClientState) => {\n      const participants = draft.threads[threadId]?.participants;\n      if (participants) {\n        participantIds.forEach(id => {\n          delete participants[toFlatCommunicationIdentifier(id)];\n        });\n      }\n    });\n  }\n  public deleteParticipant(threadId: string, participantId: CommunicationIdentifierKind): void {\n    this.modifyState((draft: ChatClientState) => {\n      const participants = draft.threads[threadId]?.participants;\n      if (participants) {\n        delete participants[toFlatCommunicationIdentifier(participantId)];\n      }\n    });\n  }\n  public addReadReceipt(threadId: string, readReceipt: ChatMessageReadReceipt): void {\n    this.modifyState((draft: ChatClientState) => {\n      const thread = draft.threads[threadId];\n      const readReceipts = thread?.readReceipts;\n      if (thread && readReceipts) {\n        // TODO(prprabhu): Replace `this.getState()` with `draft`?\n        if (readReceipt.sender !== this.getState().userId && thread.latestReadTime < readReceipt.readOn) {\n          thread.latestReadTime = readReceipt.readOn;\n        }\n        readReceipts.push(readReceipt);\n      }\n    });\n  }\n  private startTypingIndicatorCleanUp(): void {\n    if (this.typingIndicatorInterval) {\n      return;\n    }\n    this.typingIndicatorInterval = window.setInterval(() => {\n      let isTypingActive = false;\n      this.modifyState((draft: ChatClientState) => {\n        for (const thread of Object.values(draft.threads)) {\n          const filteredTypingIndicators = thread.typingIndicators.filter(typingIndicator => {\n            const timeGap = Date.now() - typingIndicator.receivedOn.getTime();\n            return timeGap < Constants.TYPING_INDICATOR_MAINTAIN_TIME;\n          });\n          if (thread.typingIndicators.length !== filteredTypingIndicators.length) {\n            thread.typingIndicators = filteredTypingIndicators;\n          }\n          if (thread.typingIndicators.length > 0) {\n            isTypingActive = true;\n          }\n        }\n      });\n      if (!isTypingActive && this.typingIndicatorInterval) {\n        window.clearInterval(this.typingIndicatorInterval);\n        this.typingIndicatorInterval = undefined;\n      }\n    }, 1000);\n  }\n  public addTypingIndicator(threadId: string, typingIndicator: TypingIndicatorReceivedEvent): void {\n    this.modifyState((draft: ChatClientState) => {\n      const thread = draft.threads[threadId];\n      if (thread) {\n        const typingIndicators = thread.typingIndicators;\n        typingIndicators.push(typingIndicator);\n      }\n    });\n\n    // Make sure we only maintain a period of typing indicator for perf purposes\n    this.startTypingIndicatorCleanUp();\n  }\n  public setChatMessage(threadId: string, message: ChatMessageWithStatus): void {\n    /* @conditional-compile-remove(teams-inline-images-and-file-sharing) */\n    this.parseAttachments(threadId, message);\n    const {\n      id: messageId,\n      clientMessageId\n    } = message;\n    if (messageId || clientMessageId) {\n      this.modifyState((draft: ChatClientState) => {\n        const threadMessages = draft.threads[threadId]?.chatMessages;\n        const isLocalIdInMap = threadMessages && clientMessageId && threadMessages[clientMessageId];\n        const messageKey = !messageId || isLocalIdInMap ? clientMessageId : messageId;\n        if (threadMessages && messageKey) {\n          threadMessages[messageKey] = message;\n        }\n\n        // remove typing indicator when receive a message from a user\n        const thread = draft.threads[threadId];\n        if (thread) {\n          this.filterTypingIndicatorForUser(thread, message.sender);\n        }\n      });\n    }\n  }\n\n  /* @conditional-compile-remove(teams-inline-images-and-file-sharing) */\n  private parseAttachments(threadId: string, message: ChatMessageWithStatus): void {\n    const attachments = message.content?.attachments;\n    if (message.type === 'html' && attachments && attachments.length > 0) {\n      if (this._inlineImageQueue && !this._inlineImageQueue.containsMessageWithSameAttachments(message) && message.resourceCache === undefined) {\n        // Need to discuss retry logic in case of failure\n        this._inlineImageQueue.addMessage(message);\n        this._inlineImageQueue.startQueue(threadId, fetchImageSource);\n      }\n    }\n  }\n\n  /**\n   * Tees any errors encountered in an async function to the state.\n   *\n   * @param f Async function to execute.\n   * @param target The error target to tee error to.\n   * @returns Result of calling `f`. Also re-raises any exceptions thrown from `f`.\n   * @throws ChatError. Exceptions thrown from `f` are tagged with the failed `target.\n   */\n  public withAsyncErrorTeedToState<Args extends unknown[], R>(f: (...args: Args) => Promise<R>, target: ChatErrorTarget): (...args: Args) => Promise<R> {\n    return async (...args: Args): Promise<R> => {\n      try {\n        return await f(...args);\n      } catch (error) {\n        const chatError = toChatError(target, error);\n        this.setLatestError(target, chatError);\n        throw chatError;\n      }\n    };\n  }\n\n  /**\n   * Tees any errors encountered in an function to the state.\n   *\n   * @param f Function to execute.\n   * @param target The error target to tee error to.\n   * @returns Result of calling `f`. Also re-raises any exceptions thrown from `f`.\n   * @throws ChatError. Exceptions thrown from `f` are tagged with the failed `target.\n   */\n  public withErrorTeedToState<Args extends unknown[], R>(f: (...args: Args) => R, target: ChatErrorTarget): (...args: Args) => R {\n    return (...args: Args): R => {\n      try {\n        chatStatefulLogger.info(`Chat stateful client target function called: ${target}`);\n        return f(...args);\n      } catch (error) {\n        const chatError = toChatError(target, error);\n        this.setLatestError(target, chatError);\n        throw chatError;\n      }\n    };\n  }\n  private setLatestError(target: ChatErrorTarget, error: ChatError): void {\n    this.modifyState((draft: ChatClientState) => {\n      draft.latestErrors[target] = error;\n    });\n  }\n\n  // This is a mutating function, only use it inside of a produce() function\n  private filterTypingIndicatorForUser(thread: ChatThreadClientState, userId?: CommunicationIdentifierKind): void {\n    if (!userId) {\n      return;\n    }\n    const typingIndicators = thread.typingIndicators;\n    const userIdAsKey = toFlatCommunicationIdentifier(userId);\n    const filteredTypingIndicators = typingIndicators.filter(typingIndicator => toFlatCommunicationIdentifier(typingIndicator.sender) !== userIdAsKey);\n    if (filteredTypingIndicators.length !== typingIndicators.length) {\n      thread.typingIndicators = filteredTypingIndicators;\n    }\n  }\n\n  /**\n   * Batch updates to minimize `stateChanged` events across related operations.\n   *\n   * - A maximum of one `stateChanged` event is emitted, at the end of the operations.\n   * - No `stateChanged` event is emitted if the state did not change through the operations.\n   * - In case of an exception, state is reset to the prior value and no `stateChanged` event is emitted.\n   *\n   * All operations finished in this batch should be synchronous.\n   * This function is not reentrant -- do not call batch() from within another batch().\n   */\n  public batch(operations: () => void): void {\n    if (this._batchMode) {\n      throw new Error('batch() called from within another batch()');\n    }\n    this._batchMode = true;\n    const priorState = this._state;\n    try {\n      operations();\n      if (this._state !== priorState) {\n        this._emitter.emit('stateChanged', this._state);\n      }\n    } catch (e) {\n      this._state = priorState;\n      if (getLogLevel() === 'verbose') {\n        this._logger.warning(`State rollback to: ${_safeJSONStringify(priorState)}`);\n      }\n      throw e;\n    } finally {\n      this._batchMode = false;\n    }\n  }\n  public onStateChange(handler: (state: ChatClientState) => void): void {\n    this._emitter.on('stateChanged', handler);\n  }\n  public offStateChange(handler: (state: ChatClientState) => void): void {\n    this._emitter.off('stateChanged', handler);\n  }\n}\nconst toChatError = (target: ChatErrorTarget, error: unknown): ChatError => {\n  if (error instanceof Error) {\n    return new ChatError(target, error);\n  }\n  return new ChatError(target, new Error(`${error}`));\n};"]}