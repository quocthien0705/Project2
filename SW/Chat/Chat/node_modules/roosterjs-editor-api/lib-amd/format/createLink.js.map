{"version":3,"file":"createLink.js","sourceRoot":"","sources":["../../../../packages/roosterjs-editor-api/lib/format/createLink.ts"],"names":[],"mappings":"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","sourcesContent":["import { HtmlSanitizer, matchLink, wrap } from 'roosterjs-editor-dom';\r\nimport type { IEditor } from 'roosterjs-editor-types';\r\nimport {\r\n    ChangeSource,\r\n    DocumentCommand,\r\n    QueryScope,\r\n    SelectionRangeTypes,\r\n} from 'roosterjs-editor-types';\r\n\r\n// Regex matching Uri scheme\r\nconst URI_REGEX = /^[a-zA-Z]+:/i;\r\n// Regex matching begin of email address\r\nconst MAILTO_REGEX = /^[\\w.%+-]+@/i;\r\n// Regex matching begin of ftp, i.e. ftp.microsoft.com\r\nconst FTP_REGEX = /^ftp\\./i;\r\n\r\nfunction applyLinkPrefix(url: string): string {\r\n    if (!url) {\r\n        return url;\r\n    }\r\n\r\n    // Add link prefix per rule:\r\n    // (a) if the url always starts with a URI scheme, leave it as it is\r\n    // (b) if the url is an email address, xxx@... add mailto: prefix\r\n    // (c) if the url starts with ftp., add ftp:// prefix\r\n    // (d) rest, add http:// prefix\r\n    let prefix = '';\r\n    if (url.search(URI_REGEX) < 0) {\r\n        if (url.search(MAILTO_REGEX) == 0) {\r\n            prefix = 'mailto:';\r\n        } else if (url.search(FTP_REGEX) == 0) {\r\n            prefix = 'ftp://';\r\n        } else {\r\n            // fallback to http://\r\n            prefix = 'http://';\r\n        }\r\n    }\r\n\r\n    return prefix + url;\r\n}\r\n\r\n/**\r\n * Insert a hyperlink at cursor.\r\n * When there is a selection, hyperlink will be applied to the selection,\r\n * otherwise a hyperlink will be inserted to the cursor position.\r\n * @param editor Editor object\r\n * @param link Link address, can be http(s), mailto, notes, file, unc, ftp, news, telnet, gopher, wais.\r\n * When protocol is not specified, a best matched protocol will be predicted.\r\n * @param altText Optional alt text of the link, will be shown when hover on the link\r\n * @param displayText Optional display text for the link.\r\n * @param target Optional display target for the link (\"_blank\"|\"_self\"|\"_parent\"|\"_top\"|\"{framename}\")\r\n * If specified, the display text of link will be replaced with this text.\r\n * If not specified and there wasn't a link, the link url will be used as display text.\r\n */\r\nexport default function createLink(\r\n    editor: IEditor,\r\n    link: string,\r\n    altText?: string,\r\n    displayText?: string,\r\n    target?: string\r\n) {\r\n    editor.focus();\r\n    const url = (checkXss(link) || '').trim();\r\n    if (url) {\r\n        const linkData = matchLink(url);\r\n        // matchLink can match most links, but not all, i.e. if you pass link a link as \"abc\", it won't match\r\n        // we know in that case, users will want to insert a link like http://abc\r\n        // so we have separate logic in applyLinkPrefix to add link prefix depending on the format of the link\r\n        // i.e. if the link starts with something like abc@xxx, we will add mailto: prefix\r\n        // if the link starts with ftp.xxx, we will add ftp:// link. For more, see applyLinkPrefix\r\n        const normalizedUrl = linkData ? linkData.normalizedUrl : applyLinkPrefix(url);\r\n        const originalUrl = linkData ? linkData.originalUrl : url;\r\n\r\n        editor.addUndoSnapshot(() => {\r\n            const selection = editor.getSelectionRangeEx();\r\n            let anchor: HTMLAnchorElement | null = null;\r\n            if (selection.type === SelectionRangeTypes.Normal) {\r\n                const range = selection.ranges[0];\r\n                if (range && range.collapsed) {\r\n                    anchor = getAnchorNodeAtCursor(editor);\r\n\r\n                    // If there is already a link, just change its href\r\n                    if (anchor) {\r\n                        anchor.href = normalizedUrl;\r\n                        // Change text content if it is specified\r\n                        updateAnchorDisplayText(anchor, displayText);\r\n                    } else {\r\n                        anchor = editor.getDocument().createElement('A') as HTMLAnchorElement;\r\n                        anchor.textContent = displayText || originalUrl;\r\n                        anchor.href = normalizedUrl;\r\n                        editor.insertNode(anchor);\r\n                    }\r\n                } else {\r\n                    // the selection is not collapsed, use browser execCommand\r\n                    editor\r\n                        .getDocument()\r\n                        .execCommand(DocumentCommand.CreateLink, false, normalizedUrl);\r\n                    const traverser = editor.getSelectionTraverser();\r\n\r\n                    let currentInline = traverser?.getNextInlineElement();\r\n\r\n                    // list for removing unwanted lines\r\n                    const deletionInlineList: Node[] = [];\r\n\r\n                    while (currentInline) {\r\n                        deletionInlineList.push(currentInline.getContainerNode());\r\n                        currentInline = traverser?.getNextInlineElement();\r\n                    }\r\n\r\n                    deletionInlineList.forEach(node => editor.deleteNode(node));\r\n\r\n                    anchor = getAnchorNodeAtCursor(editor);\r\n                    updateAnchorDisplayText(anchor, displayText);\r\n                }\r\n            } else if (selection.type === SelectionRangeTypes.ImageSelection) {\r\n                anchor = wrap(selection.image, 'A') as HTMLAnchorElement;\r\n                anchor.href = normalizedUrl;\r\n            }\r\n\r\n            if (altText && anchor) {\r\n                anchor.title = altText;\r\n            }\r\n            if (anchor) {\r\n                updateAnchorTarget(anchor, target);\r\n            }\r\n            return anchor;\r\n        }, ChangeSource.CreateLink);\r\n    }\r\n}\r\n\r\nfunction getAnchorNodeAtCursor(editor: IEditor): HTMLAnchorElement {\r\n    return editor.queryElements('a[href]', QueryScope.OnSelection)[0] as HTMLAnchorElement;\r\n}\r\n\r\nfunction updateAnchorDisplayText(anchor: HTMLAnchorElement, displayText?: string) {\r\n    if (displayText && anchor.textContent != displayText) {\r\n        anchor.textContent = displayText;\r\n    }\r\n}\r\n\r\nfunction updateAnchorTarget(anchor: HTMLAnchorElement, target?: string) {\r\n    if (target) {\r\n        anchor.target = target;\r\n    } else if (!target && anchor.getAttribute('target')) {\r\n        anchor.removeAttribute('target');\r\n    }\r\n}\r\n\r\nfunction checkXss(link: string): string | null {\r\n    const sanitizer = new HtmlSanitizer();\r\n    const a = document.createElement('a');\r\n\r\n    a.href = link || '';\r\n    sanitizer.sanitize(a);\r\n    // We use getAttribute because some browsers will try to make the href property a valid link.\r\n    // This has unintended side effects when the link lacks a protocol.\r\n    return a.getAttribute('href');\r\n}\r\n"]}